<!DOCTYPE html>
<!-- saved from url=(0128)file:///Users/fuadtaher/Desktop/untitled%20folder%202/NEW22_9_2025_ENBD%20Performance%20Tracker%20%E2%80%94%20Single%20File.html -->
<html lang="en"><head><meta charset="utf-8">

<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ENBD Performance Tracker ‚Äî Single File</title>
<!-- Local file:// stylesheet commented out to avoid invalid URL warnings in other environments -->
<!-- <link href="file:///Users/fuadtaher/Desktop/New%20Tracker/NEWENDBTRACKER_files/css2" rel="stylesheet"> -->
<style>
/* === CSS Variables === */
:root{
    --bg:#0d1117;      /* professional dark blue-gray */
    --card:#161b22;    /* darker card background */
    --muted:#8b949e;   /* muted gray labels */
    --text:#f0f6fc;    /* light text */
    --accent:#58a6ff;  /* professional blue accent */
  --danger:#f85149;  /* red for negatives */
  --gold:#d29922;    /* gold */
  --accent-amber: #ffb84d; /* distinct amber for scenario helper notes */
    --line:rgba(255,255,255,0.1);
  --kpi-mo-needed-offset: -3.88cm; /* tweak this to nudge Mo. Needed horizontally */
  }
  .light-theme {
    --bg:#f6f8fa;      /* light gray background */
    --card:#ffffff;    /* white cards */
    --muted:#656d76;   /* dark muted */
    --text:#24292f;    /* dark text */
    --accent:#0969da;  /* blue accent */
    --danger:#da3633;  /* red danger */
    --gold:#bf8700;    /* gold */
    --line:rgba(0,0,0,0.15);
  }
  /* === Base Styles === */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--text);
    background: var(--bg);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    font-size:14px;
    line-height:1.5;
  }
  /* === Layout === */
  .wrap{
    max-width:1100px;
  margin:0 auto;
  padding:24px 20px 36px;
  }
  /* Title centered */
  .titlebar{
    position:sticky; top:0; z-index:50;
    background:transparent; 
    border-bottom:1px solid rgba(255,255,255,0.03);
  }
  .titlebar-inner{
    display:grid; grid-template-columns:auto auto; align-items:center;
    gap:12px; padding:12px 20px;
  }
  h1{margin:0; text-align:center; font-weight:600; letter-spacing:.1px; font-size:16px;}
    /* Preset A: modern sans styling for primary UI elements */
    .ui-sans{ font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; font-weight:600; letter-spacing:.2px; }
    .card header, .kpi h3, .btn, .pill, .owner-year select, h1 { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; font-weight:600; letter-spacing:.2px; }
  .toolbar-right{justify-self:end; display:flex; gap:8px; align-items:center;}
  /* shrink toolbar controls by 5% for a slightly smaller appearance */
  .titlebar-inner .toolbar-right,
  .titlebar-inner .toolbar-right .btn { transform-origin: top right; transform: scale(0.95); }
  /* === Components === */
  .btn{
    display:inline-flex; align-items:center; gap:6.3px;
    border:1px solid rgba(255,140,0,0.35); background: linear-gradient(135deg, rgba(15,23,48,0.85), rgba(255,255,255,0.03));
    color:var(--text); border-radius:10.5px; padding:6.3px 8.4px; cursor:pointer;
    font-weight:600; font-size:13.65px; box-shadow: 0 1px 6px rgba(0,0,0,0.08); transition: all 0.18s ease;
  -webkit-backdrop-filter: blur(3px); backdrop-filter: blur(3px);
  }
  .btn:hover{border-color:rgba(255,255,255,0.18); background: linear-gradient(135deg, rgba(18,29,58,0.9), rgba(255,255,255,0.04)); box-shadow: 0 3px 10px rgba(0,0,0,0.12);}
  .btn.round{border-radius:999px; padding:8.4px 10.5px;}
  /* compact toolbar utility: apply .toolbar-compact on .titlebar-inner to shrink spacing further */
  .toolbar-compact .toolbar-right{gap:6px}
  .toolbar-compact .btn{padding:5px 7px; font-size:12px; gap:6px}
  .btn .ico{font-size:16.8px}
  .grid{display:grid; gap:20px}
  /* reduce vertical gap between table and the area below it for a tighter layout */
  .grid.row2{ gap:8px }
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:8px;
    padding:16px;
  }
  .owner-card {
    background: linear-gradient(135deg, var(--card) 0%, rgba(106, 163, 163, 0.05) 100%);
    border: 2px solid rgba(106, 163, 163, 0.2);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    position: relative;
  }
  .owner-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--line);
  }
  .lock-icon {
    font-size: 18px;
    opacity: 0.8;
  }
  .row2{grid-template-columns:1fr 1fr}
  .row3{grid-template-columns:repeat(3,1fr)}
  .muted{color:var(--muted)}
  .gold{color:var(--gold)}
  /* Emphasize the Year Data label with a brighter gold */
  #yearDataLabel{ color:var(--accent); margin-left:0; font-size:24px; font-weight:bold; white-space:nowrap; display:inline-block; text-align:center; width:100%; position:relative; top:0; left:0; }
  .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
  /* use 3 columns for KPI tiles to match requested layout */
  .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:16px}
  /* compact muted KPI cards */
  .kpi{background: linear-gradient(135deg, var(--card), rgba(255,255,255,0.02)); color:var(--text); border:1px solid var(--line); border-radius:12px; padding:6px; display:flex; flex-direction:column; justify-content:center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: box-shadow 0.2s ease;}
  .kpi:hover{box-shadow: 0 4px 12px rgba(0,0,0,0.15);}
  /* allow a KPI to span the full width of the KPI grid */
  .kpi.full{grid-column:1 / -1; padding:12px 14px; font-size:16px}
  .kpi .months-visual{display:flex; flex-direction:column; align-items:center; justify-content:center; margin-left:12px}
  .kpi .months-big{font-size:28px; font-weight:800; color:var(--accent); line-height:1}
  .kpi .months-label{font-size:12px; color:var(--muted)}
  .kpi h3{margin:0 0 6px; font-size:12px; font-weight:600; color:var(--muted); letter-spacing:.3px; text-transform:none}
  .kpi .val{font-size:calc(14px * 1.06 * 1.03); font-weight:700; text-align:center; color:var(--text)}
  /* Slightly reduce values in the 3rd row of KPI grid to balance with upper rows */
  .kpis .kpi:nth-child(n+7) .val{ font-size:calc(14px * 0.92); }
  .kpi.small-note{padding:6px}
  .kpi .val.positive{color:#7bd99f}
  .kpi .val.negative{color:var(--danger)}
  /* Neutral/unbiased color for Total Target KPI (gold to draw attention) */
  .kpi .val.neutral-muted { color: #C9A24A !important }
  /* Attention color for Mo. Needed KPI (softened) */
  .kpi .val.attention { color: #FFB28A !important }

  /* Forecasted Year-End in cyan/teal per user request */
  #kpiForecastYearEnd { color: #33cccc !important; }

  /* Shift the Mo. Needed number slightly left and color it orange */
  #kpiMoNeeded {
    display:inline-block;
  transform: translateX(calc(var(--kpi-mo-needed-offset) + 2mm));
    color: #FF8C42 !important;
  }
  /* Make Avg. Mo. Target KPI yellow */
  #kpiAvgMoTarget { color: #F5D547 !important; text-shadow: 0 1px 0 rgba(0,0,0,0.15); }
  /* YTD Inflow in cyan/teal */
  #kpiInflow { color: #33cccc !important; }
  .small{font-size:12px}
  label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
  /* subtle inline hint text used near compact controls */
  .fineTextInline{ font-size:11px; color:var(--muted); margin-left:8px; white-space:nowrap }
  select,input[type="number"],input[type="text"]{
    width:100%; background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.04);
    border-radius:6px; padding:6px 8px; outline:none;
    font-size:14px;
  }
  /* remove native number input spinner arrows for better manual entry */
  /* Chrome, Edge, Safari */
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  /* Normalize number input appearance across browsers */
  input[type=number] { -moz-appearance: textfield; -webkit-appearance: none; appearance: textfield; }
  table{width:100%; border-collapse:collapse; table-layout:fixed}
  th,td{border:1px solid rgba(255,255,255,0.12); padding:10px; font-size:14px}
  td{ text-align:left }
  /* Month column: header stays centered, body cells left-aligned for readability */
  /* Left-align Month and Day headers for clarity */
  table#monthTable thead th:first-child,
  table#monthTable thead th:nth-child(2) { text-align:left }
  table#monthTable tbody td:first-child { text-align:left; font-weight:700; font-family: 'Georgia', serif; }
  th{background:#262628; color:#c8ccd2; position:static; z-index:1; text-align:center}
  /* Center numeric/accounting columns: Target (3), Bank Inflow (5), Variance (6), Balance (7) */
  table#monthTable td:nth-child(3),
  table#monthTable td:nth-child(5),
  table#monthTable td:nth-child(6),
  table#monthTable td:nth-child(7) { text-align:center }
  /* Center the input text inside Target and Bank Inflow cells for easier data entry */
  table#monthTable td:nth-child(3) input,
  table#monthTable td:nth-child(5) input { text-align:center }
  /* color balances green/red depending on sign */
  table#monthTable td:nth-child(7).positive { color: #7bd99f }
  table#monthTable td:nth-child(7).negative { color: var(--danger) }
  /* Variance (col 6) green/red depending on sign (body only) */
  table#monthTable tbody td:nth-child(6).positive { color: #7bd99f }
  table#monthTable tbody td:nth-child(6).negative { color: var(--danger) }
  /* Target (col 3) body cells: orange identity (do NOT color the header) */
  table#monthTable tbody td:nth-child(3) { color: #f39c12; font-weight:700 }
  table#monthTable tbody td:nth-child(3) input { color: #f39c12; }
  /* Bank Inflow (col 5) body cells: gold identity */
  table#monthTable tbody td:nth-child(5) { color: var(--gold); font-weight:700 }
  table#monthTable tbody td:nth-child(5) input { color: var(--gold); }
  /* Month (col 2) body cells: grass green identity (do NOT color the header) */
  table#monthTable tbody td:nth-child(2) { color: #4caf50; font-weight:700 }
  table#monthTable tbody td:nth-child(2) input { color: #4caf50; }
  /* Day (first column) body cells: use accent blue (do NOT color the header) */
  table#monthTable tbody td:first-child { color: var(--accent); font-weight:700 }
  table#monthTable tbody td:first-child input { color: var(--accent); }
  /* Keep inner lines subtle so outer border stands out - prevents 'leak' */
  .tableCard{border:1px solid var(--line); border-radius:14px; overflow:hidden; grid-column: 1 / -1}
  .tableCard table th,.tableCard table td{border:1px solid rgba(255,255,255,0.12) !important}
  .tableCard .note{padding:10px; color:var(--muted); font-size:12px}
  /* Chart container should span full width under the table to avoid an empty column */
  .chartCard{grid-column:1 / -1}
  .pill{
    display:inline-flex; align-items:center; gap:8px; padding:4px 8px; background:transparent; border:1px solid rgba(255,255,255,0.04); border-radius:999px; font-size:12px;
  }
  .owner-year{display:flex; flex-direction:column; gap:10px; align-items:stretch; position:relative}
  /* Make owner/year controls less prominent (privacy) */
  .owner-year select{background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); color:var(--gold); opacity:1; font-size:15.6px}
  .owner-year select:focus{outline:2px solid rgba(106,163,163,0.14); color:var(--text); opacity:1}
  /* visually hide the Owner/Year label text (keeps label in DOM for screen readers) */
  .owner-year label{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap; border:0}
  .year-data{margin-top:6px; font-weight:700}
  .sidebar{
    position:fixed; left:0; top:calc(80px + 2cm); width:220px; height:calc(100vh - 80px - 2cm); overflow-y:auto; background:var(--card); border-right:1px solid var(--line); z-index:10;
  }
  .wrap{
    margin-left:220px;
  }
  /* Reminders */
  .rem-row{
    display:grid; grid-template-columns:auto auto 1fr auto; gap:12px; align-items:center;
    padding:12px 10px; border-bottom:1px dashed rgba(255,255,255,0.04);
  }
  .rem-row:last-child{border-bottom:none}
  .tiny{
    width:14px; height:14px; accent-color:var(--danger);
  }
  .date-amount{white-space:nowrap}
  /* softer badge for reminders */
  #remBadge{ -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px); background:linear-gradient(135deg, rgba(192,192,192,0.7), rgba(160,160,160,0.5)); color:#ffffff; padding:2px 6px; border-radius:12px; font-weight:700; font-size:14px; min-width:28px; text-align:center; border:none; box-shadow:0 1px 3px rgba(0,0,0,0.04); display:inline-flex; align-items:center; justify-content:center }
  /* larger, clearer badge when showing a check */
  #remBadge.check { background: linear-gradient(135deg, #28a745, #1f8a3e); color: #fff; box-shadow: 0 4px 8px rgba(31,138,62,0.25); }
  #remList .rem-row{padding:10px 6px; align-items:center}
  .rem-actions .iconbtn{background:#2a3a5a; border:1px solid #3a4a6a; color:#fff; padding:6px 8px; font-size:12px; border-radius:6px}
  .rem-label{font-size:13px}
  .rem-row .date-amount{font-weight:600; color:var(--muted)}
  .rem-row .rem-label{color:var(--text); font-size:13px}
  #btnToggleRem{min-width:86px}
  .date-amount.strike{
    text-decoration:line-through;
    text-decoration-thickness:2px;
    text-decoration-color:#ff3030;
    color:#ff6b6b;
  }
  .rem-label{color:var(--text)}
  .rem-label.faded{opacity:.45}
  .rem-actions{display:flex; gap:4px}
  .iconbtn{border:none; background:#17171a; border:1px solid #2a2a30; color:var(--text); padding:6px 8px; border-radius:10px; cursor:pointer; font-size:12px}
  .iconbtn:hover{background:#1f1f22}
  .danger{color:#ff7b7b;border-color:#3a1f25;background:#1a0f12}
  /* Share Monthly Plan popup */
  .overlay{position:fixed; inset:0; background:rgba(27,27,31,0.62); display:none; align-items:center; justify-content:center; z-index:120}
  .overlay.show{display:flex}
  .pop{
    width:min(1000px,98vw); max-height:95vh; overflow:auto; background:#1b1b1f; border:1px solid #2a2a30; border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5);
  }
  .pop header{display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid #2a2a30}
  .pop header h3{margin:0; font-size:20px; color: #33cccc; font-weight:700}

  /* Specific larger title for the Deposit required share popup */
  #shareTitle { font-size:24px !important; font-weight:800; color: #33cccc; }
  .pop .content{ padding:18px; font-size:15px; }
  /* Required field label styling (less harsh than red) */
  .required-label{ color:#F5D547; font-weight:600 }
  /* Highlight share recipient placeholder in red to draw attention */
  #shareRecipient::placeholder{ color:#ff6b6b; font-weight:700; opacity:1 }
  .sharegrid{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:10px}
  .sharegrid .sbtn{border:1px solid #2a2a30; background:#17171a; padding:10.5px; border-radius:12.6px; font-size:12.6px; font-weight:700; text-align:center; cursor:pointer}
  .sharegrid .sbtn:hover{background:#1f1f22}
  .textarea{
    width:100%; background:#141416; border:1px solid #2a2a30; color:var(--text); border-radius:10px; padding:10px; min-height:200px; resize:vertical; line-height:1.6;
  }
  .pop footer{display:flex; justify-content:flex-end; gap:8px; padding:14px 18px; border-top:1px solid #2a2a30}
  .close{background:#1c1c20; border:1px solid #2a2a30}
  .hidden{display:none}
  .hint{font-size:13px; color:#a4b7cf}

  /* Notes drawer (slide-out) */
  .notes-drawer{ position:fixed; left:-680px; top:8mm; width:640px; height:75vh; background:#1b1b1f; border:1px solid rgba(255,255,255,0.02); border-radius:12px; box-shadow:0 30px 60px rgba(0,0,0,0.6); transition:left 260ms ease-in-out; z-index:135; overflow:auto; }
  .notes-drawer.open{ left:calc(240px - 7mm) }
  .notes-drawer-inner{ padding:16px; font-size:13px }
  /* Make the notes textarea occupy most of the drawer height */
  #notesArea{ min-height: calc(75vh - 160px); max-height: calc(75vh - 120px); height: calc(75vh - 160px); resize:vertical; }
  #btnToggleNotes{ margin-left:0; }
  /* Visual highlight for reminders to make them easy to see */
  .reminders-highlight{ border:1px solid rgba(255,140,66,0.04); box-shadow:0 4px 10px rgba(0,0,0,0.04); border-radius:10px }
  /* Slide-out reminders drawer */
  .rem-drawer h3{ color:#33cccc; /* cyan/teal for reminder headers */ }
  .rem-drawer{ position:fixed; right:-520px; top:60px; width:520px; max-width:calc(100vw - 40px); height:72vh; min-height:360px; background:#1b1b1f; border:1px solid rgba(255,255,255,0.02); border-radius:12px; box-shadow:0 40px 80px rgba(0,0,0,0.6); transition: right 220ms cubic-bezier(.2,.9,.3,1), transform 220ms ease; z-index:13000; overflow:auto }
  .rem-drawer.open{ right:18px; transform:translateX(0); }
  .rem-drawer-inner{ padding:18px; font-size:13px }
  @media (max-width:720px){ .rem-drawer{ width:92vw; right:-100vw; left:4vw; top:60px; max-width:92vw; height:78vh; } .rem-drawer.open{ left:4vw; right:auto; } }
  #btnOpenRem{ font-weight:700 }

  /* Ultra-sleek glassmorphism reminder floating pill ‚Äî minimal and elegant */
  .rem-pill{ position:fixed; right:18px; bottom:calc(150px + 2mm + 1.2cm); z-index:140; background:linear-gradient(135deg, rgba(255,187,140,0.06), rgba(255,170,120,0.04)); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px); color:#FFB78C; border:1px solid rgba(255,160,110,0.08); box-shadow:0 1px 6px rgba(0,0,0,0.04); font-size:12px; padding:2px 6px; border-radius:9px; display:inline-flex; align-items:center; gap:6px; transition:transform 150ms ease, box-shadow 150ms ease, background 150ms ease; transform: translateX(4mm); }
  .rem-pill .rem-label{ color: #FFB78C !important; }
  /* make the small icon inside the pill more visible */
  .rem-icon{ font-size:18px; line-height:1; display:inline-block; margin-right:6px }
  .rem-pill .rem-label{ font-size:14px; color:#C0C0C0; font-weight:500; opacity:0.9 }
  .rem-pill:focus{ outline:1px solid rgba(192,192,192,0.4); outline-offset:1px; background:linear-gradient(135deg, rgba(192,192,192,0.2), rgba(160,160,160,0.2)); }
  .rem-pill:hover{ background:linear-gradient(135deg, rgba(255,200,150,0.12), rgba(255,180,120,0.08)); box-shadow:0 2px 10px rgba(0,0,0,0.06); transform: translateX(4mm) scale(1.02); }
  @media (max-width:420px){ .rem-pill .rem-label{ display:none } }

  /* urgency states */
  .rem-pill.state-normal{ background:linear-gradient(135deg, rgba(255,187,140,0.06), rgba(255,170,120,0.04)); color:#FFB78C; }
  .rem-pill.state-soon{ background:linear-gradient(135deg, rgba(255,220,140,0.12), rgba(255,200,120,0.08)); color:#FF8C42; box-shadow:0 6px 18px rgba(255,140,66,0.06); }
  .rem-pill.state-urgent{ background:linear-gradient(135deg, rgba(255,120,120,0.12), rgba(255,90,90,0.06)); color:#ff4d4d; box-shadow:0 8px 22px rgba(255,80,80,0.10); transform:scale(1.04); }
  @keyframes remPulse{ 0%{ box-shadow:0 0 0 0 rgba(255,80,80,0.0); } 70%{ box-shadow:0 0 0 8px rgba(255,80,80,0.06);} 100%{ box-shadow:0 0 0 0 rgba(255,80,80,0.0);} }
  .rem-pill.pulse{ animation: remPulse 1.6s infinite ease-out; }
  #remBadge.state-normal{ background:#888; }
  #remBadge.state-soon{ background:#ffb04d; }
  #remBadge.state-urgent{ background:#ff4d4d; color:#fff; }

  /* Variant when the reminder pill is placed inside a card (non-fixed) */
  .rem-pill--inside{ position:static; transform:none; display:inline-flex; margin-left:6px; background:transparent; border:1px dashed rgba(255,160,110,0.06); padding:4px 8px; border-radius:8px; font-size:13px; color:var(--accent); vertical-align:middle; align-items:center; }
  .rem-pill--inside .rem-label{ color:var(--accent) !important; font-size:13px; display:inline-block }
  /* Totals row styling */
  table#monthTable .totals-row td:first-child {
    color: var(--accent);
  }
  /* Right-align numeric totals in the totals row for clarity */
  table#monthTable .totals-row td {
    text-align: right;
    font-weight:700;
    /* remove fine vertical separators between cells in the totals row */
    border-left: none !important;
    border-right: none !important;
    background: transparent;
  }
  table#monthTable .totals-row td:nth-child(3) {
    color: var(--danger);
  }
  table#monthTable .totals-row td:nth-child(5) {
    color: var(--positive);
  }
  table#monthTable .totals-row td:nth-child(7) {
    color: var(--positive);
  }

  @media print {
    .overlay { display: none !important; }
    .right-icon-wrap { display: none !important; }
    body { margin: 0 !important; font-size: 10px !important; }
    table th, table td { padding: 2px !important; font-size: 9px !important; }
    .card { padding: 4px !important; }
    .page-break-inside { page-break-inside: avoid !important; }
    #yearDataLabel { font-size: 14px !important; }
    .kpis { font-size: 10px !important; }
    .val { font-size: 12px !important; }
    h1 { font-size: 16px !important; }
    .chartCard canvas { height: 120px !important; }
    @page { margin: 0.3cm; }
  }</style>
<style>
  /* Toast notification styles */
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--accent);
    color: #111111;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    z-index: 1000;
    pointer-events: none;
  }
  .toast.show {
    opacity: 1;
    transform: translateY(0);
  }
</style>
<style>
  .titlebar .owner-year {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 8px 12px;
    margin-right: 16px;
    display: flex;
    gap: 12px;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .titlebar .owner-year div {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .owner-year label {
    font-size: 16px;
    color: var(--text);
    font-weight: 700;
    display: block;
  }
  .owner-year select {
  background: #171719;
    color: var(--gold);
    border: none;
    border-radius: 20px;
    padding: 8px 36px 8px 14px;
    font-size: 16px;
    min-width: 140px;
    cursor: pointer;
    transition: background-color 0.2s;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3ccircle cx='10' cy='10' r='1.5' fill='%23cccccc'/%3e%3c/svg%3e");
    background-position: right 8px center;
    background-repeat: no-repeat;
    background-size: 16px;
    font-weight: 700;
  }
  .owner-year select:hover {
  background: #1b1b1f;
  }
  .owner-year select:focus {
    outline: none;
  background: #1b1b1f;
  }
  /* Specific colors for Owner and Year selects */
  #owner { color: #ff9933; } /* Warmer orange for Owner */
  #year { color: #33cccc; } /* Bright cyan/teal for Year */
  @media (max-width: 768px) {
    .wrap { padding: 10px 8px 60px; }
    .sidebar { display: none; }
    .wrap { margin-left: 0; }
    .titlebar-inner { grid-template-columns: 1fr; gap: 8px; text-align: center; }
    .toolbar-right { justify-self: center; }
    .grid.row2 { grid-template-columns: 1fr; gap: 12px; }
    .kpis { grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .card { padding: 8px; }
    .tableCard table th, .tableCard table td { padding: 6px; font-size: 12px; }
    .btn { padding: 6px 10px; font-size: 12px; }
    h1 { font-size: 14px; }
    .pill { font-size: 11px; padding: 3px 6px; }
    .rem-drawer { width: 300px; }
  }
  @media (max-width: 480px) {
    .kpis { grid-template-columns: 1fr; }
    .owner-year { flex-direction: column; align-items: stretch; }
    .owner-year select { font-size: 14px; }
    .chartCard canvas { width: 100% !important; height: 150px !important; }
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/emailjs.min.js"></script>

<style id="fuad-remarks-and-notes-css">
  /* Ensure toolbar (right icon set) accepts clicks */
  .right-icon-set{ pointer-events:auto !important; }

  /* Note column: 2-line dark grey/orange */
  #monthTable td:nth-child(4){ vertical-align: top !important; }
  input[id^="month-note-"],
  textarea.note2 {
    background: #121212 !important;
    color: #888 !important;
    border: 1px solid rgba(255,140,0,0.35) !important;
    caret-color: #888;
  }
  input[id^="month-note-"]::placeholder,
  textarea.note2::placeholder { color: rgba(255,140,0,0.6) !important; }
  textarea.note2 {
    border-radius: 18px !important;
    width: 100% !important;
    min-height: 3.2em !important; /* ~2 lines */
    line-height: 1.25 !important;
    padding: 8px 12px !important;
    box-sizing: border-box !important;
    resize: none !important;
  }
  input[id^="month-note-"].note-hidden {
    position: absolute !important; left: -9999px !important;
    width: 1px !important; height: 1px !important; opacity: 0 !important;
    pointer-events: none !important;
  }

  /* Yearly Remarks popup */
  #yearlyRemarksOverlayLite[aria-hidden="true"]{ display:none !important; }
  #yearlyRemarksOverlayLite[aria-hidden="false"]{
    display:flex !important; position:fixed; inset:0;
    background: rgba(0,0,0,.5); z-index: 10040;
    align-items:center; justify-content:center; pointer-events:auto;
  }
  #yearlyRemarksOverlayLite .pop{
    max-width: 1200px; width: 96vw; max-height: 85vh; overflow:auto;
    background: #181818; color:#ff8c00;
    border:1px solid rgba(255,140,0,.35); border-radius:16px;
  }
  #yearlyRemarksOverlayLite header, #yearlyRemarksOverlayLite footer{
    display:flex; align-items:center; justify-content:space-between;
    padding: 10px 12px; border-bottom:1px solid rgba(255,140,0,.2);
  }
  #yearlyRemarksOverlayLite footer{ border-top:1px solid rgba(255,140,0,.2); border-bottom:none; }
  #yearlyRemarksOverlayLite .content{ padding:12px; }
  #yearlyRemarksOverlayLite .btn{ background:transparent; color:#ff8c00; border:1px solid rgba(255,140,0,.35); }
  .calendar-remarks-lite{
    display:grid; grid-template-columns: repeat(4, minmax(220px,1fr)); gap:12px;
  }
  @media (max-width: 1200px){ .calendar-remarks-lite{ grid-template-columns: repeat(3, minmax(220px,1fr)); } }
  @media (max-width: 900px){ .calendar-remarks-lite{ grid-template-columns: repeat(2, minmax(220px,1fr)); } }
  @media (max-width: 600px){ .calendar-remarks-lite{ grid-template-columns: 1fr; } }
  .month-card-lite{ background:#121212; border:1px solid rgba(255,140,0,.35); border-radius:14px; padding:10px; }
  .month-card-lite h4{ margin:0 0 6px 0; font-size:14px; font-weight:700; color:#ff8c00; }
  .month-card-lite textarea{
    width:100%; min-height:3.6em; resize:vertical; border-radius:14px;
    border:1px solid rgba(255,140,0,.35); padding:8px 10px;
    background:#121212; color:#888; box-sizing:border-box; line-height:1.25;
  }
  .month-card-lite textarea::placeholder{ color: rgba(255,140,0,.6); }

  /* Diversify colors in yearly remarks popup */
  #yearlyRemarksOverlayLite header h3 { color: #33cccc; } /* Title in cyan/teal */
  #yearlyRemarksOverlayLite header .btn { color: #dc3545; } /* Close button in red */
  .month-card-lite:nth-child(4n+1) h4 { color: #ff8c00; } /* Jan, May, Sep - orange */
  .month-card-lite:nth-child(4n+2) h4 { color: #007bff; } /* Feb, Jun, Oct - blue */
  .month-card-lite:nth-child(4n+3) h4 { color: #28a745; } /* Mar, Jul, Nov - green */
  .month-card-lite:nth-child(4n+4) h4 { color: #6f42c1; } /* Apr, Aug, Dec - purple */

  /* Change months text to orange */
  #kpiTitleMonths { color: orange !important; }

  /* Make deposit reminder text orange */
  .rem-pill--inside .rem-label { color: orange !important; font-size: 15px; }

  /* Calendar remarks button now uses standard .btn styles */

  /* Recolor textareas scrollbars to black track and yellow thumb */
  textarea::-webkit-scrollbar {
    width: 8px;
  }
  textarea::-webkit-scrollbar-track {
    background: #000;
  }
  textarea::-webkit-scrollbar-thumb {
    background: #ffff00;
  }
  textarea {
    scrollbar-width: thin;
    scrollbar-color: #ffff00 #000;
  }
</style>

</head>
<body style="margin-top: -9mm;">
  <div class="titlebar">
          <div class="titlebar-inner">
            <!-- Inline SVG sprite for KPI icons -->
            <svg style="display:none" aria-hidden="true">
              <symbol id="icon-check" viewBox="0 0 24 24">
                <path fill="currentColor" d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/>
              </symbol>
              <symbol id="icon-alert" viewBox="0 0 24 24">
                <path fill="currentColor" d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
              </symbol>
              <symbol id="icon-clock" viewBox="0 0 24 24">
                <path fill="currentColor" d="M12 1a11 11 0 1 0 11 11A11 11 0 0 0 12 1zm1 12.59V7h-2v6l5 3 .93-1.54z"/>
              </symbol>
            </svg>
      <div class="toolbar-right">
    <!-- Toolbar actions moved to right-edge icon set per user request -->
    <div style="width:1px; height:1px; opacity:0; pointer-events:none"></div>
    </div>
    </div>
  </div>
  <!-- Storage Diagnostics Overlay -->
  <div class="overlay" id="storageDiagOverlay" aria-hidden="true">
    <div class="pop" role="dialog" aria-modal="true" aria-labelledby="storageDiagTitle">
      <header>
        <h3 id="storageDiagTitle">Storage Diagnostics ‚Äî monthData keys</h3>
        <button class="btn close" id="btnStorageDiagClose">Close</button>
      </header>
      <div class="content">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <input id="sdSearch" type="text" placeholder="filter by key or value" style="width:100%; padding:8px; border-radius:8px;">
          <button class="btn" id="sdRefresh">Refresh</button>
          <button class="btn danger" id="sdClearAll">Delete All Found</button>
        </div>
        <div id="sdList" style="max-height:320px; overflow:auto; font-family:monospace; font-size:12px; background:#0f1113; border:1px solid #222; padding:8px; border-radius:8px;"></div>
      </div>
      <footer>
        <button class="btn close" id="btnStorageDiagClose2">Close</button>
      </footer>
    </div>
  </div>
  <input type="file" id="importFile" accept=".xlsx,.xls,.json" style="display:none" aria-label="Import data file" title="Import data file (.xlsx or .json)">

  <!-- Right-edge icon set containing primary actions (keeps original IDs & handlers) -->
  <style>
  /* KPI icon styles */
  .kpi-icon { display:inline-block; width:20px; height:20px; vertical-align:middle; margin-left:8px; }
  .kpi-icon svg { width:100%; height:100%; display:block; }
  .kpi-icon.comfort { color: #3bbf7d; }
  .kpi-icon.warning { color: #f5a623; }
  .kpi-icon.high { color: #f04f4f; }
  .kpi-icon.extreme { color: #b00020; }
  .kpi-icon.hidden { display:none; }
  .right-icon-wrap{ position:fixed; right:calc(12px + 3mm); top:calc(60px + 2cm + 2mm); transform:none; z-index:12000; display:flex; flex-direction:column; align-items:flex-end; gap:8px; }
  .right-icon-set{ display:flex; flex-direction:column; gap:8px; background:transparent; padding:6px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.35); transform-origin:right center; transition:transform .18s ease, opacity .18s ease; opacity:0; transform:translateX(8px) scale(.98) translateY(-2cm); pointer-events:none; }
  .right-icon-set.open{ opacity:1; transform:translateX(0) scale(1) translateY(-2cm); pointer-events:auto; }
  .right-icon-set .btn{ display:flex; align-items:center; justify-content:center; gap:0; width:120px; height:32px; padding:4px 8px; border-radius:6px; font-size:12px; }
  .right-icon-set .btn .label{ display:none; white-space:nowrap; font-size:12px; color:var(--text); background:transparent; padding:0; border-radius:0; }
  .right-icon-set.open .btn .label{ display:inline-block; }
  .right-icon-set .btn.round{ width:120px; border-radius:6px; }
  .right-icon-toggle{ width:40px; height:40px; border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,0.25); background:var(--card); font-size:18px; transform: translateY(-2cm); }
    @media (max-width:768px){ .right-icon-wrap{ right:8px; } }
  </style>
  <div class="right-icon-wrap" id="rightIconWrap">
    <!-- Ayat logo placed at the top of the ribbon (above the toggle) -->
  <style>
  /* Ayat logo in the right ribbon (top placement, moved up by 2.9cm, made more noticeable) */
  #ayatLogo{ width:60px; height:auto; border-radius:8px; display:block; margin-bottom:8px; box-shadow:0 8px 24px rgba(0,0,0,0.4), 0 0 20px rgba(123,217,159,0.3); cursor:pointer; transform: translateY(-2.9cm); transition: transform 0.3s ease, box-shadow 0.3s ease; }
  #ayatLogo:hover{ transform: translateY(-2.9cm) scale(1.05); box-shadow:0 10px 30px rgba(0,0,0,0.5), 0 0 30px rgba(123,217,159,0.5); }
  @media (max-width:480px){ #ayatLogo{ width:48px; } #ayatLogo:hover{ transform: translateY(-2.9cm) scale(1.05); } }
  </style>
  <img id="ayatLogo" src="file:///C:/Users/fuad/OneDrive%20-%20Ayat%20Group/Desktop/Ayat_colored.png" alt="Ayat Group" title="Ayat Group" />
    <div class="right-icon-toggle" id="rightIconToggle" role="button" aria-expanded="false" title="Show actions">‚ãØ</div>
    <div class="right-icon-set" id="rightIconSet" aria-hidden="true">
  <button class="btn" id="btnReset" title="Reset"><span class="label">Reset</span></button>
  <button class="btn" id="btnRefresh" title="Refresh Page"><span class="label">Refresh</span></button>
  <button class="btn" id="btnAiAnalysis" title="AI Analysis"><span class="label">AI Analysis</span></button>
  <button class="btn" id="btnExport" title="Export"><span class="label">Export</span></button>
  <button class="btn" id="btnYearlyRemarksLite" title="Yearly Calendar ‚Äî Remarks"><span class="label">Calendar Remarks</span></button>

  <button class="btn" id="btnUndo" title="Undo"><span class="label">Undo</span></button>
  <button class="btn" id="btnImport" title="Import"><span class="label">Import</span></button>
  <!-- Theme toggle removed per user request -->
  <button class="btn round" id="btnTopShare" title="Deposit required"><span class="label">Deposit required</span></button>
  <button class="btn" id="btnEmailSettings" title="Email Settings"><span class="label">Email Settings</span></button>
  <button class="btn" id="btnStorageDiag" title="Storage Diagnostics"><span class="label">Storage</span></button>
  <button class="btn" id="btnToggleNotes" title="Hidden notes (per Owner &amp; Year)"><span class="label">Notes</span></button>
    </div>
  <!-- duplicate logo removed -->
  </div>
  <script>
    (function(){
      const toggle = document.getElementById('rightIconToggle');
      const set = document.getElementById('rightIconSet');
      if(!toggle || !set) return;
      function open(){ set.classList.add('open'); set.setAttribute('aria-hidden','false'); toggle.setAttribute('aria-expanded','true'); }
      function close(){ set.classList.remove('open'); set.setAttribute('aria-hidden','true'); toggle.setAttribute('aria-expanded','false'); }
      let opened = true;
      toggle.addEventListener('click', ()=>{ opened = !opened; if(opened) open(); else close(); });
      // Start with buttons open
      open();
      // No outside click to close; buttons close only on toggle click
      // close on Escape
      document.addEventListener('keydown', (ev)=>{ if(ev.key === 'Escape' && opened){ opened = false; close(); } });
    })();

      // Storage Diagnostics wiring
      (function(){
        const btn = document.getElementById('btnStorageDiag');
        const overlay = document.getElementById('storageDiagOverlay');
        const closeBtns = [document.getElementById('btnStorageDiagClose'), document.getElementById('btnStorageDiagClose2')];
        const listEl = document.getElementById('sdList');
        const searchEl = document.getElementById('sdSearch');
        const refreshBtn = document.getElementById('sdRefresh');
        const clearAllBtn = document.getElementById('sdClearAll');

        if(!btn || !overlay || !listEl) return;
        function enumerate(filter){
          listEl.textContent = '';
          const found = [];
          for(let i=0;i<localStorage.length;i++){
            const k = localStorage.key(i);
            if(!k) continue;
            if(!k.endsWith(':monthData')) continue;
            const raw = localStorage.getItem(k)||'';
            const preview = raw.substring(0,300) + (raw.length>300? '...':'');
            if(filter){ const f = filter.toLowerCase(); if(!(k.toLowerCase().includes(f) || preview.toLowerCase().includes(f))) continue; }
            found.push({ key:k, raw, preview });
          }
          if(found.length===0){ listEl.innerHTML = '<div style="padding:8px;color:var(--muted)">No :monthData keys found.</div>'; return found; }
          // Build UI
          found.forEach(item=>{
            const wrap = document.createElement('div'); wrap.style.padding='8px'; wrap.style.borderBottom='1px solid rgba(255,255,255,0.03)';
            const keyEl = document.createElement('div'); keyEl.textContent = item.key; keyEl.style.fontWeight='700'; keyEl.style.marginBottom='6px';
            const pre = document.createElement('pre'); pre.style.whiteSpace='pre-wrap'; pre.style.margin='0 0 6px 0'; pre.textContent = item.preview;
            const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
            const btnView = document.createElement('button'); btnView.className='btn'; btnView.textContent='View full';
            const btnDelete = document.createElement('button'); btnDelete.className='btn danger'; btnDelete.textContent='Delete';
            btnView.addEventListener('click', ()=>{ try{ const full = item.raw || ''; const w = window.open('about:blank','_blank'); w.document.write('<pre style="white-space:pre-wrap;font-family:monospace;padding:10px">'+(full.replace(/</g,'&lt;'))+'</pre>'); w.document.close(); }catch(e){ alert('Open failed: '+e.message); } });
            btnDelete.addEventListener('click', ()=>{ if(!confirm('Delete key '+item.key+' ? This cannot be undone.')) return; try{ localStorage.removeItem(item.key); showToast('Deleted '+item.key); enumerate(searchEl.value); }catch(e){ alert('Delete failed: '+String(e)); } });
            actions.appendChild(btnView); actions.appendChild(btnDelete);
            wrap.appendChild(keyEl); wrap.appendChild(pre); wrap.appendChild(actions);
            listEl.appendChild(wrap);
          });
          return found;
        }

        btn.addEventListener('click', ()=>{ overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); enumerate(''); try{ searchEl.focus(); }catch(e){} });
        closeBtns.forEach(c=>{ if(c) c.addEventListener('click', ()=>{ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); }); });
        refreshBtn && refreshBtn.addEventListener('click', ()=> enumerate(searchEl.value));
        searchEl && searchEl.addEventListener('input', ()=> enumerate(searchEl.value));
        clearAllBtn && clearAllBtn.addEventListener('click', ()=>{
          if(!confirm('Delete ALL :monthData keys found? This will remove month data for all owners/years that match.')) return;
          const found = enumerate(searchEl.value);
          found.forEach(f=>{ try{ localStorage.removeItem(f.key); }catch(e){} });
          showToast('Deleted '+found.length+' keys');
          enumerate(searchEl.value);
        });
      })();
  </script>



  <div class="wrap grid">
    <!-- Main Title -->
    <div class="card" style="text-align:center;">
  <h1 style="margin:0; font-size:20px; color:var(--gold); font-family: 'Georgia', serif; font-weight: bold; letter-spacing: 1.5px;">ENBD Performance Tracker</h1>
  <p style="margin:5px 0 0; font-size:14px; font-style:italic; color:#ADD8E6; font-family: 'Georgia', serif;">Created by Fuad Al-Taher</p>
    </div>

  <!-- Owner and Year Selectors -->
  <div class="card" style="position:fixed; left:0; top:2mm; width:220px; text-align:left; margin-bottom:12px; z-index:140;">
      <div class="owner-year" style="flex-direction: column;">
        <div>
          <label for="owner">Owner</label>
          <div style="display:flex; gap:8px; align-items:center">
            <select id="owner"><option value="SHTHA_ENDB">SHTHA_ENDB</option><option value="Owner 2">Owner 2</option><option value="Owner 3">Owner 3</option><option value="Owner 4">Owner 4</option><option value="Owner 5">Owner 5</option><option value="Owner 6">Owner 6</option><option value="Owner 7">Owner 7</option><option value="Owner 8">Owner 8</option><option value="Owner 9">Owner 9</option><option value="Owner 10">Owner 10</option></select>
          </div>
        </div>

          <!-- Hidden Notes Drawer (per Owner & Year) -->
          <div class="notes-drawer" id="notesDrawer" aria-hidden="true">
            <div class="notes-drawer-inner">
              <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; padding-bottom:6px; border-bottom:1px solid rgba(255,255,255,0.03);">
                <h3 style="margin:0; font-size:13px;">Notes (hidden)</h3>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button class="btn" id="btnCloseNotes" style="font-size:12px; padding:6px 8px" title="Close notes">Close</button>
                </div>
              </div>
                <div style="padding-top:8px;">
                <textarea id="notesArea" class="textarea" style="min-height:180px; font-size:13px" placeholder="Write private notes for this Owner &amp; Year..."></textarea>
                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
                  <button class="btn" id="btnClearNotes" title="Clear notes">Clear</button>
                  <button class="btn" id="btnSaveNotes" title="Save notes">Save</button>
                  <!-- Added Close button under notes controls -->
                  <button class="btn" id="noteCloseBtn" style="font-size:12px; padding:6px 8px; margin-left:8px" title="Close notes">Close</button>
                </div>
                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
                  <div class="sbtn" id="noteWhatsApp" style="cursor:pointer;">WhatsApp</div>
                  <div class="sbtn" id="noteEmail" style="cursor:pointer;">Email</div>
                  <div class="sbtn" id="noteCopy" style="cursor:pointer;">Copy</div>
                  <div class="sbtn" id="notePrint" style="cursor:pointer;">Print</div>
                </div>
              </div>
            </div>
          </div>
        <div>
          <label for="year">Year</label>
          <select id="year">
            <!-- years from 2023..2050 -->
            <option>2023</option>
            <option>2024</option>
            <option selected="">2025</option>
            <option>2026</option>
            <option>2027</option>
            <option>2028</option>
            <option>2029</option>
            <option>2030</option>
            <option>2031</option>
            <option>2032</option>
            <option>2033</option>
            <option>2034</option>
            <option>2035</option>
            <option>2036</option>
            <option>2037</option>
            <option>2038</option>
            <option>2039</option>
            <option>2040</option>
            <option>2041</option>
            <option>2042</option>
            <option>2043</option>
            <option>2044</option>
            <option>2045</option>
            <option>2046</option>
            <option>2047</option>
            <option>2048</option>
            <option>2049</option>
            <option>2050</option>
          </select>
        </div>
  <span id="yearDataLabel" style="text-align: center; display: inline-block; position: relative; left: 0px; white-space: nowrap; font-size: 12px;">SHTHA_ENDB Year Data: 2025</span>
      </div>
    </div>

    <!-- Cheque Deposit Reminders (moved up for visibility) -->
    <!-- Floating reminders drawer trigger (visible) -->
    <div id="reminderDrawer" class="rem-drawer">
      <div class="rem-drawer-inner">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:4px">
          <div style="display:flex; align-items:center; gap:10px;">
            <h3 style="margin:0; font-size:10px;">Cheque Deposit Reminders</h3>
          </div>
          <div style="display:flex; gap:4px; align-items:center;">
            <button class="btn" id="btnAddCustom" style="font-size:10px;" title="Add reminder">Add</button>
            <button class="btn" id="btnCloseRemDrawer" title="Close" style="font-size:10px;">Close</button>
          </div>
        </div>
  <div id="remList" style="min-height: 80px; display: block;"></div>
  <div id="remDebug" style="font-size:11px; color:var(--muted); margin-top:6px">load: no reminders</div>
        
      </div>
    </div>
    <!-- Floating pill to open reminders drawer (moved into Mo. Needed card) -->
  <!-- original floating location removed; button reinserted inside #moNeededCard so handlers remain attached -->

  <!-- Owners Editor Overlay -->
  <div class="overlay" id="ownersOverlay" aria-hidden="true">
    <div class="pop" role="dialog" aria-modal="true" aria-labelledby="ownersTitle">
      <header>
        <h3 id="ownersTitle">Manage Owners</h3>
        <button class="btn close" id="btnOwnersClose">Close</button>
      </header>
      <div class="content">
        <div style="margin-bottom:8px">Edit the owner names below. You can add, rename or remove owners. Changes are saved per Owner &amp; Year context.</div>
        <div id="ownersList" style="display:flex; flex-direction:column; gap:8px; margin-bottom:10px"></div>
        <div style="display:flex; gap:8px">
          <button class="btn" id="btnAddOwner">Add Owner</button>
          <button class="btn" id="btnSaveOwners">Save</button>
        </div>
      </div>
      <footer>
        <button class="btn close" id="btnOwnersClose2">Close</button>
      </footer>
    </div>
  </div>

    <!-- KPIs -->
    <div class="card">
      <div class="kpis">
        <div class="kpi">
          <h3>üìä Total Target</h3>
          <div class="val neutral-muted" id="kpiTotalTarget">0</div>
        </div>
        <div class="kpi">
          <h3>üí∞ YTD Inflow</h3>
          <div class="val positive" id="kpiInflow">3,000</div>
        </div>
        <div class="kpi">
          <h3>‚öñÔ∏è Remaining to Active Target</h3>
          <div class="val positive" id="kpiBalance">3,000</div>
        </div>

        <div class="kpi">
          <h3>üè¶ Opening Balance</h3>
          <div class="val" id="kpiOpeningBalance" style="color:#FFD700">0</div>
        </div>
        <div class="kpi">
          <h3>üìà Avg. Mo. Target</h3>
          <div class="val" id="kpiAvgMoTarget">0</div>
        </div>
        <div class="kpi">
          <h3>üìä Avg. Mo. Inflow</h3>
          <div class="val positive" id="kpiAvgMonthly">375</div>
        </div>

        <div class="kpi">
          <h3>üìâ Mo. Variance</h3>
          <div class="val positive" id="kpiMoVariance">375</div>
        </div>
        <div class="kpi">
          <h3>üìä Total Deviation</h3>
          <div class="val positive" id="kpiTotalDeviation">3,000</div>
        </div>
        <div class="kpi">
          <h3>üîÆ Forecasted Year-End</h3>
          <div class="val positive" id="kpiForecastYearEnd">4,500
            <div id="forecastRange" style="font-size:9px; color:var(--muted); margin-top:4px;">Forecast: Calculating...</div>
          </div>
        </div>
        <!-- Mo. Needed tile moved below the KPI grid to sit clearly under the upper KPI numbers -->
      </div>
    </div>

      <!-- Prominent Mo. Needed card (full-width beneath KPIs) - toned down visuals -->
    <div class="card" id="moNeededCard" style="margin-top:-2mm; text-align:center; transform:scaleY(0.72); transform-origin:top center;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; position:relative;">
  <!-- Forecast text moved into the Forecast KPI tile to simplify layout -->
  <!-- absolutely-centered number (relative to this wrapper) -->
  <div id="kpiMoNeeded" class="val attention" style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); font-size:20px; font-weight:700; z-index:2; pointer-events:none;">0</div>
        <!-- Left: title -->
          <div style="flex:0 0 auto; text-align:left; min-width:220px; display:flex; align-items:center; gap:8px; z-index:1;">
          <h3 style="margin:0; font-weight:600; font-size:10.8px; color:#33cccc">üìä Mo. Inflow Needed to Year-End <span id="kpiTitleMonths" style="font-weight:400; color:orange !important; margin-left:8px; font-size:14px">4 Months</span></h3>
        </div>
        <!-- Right: reminder pill stays on the right without affecting center alignment -->
  <div style="flex:0 0 auto; display:flex; align-items:center; gap:8px; z-index:1; transform: translateX(-8mm);">
          <button id="btnOpenRem" class="rem-pill rem-pill--inside state-normal" aria-label="Open reminders" title="No upcoming reminders"><span class="rem-icon">üîî</span> <span class="rem-label">Dep. Reminder ‚Ä¢ 0</span> <span id="remBadge" aria-hidden="true" class="state-normal">0</span></button>
        </div>
      </div>
    </div>

      <!-- Standalone chart card (under KPIs) -->
      <div class="card" id="chartCard" style="margin-top:-12mm; position:relative;">
        <h3 style="margin:0 0 8px 0; font-size:14px">Monthly Overview</h3>
        <!-- Inline mini-legend placed above/right of the chart -->
        <div id="miniLegend" style="position:absolute; right:12px; top:28px; display:flex; gap:12px; align-items:center; background:rgba(255,255,255,0.02); padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); z-index:5;">
          <div style="display:flex; gap:6px; align-items:center; font-size:13px; color:var(--muted);">
            <span style="display:inline-block; width:18px; height:10px; border:2px solid #7bd99f; background:transparent; border-radius:2px;"></span>
            <span style="color:#7bd99f;">Balance</span>
          </div>
          <div style="display:flex; gap:6px; align-items:center; font-size:13px; color:var(--muted);">
            <span style="display:inline-block; width:18px; height:10px; border:2px dashed #ff0000; background:transparent; border-radius:2px;"></span>
            <span style="color:#ff0000;">Target</span>
          </div>
          <div style="display:flex; gap:6px; align-items:center; font-size:13px; color:var(--muted);">
            <span style="display:inline-block; width:18px; height:10px; border:2px solid #66a6ff; background:transparent; border-radius:2px;"></span>
            <span style="color:#66a6ff;">Bank Inflow</span>
          </div>
        </div>
        <div style="height:180px;">
          <canvas id="miniChart" aria-label="Monthly balances chart" role="img" style="width: 1026px; height: 180px; display: block; box-sizing: border-box;" width="2052" height="360"></canvas>
        </div>
      </div>

    <!-- Monthly table + chart -->
    <div class="grid row2">
      <div class="tableCard card">
        <div class="note" style="display:grid; grid-template-columns:7% 8% 12% 41% 12% 10% 10%; gap:8px; align-items:center;">
          <div style="grid-column:1 / 5; font-size:13px;">Edit amounts and they are saved <b>per Owner &amp; Year</b>. Chart and KPIs update automatically.</div>
          <div style="grid-column:5 / 8; display:flex; justify-content:flex-end; align-items:center; gap:8px; transform: translateX(-1.5cm);">
            <label style="font-size:13px; white-space:nowrap">Opening Balance:</label>
            <input id="openingBalance" type="text" value="0" style="width:140px; text-align:right; padding:4px 6px; border-radius:6px; color:#FFD700;">
          </div>
        </div>
  <table id="monthTable">
          <thead>
            <tr>
              <th style="width:7.7%">Day</th>
              <th style="width:8%">Month</th>
              <th style="width:12%">Target</th>
              <th style="width:41%">Note</th>
              <th style="width:12%">Bank Inflow</th>
              <th style="width:10%">Variance</th>
              <th style="width:10%">Balance</th>
            </tr>
          </thead>
          <tbody><tr><td><input type="text" id="month-day-0" aria-label="Day for Jan" style="font-size: 9px;"></td><td>Jan</td><td><input type="text" id="month-target-0" aria-label="Target for Jan"></td><td><input type="text" id="month-note-0" placeholder="Note" aria-label="Note for Jan" style="border:none;background:transparent;color:transparent;width:1px;height:1px;padding:0;margin:0;overflow:hidden;position:absolute;left:-9999px"></td><td><input type="text" id="month-inflow-0" aria-label="Bank inflow for Jan"></td><td class="positive">3,000</td><td class="positive">3,000</td></tr><tr><td><input type="text" id="month-day-1" aria-label="Day for Feb" style="font-size: 9px;"></td><td>Feb</td><td><input type="text" id="month-target-1" aria-label="Target for Feb"></td><td><input type="text" id="month-note-1" placeholder="Note" aria-label="Note for Feb" style="border:none;background:transparent;color:transparent;width:1px;height:1px;padding:0;margin:0;overflow:hidden;position:absolute;left:-9999px"></td><td><input type="text" id="month-inflow-1" aria-label="Bank inflow for Feb"></td><td>0</td><td class="positive">3,000</td></tr><tr><td><input type="text" id="month-day-2" aria-label="Day for Mar" style="font-size: 9px;"></td><td>Mar</td><td><input type="text" id="month-target-2" aria-label="Target for Mar"></td><td><input type="text" id="month-note-2" placeholder="Note" aria-label="Note for Mar" style="border:none;background:transparent;color:transparent;width:1px;height:1px;padding:0;margin:0;overflow:hidden;position:absolute;left:-9999px"></td><td><input type="text" id="month-inflow-2" aria-label="Bank inflow for Mar"></td><td>0</td><td class="positive">3,000</td></tr><tr><td><input type="text" id="month-day-3" aria-label="Day for Apr" style="font-size: 9px;"></td><td>Apr</td><td><input type="text" id="month-target-3" aria-label="Target for Apr"></td><td><input type="text" id="month-note-3" placeholder="Note" aria-label="Note for Apr" style="border:none;background:transparent;color:transparent;width:1px;height:1px;padding:0;margin:0;overflow:hidden;position:absolute;left:-9999px"></td><td><input type="text" id="month-inflow-3" aria-label="Bank inflow for Apr"></td><td>0</td><td class="positive">3,000</td></tr><tr><td><input type="text" id="month-day-4" aria-label="Day for May" style="font-size: 9px;"></td><td>May</td><td><input type="text" id="month-target-4" aria-label="Target for May"></td><td><input type="text" id="month-note-4" placeholder="Note" aria-label="Note for May" style="border:none;background:transparent;color:transparent;width:1px;height:1px;padding:0;margin:0;overflow:hidden;position:absolute;left:-9999px"></td><td><input type="text" id="month-inflow-4" aria-label="Bank inflow for May"></td><td>0</td><td class="positive">3,000</td></tr><tr><td><input type="text" id="month-day-5" aria-label="Day for Jun" style="font-size: 9px;"></td><td>Jun</td><td><input type="text" id="month-target-5" aria-label="Target for Jun"></td><td><input type="text" id="month-note-5" placeholder="Note" aria-label="Note for Jun" style="border:none;background:transparent;color:transparent;width:1px;height:1px;padding:0;margin:0;overflow:hidden;position:absolute;left:-9999px"></td><td><input type="text" id="month-inflow-5" aria-label="Bank inflow for Jun"></td><td>0</td><td class="positive">3,000</td></tr><tr><td><input type="text" id="month-day-6" aria-label="Day for Jul" style="font-size: 9px;"></td><td>Jul</td><td><input type="text" id="month-target-6" aria-label="Target for Jul"></td><td><input type="text" id="month-note-6" placeholder="Note" aria-label="Note for Jul" style="border:none;background:transparent;color:transparent;width:1px;height:1px;padding:0;margin:0;overflow:hidden;position:absolute;left:-9999px"></td><td><input type="text" id="month-inflow-6" aria-label="Bank inflow for Jul"></td><td>0</td><td class="positive">3,000</td></tr><tr><td><input type="text" id="month-day-7" aria-label="Day for Aug" style="font-size: 9px;"></td><td>Aug</td><td><input type="text" id="month-target-7" aria-label="Target for Aug"></td><td><input type="text" id="month-note-7" placeholder="Note" aria-label="Note for Aug" style="border:none;background:transparent;color:transparent;width:1px;height:1px;padding:0;margin:0;overflow:hidden;position:absolute;left:-9999px"></td><td><input type="text" id="month-inflow-7" aria-label="Bank inflow for Aug"></td><td>0</td><td class="positive">3,000</td></tr><tr><td><input type="text" id="month-day-8" aria-label="Day for Sep" style="font-size: 9px;"></td><td>Sep</td><td><input type="text" id="month-target-8" aria-label="Target for Sep"></td><td><input type="text" id="month-note-8" placeholder="Note" aria-label="Note for Sep" style="border:none;background:transparent;color:transparent;width:1px;height:1px;padding:0;margin:0;overflow:hidden;position:absolute;left:-9999px"></td><td><input type="text" id="month-inflow-8" aria-label="Bank inflow for Sep"></td><td>0</td><td class="positive">3,000</td></tr><tr><td><input type="text" id="month-day-9" aria-label="Day for Oct" style="font-size: 9px;"></td><td>Oct</td><td><input type="text" id="month-target-9" aria-label="Target for Oct"></td><td><input type="text" id="month-note-9" placeholder="Note" aria-label="Note for Oct" style="border:none;background:transparent;color:transparent;width:1px;height:1px;padding:0;margin:0;overflow:hidden;position:absolute;left:-9999px"></td><td><input type="text" id="month-inflow-9" aria-label="Bank inflow for Oct"></td><td>0</td><td class="positive">3,000</td></tr><tr><td><input type="text" id="month-day-10" aria-label="Day for Nov" style="font-size: 9px;"></td><td>Nov</td><td><input type="text" id="month-target-10" aria-label="Target for Nov"></td><td><input type="text" id="month-note-10" placeholder="Note" aria-label="Note for Nov" style="border:none;background:transparent;color:transparent;width:1px;height:1px;padding:0;margin:0;overflow:hidden;position:absolute;left:-9999px"></td><td><input type="text" id="month-inflow-10" aria-label="Bank inflow for Nov"></td><td>0</td><td class="positive">3,000</td></tr><tr><td><input type="text" id="month-day-11" aria-label="Day for Dec" style="font-size: 9px;"></td><td>Dec</td><td><input type="text" id="month-target-11" aria-label="Target for Dec"></td><td><input type="text" id="month-note-11" placeholder="Note" aria-label="Note for Dec" style="border:none;background:transparent;color:transparent;width:1px;height:1px;padding:0;margin:0;overflow:hidden;position:absolute;left:-9999px"></td><td><input type="text" id="month-inflow-11" aria-label="Bank inflow for Dec"></td><td>0</td><td class="positive">3,000</td></tr></tbody>
          <tfoot>
            <tr class="totals-row" style="font-weight:700;">
              <td colspan="2" style="color:#58a6ff; text-align:center; vertical-align:middle;">Total</td>
              <td id="totTarget" style="color:#f85149">0</td>
              <td></td>
              <td id="totInflow" style="color:#7bd99f">3,000</td>
              <td id="totVariance" style="color: rgb(123, 217, 159);">3,000</td>
              <td id="totBalance" style="color:#7bd99f">3,000</td>
            </tr>
            <tr>
              <td style="padding:6px; vertical-align:top;">
                <div id="privacyUnderTotal" style="display:flex; gap:6px; align-items:center;">
                  <input id="currentPassword" type="password" placeholder="cur" title="Current password" style="padding: 4px; font-size: 11px; width: 68px; border-radius: 6px; display: block; background: var(--accent); color: #ffffff;">
                  <input id="newPassword" type="password" placeholder="new" title="New password" style="padding:4px; font-size:11px; width:68px; border-radius:6px; background: var(--accent); color: #ffffff;">
                  <button id="btnSavePassword" class="btn" title="Save" style="padding:4px; font-size:12px; width:36px; height:28px; display:flex; align-items:center; justify-content:center;">üîí</button>
                  <button id="btnRemovePassword" class="btn" title="Remove" style="padding:4px; font-size:12px; width:36px; height:28px; display:flex; align-items:center; justify-content:center;">üóëÔ∏è</button>
                  <button class="btn" id="btnEditOwners" title="Manage owners" style="padding:6px 8px; font-size:12px">üë•</button>
                  <button class="btn" id="btnDuplicateOwner" title="Duplicate owner data" style="padding:6px 8px; font-size:12px">üìã</button>
                  <span class="fineTextInline">Enter current password to enable edits. Renaming owners migrates data for the selected year.</span>
                </div>
              </td>
              <td colspan="6"></td>
            </tr>
          </tfoot>
        </table>
        <!-- compact ribbon removed (owner photo and duplicates) -->
  <div id="monthDebug" style="font-size:11px; color:var(--muted); margin-top:6px; white-space:pre-wrap; max-height:120px; overflow:auto"></div>
      </div>
    </div>

    

    <!-- remindersCard moved to top for visibility -->
  </div>

  <!-- Share Monthly Plan Popup -->
  <div class="overlay" id="shareOverlay" aria-hidden="true">
    <div class="pop" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
      <header>
  <h3 id="shareTitle" style="font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; font-weight:600; font-size:10px">Deposit required</h3>
        <button class="btn close" id="btnShareClose">Close</button>
      </header>
      <div class="content">
  <label for="shareRecipient" class="required-label" style="font-size:10px; margin-bottom:6px; display:block; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif">Recipient name required</label>
  <input id="shareRecipient" type="text" placeholder="Recipient Name" style="width:100%; padding:8px; margin-bottom:8px; border-radius:8px; background:#18181b; border:1px solid #2a2a30; color:var(--text); font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; font-size:10px">
        <textarea id="shareText" class="textarea" spellcheck="false"></textarea>
        <div class="sharegrid">
          <div class="sbtn" id="sWhatsApp">WhatsApp</div>
          <div class="sbtn" id="sEmail">Email</div>
          <div class="sbtn" id="sCopy">Copy</div>
          <div class="sbtn" id="sPrint">Print</div>
        </div>
        <div class="hint" style="margin-top:8px">Removed: Telegram, SMS (as requested). Footer signs ‚ÄúThanks, Fuad Al‚ÄëTaher‚Äù.</div>
      </div>
      <footer>
        <button class="btn close" id="btnShareClose2">Close</button>
      </footer>
    </div>
  </div>

  <!-- Password Overlay -->
  <div class="overlay" id="passwordOverlay" aria-hidden="true">
    <div class="pop" role="dialog" aria-modal="true" aria-labelledby="passwordTitle">
      <header>
        <h3 id="passwordTitle">Enter Password</h3>
      </header>
      <div class="content">
        <p>Data is protected. Enter password to access.</p>
        <form id="passwordForm" onsubmit="return false;">
          <input id="passwordInput" type="password" placeholder="Password">
          <button id="btnEnterPassword" type="submit">Enter</button>
        </form>
      </div>
    </div>
  </div>

  <!-- AI Analysis Popup -->
  <div class="overlay" id="aiOverlay" aria-hidden="true">
    <div class="pop" role="dialog" aria-modal="true" aria-labelledby="aiTitle">
      <header>
        <h3 id="aiTitle">AI Analysis ‚Äî Owner Situation</h3>
        <button class="btn close" id="btnAiClose">Close</button>
      </header>
      <div class="content">
        <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center">
          <button class="btn" id="btnRunAi">Run Analysis</button>
          <button class="btn" id="btnToggleBreakdown" title="Show/hide per-month breakdown">Show breakdown</button>
          <div style="color:var(--muted); font-size:13px">Analysis is local and heuristic-based.</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
          <label style="display:flex; align-items:center; gap:8px; font-size:13px">Scenario:
            <select id="aiScenarioSelect" style="padding:6px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text)">
              <option value="All">All (Conservative / Base / Optimistic / No Change)</option>
              <option value="Conservative">Conservative</option>
              <option value="Base">Base</option>
              <option value="Optimistic">Optimistic</option>
              <option value="No Change">No Change</option>
            </select>
          </label>
          <label style="display:flex; align-items:center; gap:8px; font-size:13px">If deposit (AED):
            <input id="aiIfDeposit" type="number" placeholder="0" style="width:120px; padding:6px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text)">
          </label>
          <button class="btn" id="btnApplyIf">Apply</button>
          <button class="btn" id="btnSaveScenario" title="Save scenario settings">Save</button>
        </div>
        <div style="display:flex; gap:12px; align-items:center; margin-bottom:10px;">
          <label style="font-size:13px">Multipliers:</label>
          <label style="display:flex; gap:6px; align-items:center; font-size:13px">Conservative <input id="mulConservative" type="number" step="0.01" value="0.8" style="width:80px; padding:6px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text)"></label>
          <label style="display:flex; gap:6px; align-items:center; font-size:13px">Base <input id="mulBase" type="number" step="0.01" value="1.0" style="width:80px; padding:6px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text)"></label>
          <label style="display:flex; gap:6px; align-items:center; font-size:13px">Optimistic <input id="mulOptimistic" type="number" step="0.01" value="1.25" style="width:80px; padding:6px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text)"></label>
        </div>
        <div style="margin-bottom:8px">Scenario comparison:</div>
  <div style="background:#17171a; border:1px solid #2a2a30; border-radius:8px; padding:8px; margin-bottom:12px">
          <div id="aiScenarioTable" style="font-size:13px; white-space:pre-wrap; font-family:monospace">Kind     | Avg/mo  | Exp Year-End | Shortfall
---------------------------------------------
Conservative|     300 |        4,200 |         0
Base     |     375 |        4,500 |         0
Optimistic|     469 |        4,876 |         0</div>
        </div>
  <label for="aiShareRecipient" class="required-label" style="font-size:10px; margin-bottom:6px; display:block; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">Recipient name required for sharing</label>
  <input id="aiShareRecipient" type="text" placeholder="Recipient Name" style="width:100%; padding:8px; margin-bottom:8px; border-radius:8px; background:#18181b; border:1px solid #2a2a30; color:var(--text); font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size:10px">
        <div style="margin:8px 0; display:flex; gap:8px; align-items:center;">
          <div class="sharegrid" style="grid-template-columns:repeat(4,1fr); width:100%;">
            <div class="sbtn" id="sWhatsAppAi">WhatsApp</div>
            <div class="sbtn" id="sEmailAi">Email</div>
            <div class="sbtn" id="sCopyAi">Copy</div>
            <div class="sbtn" id="sPrintAi">Print</div>
          </div>
        </div>
        <textarea id="aiText" class="textarea" spellcheck="false" readonly="" style="min-height:320px"></textarea>
      </div>
      <footer>
        <button class="btn close" id="btnAiClose2">Close</button>
      </footer>
    </div>
  </div>

  <!-- Scenario Planner Overlay -->
  <div class="overlay" id="scenarioOverlay" aria-hidden="true">
    <div class="pop" role="dialog" aria-modal="true" aria-labelledby="scenarioTitle">
      <header>
        <h3 id="scenarioTitle">üéØ Scenario Planner</h3>
        <button class="btn close" id="btnScenarioClose">Close</button>
      </header>
      <div class="content">
        <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-bottom:8px;">
          <label>Monthly Increase (AED): <input id="scMonthlyIncrease" type="number" value="0"></label>
          <label>One-off Inflow (AED): <input id="scOneOff" type="number" value="0"></label>
          <label>New Target (AED, optional): <input id="scNewTarget" type="number" placeholder="(leave blank)"></label>
          <label>Uplift % (Best): <input id="scBestPct" type="number" step="0.1" value="15"></label>
          <label>Drop % (Worst): <input id="scWorstPct" type="number" step="0.1" value="15"></label>
          <label>Growth Rate (% per month): <input id="scGrowthRate" type="number" step="0.1" value="0"></label>
          <label>Months Ahead: <input id="scMonthsAhead" type="number" value="4" min="1" max="12"></label>
          <label>Simulations (Monte Carlo): <input id="scSims" type="number" value="1000" min="100" max="10000"></label>
        </div>
        <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center">
          <button class="btn" id="btnRunScenario">Run Projection</button>
          <button class="btn" id="btnResetScenario">Reset</button>
          <button class="btn" id="btnScCopy">Copy</button>
          <button class="btn" id="btnScWhatsApp">WhatsApp</button>
          <button class="btn" id="btnScEmail">Email</button>
          <button class="btn" id="btnScPrint">Print</button>
          <div style="color:var(--accent-amber, #ffb84d); font-size:13px">Try changes and see projected year-end and action options.</div>
        </div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
          <label style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size:10px; color:var(--accent-amber, #ffb84d)">Recipient optional: <input id="scShareRecipient" type="text" placeholder="e.g., John Doe" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size:10px;"></label>
        </div>
  <div style="background:#17171a; border:1px solid #2a2a30; border-radius:8px; padding:10px;">
          <div style="display:flex; gap:8px; flex-direction:column;">
            <div id="scCards" style="display:flex; gap:8px; margin-bottom:8px;">
              <div id="scCardBase" style="flex:1; background:#161618; border:1px solid #2a2a30; border-radius:6px; padding:10px; position:relative; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.01);">
                <div style="position:absolute; left:0; top:0; bottom:0; width:4px; border-top-left-radius:6px; border-bottom-left-radius:6px; background: linear-gradient(180deg, var(--accent-amber), rgba(255,255,255,0.0)); opacity:0.95"></div>
                <div style="font-size:12px; color:var(--muted); letter-spacing:0.2px; text-transform:uppercase;">Baseline</div>
                <div id="scBaseProjected" style="font-weight:700; font-size:18px; margin-top:8px">-</div>
                <div id="scBaseNote" style="font-size:11px; color:var(--accent-amber, #ffb84d); margin-top:6px">-</div>
              </div>
              <div id="scCardBest" style="flex:1; background:#161618; border:1px solid #2a2a30; border-radius:6px; padding:10px; position:relative; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.01);">
                <div style="position:absolute; left:0; top:0; bottom:0; width:4px; border-top-left-radius:6px; border-bottom-left-radius:6px; background: linear-gradient(180deg, var(--accent-amber), rgba(255,255,255,0.0)); opacity:0.95"></div>
                <div style="font-size:12px; color:var(--muted); letter-spacing:0.2px; text-transform:uppercase;">Optimistic</div>
                <div id="scBestProjected" style="font-weight:700; font-size:18px; margin-top:8px">-</div>
                <div id="scBestNote" style="font-size:11px; color:var(--accent-amber, #ffb84d); margin-top:6px">-</div>
              </div>
              <div id="scCardWorst" style="flex:1; background:#161618; border:1px solid #2a2a30; border-radius:6px; padding:10px; position:relative; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.01);">
                <div style="position:absolute; left:0; top:0; bottom:0; width:4px; border-top-left-radius:6px; border-bottom-left-radius:6px; background: linear-gradient(180deg, var(--accent-amber), rgba(255,255,255,0.0)); opacity:0.95"></div>
                <div style="font-size:12px; color:var(--muted); letter-spacing:0.2px; text-transform:uppercase;">Conservative</div>
                <div id="scWorstProjected" style="font-weight:700; font-size:18px; margin-top:8px">-</div>
                <div id="scWorstNote" style="font-size:11px; color:var(--accent-amber, #ffb84d); margin-top:6px">-</div>
              </div>
            </div>
            <pre id="scenarioOutput" style="white-space:pre-wrap; font-family:monospace; margin:0; font-size:13px; max-height:260px; overflow:auto"></pre>
          </div>
        </div>
        <canvas id="scenarioChart" style="margin-top:10px; max-height:200px; width:100%;"></canvas>
        <!-- Schedule preview: populated from selected action option -->
        <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
          <label style="font-size:13px">Action options:</label>
          <select id="scActionSelect" style="padding:6px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text); min-width:320px">
            <option value="">(Run projection to load actions)</option>
          </select>
          <button class="btn" id="btnPopulateSchedule">Populate schedule</button>
          <button class="btn" id="btnCopySchedule">Copy schedule</button>
        </div>
  <div style="margin-top:10px; border:1px solid #2a2a30; border-radius:8px; padding:8px; background:#17171a;">
          <table id="scScheduleTable" style="width:100%; border-collapse:collapse;">
            <thead><tr style="background:#222224"><th style="padding:8px; text-align:left">Month</th><th style="padding:8px; text-align:right">Amount (AED)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <footer>
        <button class="btn close" id="btnScenarioClose2">Close</button>
      </footer>
    </div>
  </div>

  <!-- Email Settings Overlay -->
  <div class="overlay" id="emailOverlay" aria-hidden="true">
    <div class="pop" role="dialog" aria-modal="true" aria-labelledby="emailTitle">
      <header>
        <h3 id="emailTitle">Email Settings (EmailJS)</h3>
        <button class="btn close" id="btnEmailClose">Close</button>
      </header>
      <div class="content">
        <p>Configure EmailJS to send reminder emails. Get these from your <a href="https://www.emailjs.com/" target="_blank">EmailJS dashboard</a>.</p>
        <div style="display:flex; flex-direction:column; gap:8px;">
          <label>Service ID: <input id="emailServiceId" type="text" placeholder="e.g., service_xxx"></label>
          <label>Template ID: <input id="emailTemplateId" type="text" placeholder="e.g., template_xxx"></label>
          <label>Public Key: <input id="emailPublicKey" type="text" placeholder="e.g., xxx"></label>
          <label>Recipient Email: <input id="emailRecipient" type="email" placeholder="recipient@example.com"></label>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="btn" id="btnSaveEmailConfig">Save</button>
          <button class="btn" id="btnTestEmail">Test Email</button>
        </div>
      </div>
      <footer>
        <button class="btn close" id="btnEmailClose2">Close</button>
      </footer>
    </div>
  </div>

  <!-- Duplicate Owner Overlay -->
  <div class="overlay" id="duplicateOwnerOverlay" aria-hidden="true">
    <div class="pop" role="dialog" aria-modal="true" aria-labelledby="duplicateTitle">
      <header>
        <h3 id="duplicateTitle">Duplicate Owner Data</h3>
        <button class="btn close" id="btnDuplicateClose">Close</button>
      </header>
      <div class="content">
        <p>Copy all data (month data, reminders, notes, opening balance, etc.) from one owner/year to another.</p>
        <div style="display:flex; flex-direction:column; gap:8px;">
          <label>Source Owner: <input id="sourceOwner" type="text" placeholder="e.g., Owner 1"></label>
          <label>Source Year: <input id="sourceYear" type="number" placeholder="e.g., 2023"></label>
          <label>Target Owner: <input id="targetOwner" type="text" placeholder="e.g., Owner 2"></label>
          <label>Target Year: <input id="targetYear" type="number" placeholder="e.g., 2024"></label>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="btn" id="btnDuplicateData">Duplicate Data</button>
        </div>
      </div>
      <footer>
        <button class="btn close" id="btnDuplicateClose2">Close</button>
      </footer>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Chart.js for mini chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- html2canvas and jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
/* === JavaScript === */
window.addEventListener('DOMContentLoaded', () => {
    // === Constants and Utilities ===
    const fmt = n => (Number(n||0)).toLocaleString('en-AE');
  // Robust numeric parser: accept numbers or formatted strings like "3,000", "AED 3,000", "(1,200)", "-1,200"
  function parseNum(n){
    if(n === null || n === undefined) return 0;
    if(typeof n === 'number') return isNaN(n) ? 0 : n;
    let s = String(n).trim();
    if(s === '') return 0;
    // detect parentheses for negative values or negative sign
    let negative = false;
    if(s.startsWith('(') && s.endsWith(')')){
      negative = true;
      s = s.slice(1, -1);
    } else if(s.startsWith('-')){
      negative = true;
      s = s.slice(1);
    }
  // remove currency letters/symbols (accept 'AED'), commas and any non-numeric characters except dot and minus
  s = s.replace(/AED\s*/i, '');
    s = s.replace(/[^0-9.-]/g, '');
    if(s === '' || s === '.' || s === '-' ) return 0;
    const val = Number(s);
    if(isNaN(val)) return 0;
    return negative ? -val : val;
  }
  // Accounting formatter: localized number with negative sign for negatives
  function fmtAcc(n){
    const v = parseNum(n || 0);
    const rounded = Math.round(v);
    const abs = Math.abs(rounded);
    const s = abs.toLocaleString('en-AE');
    return rounded < 0 ? `-${s}` : s;
  }
  // Small compatibility helper used by some UI update paths
  function format(n){
    // preserve existing behavior: return a localized integer string
    return fmtAcc(n);
  }

  // Compute consolidated scenario results used by updateUI()
  function computeScenarios(){
    try{
      console.debug('computeScenarios: entered');
      const months = getMonthData();
      const vals = months.map(m=> Number(m.outflow||0));
      const targets = months.map(m=> Number(m.target||0));
      const totalTarget = targets.reduce((a,b)=>a+b,0);
      const YTD = vals.slice(0, currentMonthIdx+1).reduce((a,b)=>a+b,0);
      const OB = parseNum(dom('openingBalance')?.value || 0);
      const base = computeScenarioProjection('Base', 0);
      const best = computeScenarioProjection('Optimistic', 0);
      const worst = computeScenarioProjection('Conservative', 0);

      // moNeeded: distribute remaining target (if any) across remaining whole months
      const now = new Date();
      const endOfYear = new Date(Number(yearSel.value||now.getFullYear()), 11, 31, 23,59,59);
      const msInDay = 1000*60*60*24;
      const days_left = Math.max(0, Math.ceil((endOfYear - now)/msInDay));
      const months_left = Math.max(0.01, days_left / 30.44);
      const monthsToYearEnd = Math.max(1, Math.ceil(months_left));
      const remainingToTarget = totalTarget > 0 ? Math.max(0, totalTarget - YTD) : 0;
      const moNeeded = totalTarget > 0 ? Math.ceil(remainingToTarget / monthsToYearEnd) : 0;

      const result = {
        totalTarget,
        baseYE: base.expectedYearEnd,
        bestYE: best.expectedYearEnd,
        worstYE: worst.expectedYearEnd,
        moNeeded,
        YTD,
        OB
      };
      console.debug('computeScenarios: result', result);
      return result;
    }catch(e){ console.debug('computeScenarios failed', e); return { totalTarget:0, baseYE:0, bestYE:0, worstYE:0, moNeeded:0, YTD:0, OB:0 }; }
  }
  // Helper to set KPI value text and positive/negative classes
  // Display uses English 'AED' in a very small font before the amount and
  // places the negative sign after the amount (e.g. "AED 1,234 -").
  function setKpi(id, num){
    const el = dom(id);
    if(!el) return;
    // If value is numeric, format with currency label; otherwise show as-is
    if(typeof num === 'number' || !isNaN(parseNum(num))){
      const v = parseNum(num || 0);
      const absText = fmtAcc(Math.abs(v));
      // Small AED label (very fine small font) followed by the localized amount
      const currencyLabel = `<span style="font-size:10px; opacity:0.85; vertical-align:baseline; font-weight:600">AED</span>&nbsp;`;
      const amountHtml = `<span class="kpi-amount">${absText}</span>`;
      if(v < 0){
        // Format negative as: ( AED - 1,234 )
        el.innerHTML = `<span class="kpi-neg-wrap">( ${currencyLabel}<span style="margin-right:4px">-</span>${amountHtml} )</span>`;
      } else {
        el.innerHTML = `${currencyLabel}${amountHtml}`;
      }
      el.classList.remove('positive','negative');
      if(v > 0) el.classList.add('positive');
      else if(v < 0) el.classList.add('negative');
    } else {
      el.textContent = String(num);
    }
  }
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const shortMonth = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      try{
        const md = dom('monthDebug'); if(md){ md.textContent = localStorage.getItem(`${keyPrefix()}:monthData`) || 'no prefixed monthData'; }
      }catch(e){}
    const today = new Date();
    const currentMonthIdx = today.getMonth(); // 0-11
    const dom = id => document.getElementById(id);
    // Save current document as PDF using html2canvas + jsPDF
    async function saveAsPDF(){
      try{
        if(typeof html2canvas === 'undefined' || (typeof window.jspdf === 'undefined' && typeof window.jsPDF === 'undefined')){
          alert('PDF libraries not loaded (html2canvas / jsPDF). Please ensure internet access or include the libraries.');
          return;
        }

        // Prepare to replace external images/backgrounds so the canvas isn't tainted
        const replacedImgs = [];
        const replacedBgs = [];
        try{
          // Replace external <img> sources (non-data) with a 1x1 transparent PNG data URI
          const imgs = Array.from(document.querySelectorAll('img'));
          const transparent = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQImWNgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=';
          imgs.forEach(img => {
            try{
              const src = img.src || '';
              if(!src) return;
              if(src.startsWith('data:')) return; // already safe
              replacedImgs.push({ el: img, src: src, cross: img.getAttribute('crossorigin') });
              // set to transparent pixel to avoid cross-origin pixel data
              img.setAttribute('data-enbd-orig-src', src);
              img.setAttribute('data-enbd-orig-cross', String(img.getAttribute('crossorigin')|| ''));
              img.removeAttribute('crossorigin');
              img.src = transparent;
            }catch(e){}
          });

          // Remove background images (inline CSS) which may reference external resources
          const all = Array.from(document.querySelectorAll('*'));
          all.forEach(el => {
            try{
              const bg = window.getComputedStyle(el).backgroundImage;
              if(bg && bg !== 'none' && bg.indexOf('url(') !== -1){
                replacedBgs.push({ el: el, bg: el.style.backgroundImage });
                el.style.backgroundImage = 'none';
              }
            }catch(e){}
          });
        }catch(e){ console.debug('saveAsPDF: image/bg replacement failed', e); }

        // Hide floating UI elements so they don't appear in the capture
        const floatingEls = [];
        try{
          const riToggle = document.getElementById('rightIconToggle'); if(riToggle){ floatingEls.push(riToggle); riToggle.style.visibility = 'hidden'; }
          const riSet = document.getElementById('rightIconSet'); if(riSet){ floatingEls.push(riSet); riSet.style.visibility = 'hidden'; }
          const toasts = document.querySelectorAll('.toast, .rem-row .rem-actions, .iconbtn'); if(toasts) toasts.forEach(t=>{ floatingEls.push(t); t.style.visibility = 'hidden'; });
        }catch(e){ console.debug('saveAsPDF: could not hide floating elements', e); }

        // Allow a slightly longer delay so the browser repaints with the replaced images/styles
        await new Promise(r => setTimeout(r, 250));

        // Capture
        const canvas = await html2canvas(document.body, { scale: 2, useCORS: false, logging: false });
        const imgData = canvas.toDataURL('image/png'); // should not throw when images/backgrounds replaced

        // Restore visibility and replaced content
        try{ floatingEls.forEach(el=>{ if(el && el.style) el.style.visibility = ''; }); }catch(e){}
        try{
          replacedImgs.forEach(o=>{
            try{
              if(o && o.el){
                if(o.src) o.el.src = o.src;
                if(o.cross) o.el.setAttribute('crossorigin', o.cross);
                o.el.removeAttribute('data-enbd-orig-src'); o.el.removeAttribute('data-enbd-orig-cross');
              }
            }catch(e){}
          });
          replacedBgs.forEach(o=>{ try{ if(o && o.el) o.el.style.backgroundImage = o.bg || ''; }catch(e){} });
        }catch(e){ console.debug('saveAsPDF: restore failed', e); }

        // Build PDF
        let JSPDF = null;
        if(window.jspdf && window.jspdf.jsPDF) JSPDF = window.jspdf.jsPDF;
        else if(window.jsPDF) JSPDF = window.jsPDF;
        else if(typeof jspdf !== 'undefined' && jspdf.jsPDF) JSPDF = jspdf.jsPDF;
        if(!JSPDF){ alert('Could not find jsPDF constructor.'); return; }

        const pdf = new JSPDF({ unit: 'mm', format: 'a4' });
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        // compute image dimensions to fit page width while preserving aspect
        const canvasW = canvas.width;
        const canvasH = canvas.height;
        const imgWidthMm = pageWidth;
        const imgHeightMm = (canvasH * imgWidthMm) / canvasW;

        // Add first page
        let position = 0;
        pdf.addImage(imgData, 'PNG', 0, position, imgWidthMm, imgHeightMm);

        // Add extra pages if needed. We slice the image vertically by pageHeight.
        let heightLeft = imgHeightMm - pageHeight;
        while(heightLeft > -0.01){
          position = position - pageHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidthMm, imgHeightMm);
          heightLeft -= pageHeight;
        }

        pdf.save('ENBD_Performance_Tracker.pdf');
      }catch(err){ console.error('saveAsPDF error', err); alert('Save as PDF failed: ' + String(err)); }
    }
    function showPasswordOverlay() {
      dom('passwordOverlay').classList.add('show');
      dom('passwordOverlay').setAttribute('aria-hidden','false');
      dom('passwordInput').focus();
    }
    let isUnlocked = false; // track if password has been entered for data entry
    function showToast(message) {
      const toast = dom('toast');
      if (!toast) return;
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }
    function handleEnter(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const allInputs = Array.from(document.querySelectorAll('#monthTable tbody input'));
        const currentIndex = allInputs.indexOf(e.target);
        if (currentIndex !== -1 && currentIndex < allInputs.length - 1) {
          allInputs[currentIndex + 1].focus();
        }
      }
    }
    // === Data Management ===
    function keyPrefix(){
      const owner = dom('owner').value.trim();
      const year = dom('year').value.trim();
      return `enbd:${owner}:${year}`;
    }
    function save(key, val){ localStorage.setItem(`${keyPrefix()}:${key}`, JSON.stringify(val)); }
    function load(key, def){ try{ const v = JSON.parse(localStorage.getItem(`${keyPrefix()}:${key}`)); return (v===null||v===undefined)?def:v; }catch(_){ return def; } }

    // Owner / Year UI wiring
    const ownerSel = dom('owner');
    const yearSel = dom('year');
    const yearDataLabel = dom('yearDataLabel');
    ownerSel.addEventListener('change', ()=>{
      try{ persistContext(); /* keep full init for other UI */ initAll(); }catch(e){}
      try{ updateRemBadgeImmediate(); renderRems(); }catch(e){}
      try{ renderNotes(); }catch(e){}
    });
    yearSel.addEventListener('change', ()=>{
      try{ persistContext(); initAll(); }catch(e){}
      try{ updateRemBadgeImmediate(); renderRems(); }catch(e){}
      try{ renderNotes(); }catch(e){}
    });
    function persistContext(){
      localStorage.setItem('enbd:lastOwner', ownerSel.value);
      localStorage.setItem('enbd:lastYear', yearSel.value);
    }
    // Restore last
    (function(){ const lo=localStorage.getItem('enbd:lastOwner'); const ly=localStorage.getItem('enbd:lastYear'); if(lo) ownerSel.value = lo; if(ly) yearSel.value = ly; })();

    // Owners list persistence and editor (global per-browser list)
    const OWNERS_KEY = 'enbd:owners';
    function loadOwners(){ try{ const v = JSON.parse(localStorage.getItem(OWNERS_KEY)); if(Array.isArray(v) && v.length) return v; }catch(e){}
      // default owners
      const defs = []; for(let i=1;i<=10;i++) defs.push('Owner '+i); localStorage.setItem(OWNERS_KEY, JSON.stringify(defs)); return defs; }
    function saveOwners(arr){ try{ localStorage.setItem(OWNERS_KEY, JSON.stringify(arr||[])); }catch(e){} }
    // keys to migrate when an owner name changes (per-year keys)
    const PER_OWNER_KEYS = ['monthData','openingBalance','scenarioMultipliers','lastScenario','reminders'];
    function migrateOwnerData(oldName, newName, year){
      if(!oldName || !newName || oldName===newName) return;
      try{
        for(const k of PER_OWNER_KEYS){
          const oldKey = `enbd:${oldName}:${year}:${k}`;
          const newKey = `enbd:${newName}:${year}:${k}`;
          const v = localStorage.getItem(oldKey);
          if(v !== null && localStorage.getItem(newKey) === null){
            localStorage.setItem(newKey, v);
            localStorage.removeItem(oldKey);
          }
        }
      }catch(e){ /* ignore migration errors */ }
    }
    function populateOwnerSelect(){
      const list = loadOwners();
      if(!ownerSel) return;
      ownerSel.innerHTML = '';
      for(const o of list){ const opt = document.createElement('option'); opt.textContent = o; opt.value = o; ownerSel.appendChild(opt); }
      // restore last selected owner if present
      const last = localStorage.getItem('enbd:lastOwner'); if(last) ownerSel.value = last; }

    // Owners editor overlay wiring
    const ownersOverlay = dom('ownersOverlay');
    dom('btnEditOwners')?.addEventListener('click', ()=>{ renderOwnersEditor(); ownersOverlay.classList.add('show'); ownersOverlay.setAttribute('aria-hidden','false'); });
    dom('btnOwnersClose')?.addEventListener('click', ()=>{ ownersOverlay.classList.remove('show'); ownersOverlay.setAttribute('aria-hidden','true'); });
    dom('btnOwnersClose2')?.addEventListener('click', ()=>{ ownersOverlay.classList.remove('show'); ownersOverlay.setAttribute('aria-hidden','true'); });

    function renderOwnersEditor(){
      const container = dom('ownersList'); if(!container) return; container.innerHTML = '';
      const list = loadOwners();
      list.forEach((name, idx)=>{
        const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center';
        const inp = document.createElement('input'); inp.type='text'; inp.value = name; inp.style.flex='1';
        const btnDel = document.createElement('button'); btnDel.className='btn'; btnDel.textContent='Remove';
        btnDel.addEventListener('click', ()=>{ list.splice(idx,1); saveOwners(list); renderOwnersEditor(); populateOwnerSelect(); });
        row.append(inp, btnDel);
        container.appendChild(row);
        inp.addEventListener('input', ()=>{ list[idx] = inp.value; });
      });
      // add handler for Add Owner button
      const btnAdd = dom('btnAddOwner'); if(btnAdd){ btnAdd.onclick = ()=>{ const list2 = loadOwners(); list2.push('New Owner'); saveOwners(list2); renderOwnersEditor(); populateOwnerSelect(); }; }
      const btnSave = dom('btnSaveOwners'); if(btnSave){ btnSave.onclick = ()=>{
        // collect current input values from the ownersList container and persist
        const inputs = Array.from(container.querySelectorAll('input')).map(i=> String(i.value||'').trim()).filter(x=> x.length>0);
        if(inputs.length===0){ alert('No owners to save'); return; }
        // perform migration: compare previous stored owners with new inputs and move per-owner/year data
        const prev = loadOwners();
        const year = (dom('year')||{value: new Date().getFullYear()}).value;
        for(let i=0;i<Math.max(prev.length, inputs.length); i++){
          const oldName = prev[i];
          const newName = inputs[i];
          if(oldName && newName && oldName !== newName){
            migrateOwnerData(oldName, newName, year);
          }
        }
        saveOwners(inputs);
        populateOwnerSelect();
        alert('Owners saved (migrated data where names changed)');
      }; }
    }

    // populate owner select immediately
    populateOwnerSelect();

  // KPI dock removed per user request.

  // Year target is stored in localStorage under 'yearTarget'. The small input was removed.

    // Opening balance persist
    const openingBalanceInput = dom('openingBalance');
    function persistOpeningBalance(){
      if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; }
      try{ save('openingBalance', Number(openingBalanceInput.value.replace(/,/g,'')||0)); }catch(e){/*ignore*/}
      try{ localStorage.setItem(`${keyPrefix()}:openingBalance`, JSON.stringify(Number(openingBalanceInput.value.replace(/,/g,'')||0))); }catch(e){}
      recompute();
      showToast('Opening balance saved');
    }
    openingBalanceInput.addEventListener('input', persistOpeningBalance);
    openingBalanceInput.addEventListener('change', persistOpeningBalance);
    openingBalanceInput.addEventListener('focus', () => {
      if (openingBalanceInput.value === "Nil") {
        openingBalanceInput.value = "0";
        openingBalanceInput.style.color = "#FFD700";
      }
    });
    openingBalanceInput.addEventListener('blur', () => {
      const num = parseNum(openingBalanceInput.value);
      if (num === 0) {
        openingBalanceInput.value = "Nil";
        openingBalanceInput.style.color = "blue";
      } else {
        openingBalanceInput.value = num.toLocaleString('en-AE');
        openingBalanceInput.style.color = "#FFD700";
      }
    });
  // restore opening balance (raw number for numeric input)
  (function(){ const ob = Number(load('openingBalance', 0)); openingBalanceInput.value = ob === 0 ? "Nil" : String(ob); openingBalanceInput.style.color = ob === 0 ? "blue" : "#FFD700"; })();

    // Reset page
    function resetPage(){
      if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; }
      if(!confirm('This will clear saved month data, reminders and opening balance for the current Owner & Year. Continue?')) return;
      try{
        localStorage.removeItem(`${keyPrefix()}:monthData`);
        localStorage.removeItem(`${keyPrefix()}:reminders`);
        localStorage.removeItem(`${keyPrefix()}:openingBalance`);
      }catch(e){}
      // reload defaults
      initAll();
    }
    dom('btnReset').addEventListener('click', resetPage);

    // Refresh page button ‚Äî reload immediately without confirmation
    dom('btnRefresh').addEventListener('click', () => {
      // Temporarily bypass password gating so refresh does not show the password overlay
      const priorUnlocked = isUnlocked;
      try{
        isUnlocked = true;
        // Save any transient edits where possible (best-effort)
        const months = getMonthData();
        try{ saveMonthData(months); }catch(e){}
        try{ save('openingBalance', Number(dom('openingBalance').value.replace(/,/g,'')||0)); }catch(e){}
      }catch(e){}
      finally{
        // restore previous lock state (page will reload immediately)
        try{ isUnlocked = priorUnlocked; }catch(e){}
      }
      window.location.reload();
    });

    // Export/Import Data
    dom('btnExport').addEventListener('click', exportData);
    dom('btnImport').addEventListener('click', () => dom('importFile').click());
    dom('importFile').addEventListener('change', importData);

    function exportData(){
      if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; }
      try {
        const wb = XLSX.utils.book_new();

        // Sanitize data: ensure no nulls, undefined, or invalid types, and clean strings
        const months = getMonthData();
        const monthData = months.map((m, i) => ({
          Month: monthNames[i] || '',
          Day: String(m.day || '').replace(/[\x00-\x1F\x7F-\x9F]/g, '').replace(/[^\w\s\-.,]/g, '').substring(0, 50), // Clean and limit length
          Target: (() => { let n = Number(m.target || 0); return isNaN(n) || !isFinite(n) ? 0 : n; })(),
          Note: String(m.note || '').replace(/[\x00-\x1F\x7F-\x9F]/g, '').replace(/[^\w\s\-.,]/g, '').substring(0, 200), // Clean and limit length
          'Bank Inflow': (() => { let n = Number(m.outflow || 0); return isNaN(n) || !isFinite(n) ? 0 : n; })(),
          Variance: (() => { let n = Number(m.variance || 0); return isNaN(n) || !isFinite(n) ? 0 : n; })(),
          Balance: (() => { let n = Number(m.balance || 0); return isNaN(n) || !isFinite(n) ? 0 : n; })()
        }));

        const wsMonth = XLSX.utils.json_to_sheet(monthData);
        XLSX.utils.book_append_sheet(wb, wsMonth, 'MonthData');

        // Reminders sheet - sanitize all data
        const rems = getRems();
        const remData = rems.map(r => ({
          Date: (() => { try { const d = new Date(r.when); if (isNaN(d.getTime())) throw new Error(); return d.toLocaleDateString('en-GB'); } catch { return ''; } })(),
          Amount: (() => { let n = Number(r.amount || 0); return isNaN(n) || !isFinite(n) ? 0 : n; })(),
          Label: String(r.label || '').replace(/[\x00-\x1F\x7F-\x9F]/g, '').replace(/[^\w\s\-.,]/g, '').substring(0, 100), // Clean and limit
          Done: r.done ? 'Yes' : 'No'
        }));
        const wsRem = XLSX.utils.json_to_sheet(remData);
        XLSX.utils.book_append_sheet(wb, wsRem, 'Reminders');

        // Settings sheet - sanitize all values
        const settings = [
          { Key: 'Owner', Value: String(ownerSel.value || '').replace(/[\x00-\x1F\x7F-\x9F]/g, '').replace(/[^\w\s\-.,]/g, '').substring(0, 50) },
          { Key: 'Year', Value: String(yearSel.value || '').replace(/[\x00-\x1F\x7F-\x9F]/g, '').replace(/[^\w\s\-.,]/g, '').substring(0, 10) },
          { Key: 'Opening Balance', Value: (() => { let n = Number(dom('openingBalance').value.replace(/,/g,'') || 0); return isNaN(n) || !isFinite(n) ? 0 : n; })() },
          { Key: 'Scenario Multipliers', Value: (() => { try { return JSON.stringify(load('scenarioMultipliers', {mulC:0.8, mulB:1, mulO:1.25})); } catch { return '{}'; } })() },
          { Key: 'Last Scenario', Value: (() => { try { return JSON.stringify(load('lastScenario', null)); } catch { return 'null'; } })() }
        ];
        const wsSettings = XLSX.utils.json_to_sheet(settings);
        XLSX.utils.book_append_sheet(wb, wsSettings, 'Settings');

        // Sanitize filename to remove problematic characters
        const cleanOwner = String(ownerSel.value || 'Owner').trim().replace(/[^\w\-]/g, '_').substring(0, 20);
        const cleanYear = String(yearSel.value || 'Year').trim().replace(/[^\w\-]/g, '_').substring(0, 10);
        const filename = `enbd-data-${cleanOwner}-${cleanYear}.xlsx`;

        // Hardened export: use Blob to avoid corruption
        try {
          const wbout = XLSX.write(wb, { type: 'array', bookType: 'xlsx' });
          const blob = new Blob([wbout], { type: 'application/octet-stream' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showToast('Data exported successfully');
        } catch (blobErr) {
          console.warn('Blob export failed, falling back to XLSX.writeFile', blobErr);
          try {
            XLSX.writeFile(wb, filename);
            showToast('Data exported (fallback method)');
          } catch (writeErr) {
            console.error('XLSX.writeFile also failed', writeErr);
            // Final fallback: CSV export
            const csvData = XLSX.utils.sheet_to_csv(wsMonth);
            const csvBlob = new Blob([csvData], { type: 'text/csv' });
            const csvUrl = URL.createObjectURL(csvBlob);
            const csvA = document.createElement('a');
            csvA.href = csvUrl;
            csvA.download = filename.replace('.xlsx', '.csv');
            document.body.appendChild(csvA);
            csvA.click();
            document.body.removeChild(csvA);
            URL.revokeObjectURL(csvUrl);
            showToast('Exported as CSV (Excel export failed)');
          }
        }
      } catch (err) {
        console.error('Export failed completely', err);
        try { localStorage.setItem('enbd:lastExportError', String(err) + ' at ' + new Date().toISOString()); } catch(e) {}
        alert('Export failed: ' + String(err));
      }
    }

    function exportDataCSV(){
      try {
        const months = getMonthData();
        const monthData = months.map((m, i) => ({
          Month: monthNames[i] || '',
          Day: String(m.day || '').trim(),
          Target: Number(m.target || 0),
          Note: String(m.note || '').trim(),
          'Bank Inflow': Number(m.outflow || 0),
          Variance: Number(m.variance || 0),
          Balance: Number(m.balance || 0)
        }));

        const csvRows = [];
        csvRows.push(Object.keys(monthData[0]).join(','));
        monthData.forEach(row => {
          csvRows.push(Object.values(row).map(v => `"${String(v).replace(/"/g, '""')}"`).join(','));
        });

        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `enbd-data-${String(ownerSel.value || 'Owner').trim()}-${String(yearSel.value || 'Year').trim()}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('Data exported as CSV');
      } catch (err) {
        console.error('CSV export failed', err);
        alert('CSV export failed: ' + String(err));
      }
    }

    // Inject floating CSV export button on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function(){
      const btn = document.createElement('button');
      btn.id = 'btnExportCsvSafe';
      btn.textContent = 'Export CSV (safe)';
      btn.style.cssText = 'position:fixed; bottom:20px; right:20px; z-index:1000; background:#007acc; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; font-size:12px;';
      btn.onclick = exportDataCSV;
      document.body.appendChild(btn);
    });

    function importData(event){
      if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; }
      const file = event.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e){
        try{
          let data;
          if(file.name.endsWith('.json')){
            data = JSON.parse(e.target.result);
          } else {
            // Excel
            const wb = XLSX.read(e.target.result, {type: 'array'});
            data = parseExcel(wb);
          }
          // Validate
          if(!data.owner || !data.year) throw new Error('Invalid data format');
          // Set owner and year
          ownerSel.value = data.owner;
          yearSel.value = data.year;
          persistContext();
          // Set data
          if(data.monthData) save('monthData', data.monthData);
          if(data.openingBalance !== undefined){
            // Opening balance is a numeric input; assign plain numeric string so the input accepts it.
            dom('openingBalance').value = String(Number(data.openingBalance || 0));
            save('openingBalance', Number(data.openingBalance || 0));
          }
          if(data.reminders) setRems(data.reminders);
          if(data.scenarioMultipliers) save('scenarioMultipliers', data.scenarioMultipliers);
          if(data.lastScenario) save('lastScenario', data.lastScenario);
          initAll();
          alert('Data imported successfully');
        }catch(err){
          alert('Error importing data: ' + err.message);
        }
      };
      if(file.name.endsWith('.json')){
        reader.readAsText(file);
      } else {
        reader.readAsArrayBuffer(file);
      }
    }

    function parseExcel(wb){
      const data = {};
      // Settings
      const wsSettings = wb.Sheets['Settings'];
      if(wsSettings){
        const settings = XLSX.utils.sheet_to_json(wsSettings);
        settings.forEach(s => {
          if(s.Key === 'Owner') data.owner = s.Value;
          else if(s.Key === 'Year') data.year = s.Value;
          else if(s.Key === 'Opening Balance') data.openingBalance = Number(s.Value || 0);
          else if(s.Key === 'Scenario Multipliers') data.scenarioMultipliers = JSON.parse(s.Value || '{}');
          else if(s.Key === 'Last Scenario') data.lastScenario = JSON.parse(s.Value || '{}');
        });
      }
      // MonthData
      const wsMonth = wb.Sheets['MonthData'];
      if(wsMonth){
        const monthData = XLSX.utils.sheet_to_json(wsMonth);
        data.monthData = monthData.map((row, i) => ({
          day: row.Day || '',
          target: Number(row.Target || 0),
          note: row.Note || '',
          outflow: Number(row['Bank Inflow'] || 0),
          variance: Number(row.Variance || 0),
          balance: Number(row.Balance || 0)
        }));
      }
      // Reminders
      const wsRem = wb.Sheets['Reminders'];
      if(wsRem){
        const remData = XLSX.utils.sheet_to_json(wsRem);
        data.reminders = remData.map(row => ({
          id: 'r' + Date.now() + Math.random(),
          when: new Date(row.Date).toISOString(),
          amount: Number(row.Amount || 0),
          label: row.Label || '',
          done: row.Done === 'Yes'
        }));
      }
      return data;
    }

    // Theme toggle removed ‚Äî app will use default styles only

    // Table (7 columns)
    const tbody = document.querySelector('#monthTable tbody');
    // Data migration helper - older versions stored plain numeric keys m1..m12. New format stores per-month object under key 'monthData' as array.
    function migrateLegacyMonths(){
      const months = [];
      const legacyFound = (()=>{ for(let i=1;i<=12;i++){ if(localStorage.getItem(`${keyPrefix()}:m${i}`)!==null) return true; } return false; })();
      if(legacyFound){
        for(let i=1;i<=12;i++){
          const v = Number(localStorage.getItem(`${keyPrefix()}:m${i}`) || 0);
          months.push({ day:'', target: Number(load('yearTarget', 0))/12, note:'', outflow: v, variance:0, balance:0 });
          // remove legacy key (keep if you prefer migration only)
          try{ localStorage.removeItem(`${keyPrefix()}:m${i}`); }catch(e){}
        }
        save('monthData', months);
      }
    }

    function getMonthData(){
      // Prefer the helper load for current owner/year
      const pref = load('monthData', null);
      if(Array.isArray(pref)){
        console.debug('getMonthData: loaded via prefixed key', `${keyPrefix()}:monthData`, 'count', pref.length);
        return pref;
      }
      // Fallback: look for any existing monthData under any ':monthData' key
      try{
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if(k && k.endsWith(':monthData')){
            try{
              const parsed = JSON.parse(localStorage.getItem(k));
              if(Array.isArray(parsed)){
                // migrate into current prefixed key for current owner/year
                save('monthData', parsed);
                console.debug('getMonthData: migrated from found key', k, 'to', `${keyPrefix()}:monthData`);
                return parsed;
              }
            }catch(e){}
          }
        }
      }catch(e){}
      // default build
      const def = [];
      for(let i=0;i<12;i++) def.push({ day:'', target: Number(load('yearTarget', 0))/12, note:'', outflow:0, variance:0, balance:0 });
      save('monthData', def); return def;
    }

    // Harden saving with explicit prefixed key write + debug to avoid silent failures
    function saveMonthData(arr){
      try{
        // prefer existing save helper (keeps behavior consistent)
        save('monthData', arr);
      }catch(e){ console.debug('saveMonthData: save() helper failed', e); }
      try{
        const k = `${keyPrefix()}:monthData`;
        localStorage.setItem(k, JSON.stringify(arr));
        console.debug('saveMonthData: wrote', k, 'items', Array.isArray(arr)?arr.length:0);
        try{
          // maintain an undo stack (persisted per owner/year)
          const stackKey = `${keyPrefix()}:undoStack`;
          const maxSize = 20;
          let stack = [];
          try{ stack = JSON.parse(localStorage.getItem(stackKey)) || []; }catch(e){ stack = []; }
          // push current snapshot (timestamp + monthData)
          stack.push({ t: Date.now(), monthData: arr });
          if(stack.length > maxSize) stack = stack.slice(stack.length - maxSize);
          localStorage.setItem(stackKey, JSON.stringify(stack));
          console.debug('saveMonthData: pushed undo snapshot, stack size', stack.length);
        }catch(e){ console.debug('saveMonthData: undo push failed', e); }
      }catch(e){ console.debug('saveMonthData: direct write failed', e); }
    }

  // Debounce helper to batch rapid input events
  function debounce(fn, wait=300){ let t; return function(...a){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait); }; }
  // Debounced save + recompute + auxiliary updates used by table inputs
  const debouncedSaveAndRecompute = debounce((months)=>{ try{ saveMonthData(months); recompute(); drawChart(); buildShareText(); }catch(e){ console.debug('debouncedSaveAndRecompute failed', e); } }, 360);

  // Currency input normalizer: on focus show raw digits, on blur format with locale grouping
  function normalizeCurrencyInput(el){
    if(!el) return;
    el.addEventListener('focus', ()=>{
      try{
        const clean = String(el.value||'').replace(/^\s*AED\s*/i,'').replace(/[^0-9.-]/g,'');
        el.value = clean;
      }catch(e){}
    });
    el.addEventListener('blur', ()=>{
      try{
        const clean = String(el.value||'').replace(/^\s*AED\s*/i,'').replace(/[^0-9.-]/g,'');
        const num = Number(clean || 0);
        el.value = (clean && !isNaN(num)) ? num.toLocaleString('en-AE') : '';
      }catch(e){}
    });
  }

  // --- Undo stack helpers ---
  function getUndoStack(){ try{ const k = `${keyPrefix()}:undoStack`; const raw = localStorage.getItem(k); return raw ? JSON.parse(raw) : []; }catch(e){ return []; } }
  function setUndoStack(stack){ try{ const k = `${keyPrefix()}:undoStack`; localStorage.setItem(k, JSON.stringify(stack)); }catch(e){} }
  function undoLast(){ try{
      const stack = getUndoStack(); if(!stack || !stack.length){ showToast && showToast('Nothing to undo'); return; }
      const last = stack.pop(); setUndoStack(stack);
      if(last && last.monthData){ save('monthData', last.monthData); saveMonthData(last.monthData); buildTable(); recompute(); drawChart(); buildShareText(); showToast('Undo applied'); }
    }catch(e){ console.debug('undoLast failed', e); showToast && showToast('Undo failed'); } }

  // Wire Undo button
  const btnUndo = dom('btnUndo'); if(btnUndo){ btnUndo.addEventListener('click', ()=>{ if(!confirm('Undo last change?')) return; undoLast(); }); }

    // === UI Functions ===
    function buildTable(){
      migrateLegacyMonths();
      const months = getMonthData();
      tbody.innerHTML = '';
      for(let m=0;m<12;m++){
  const data = months[m] || { day:'', target:0, note:'', outflow:0, variance:0, balance:0 };
        const tr = document.createElement('tr');
        // Month name
        const tdM = document.createElement('td'); tdM.textContent = shortMonth[m];
        // Day
  const tdDay = document.createElement('td');
  // allow manual entry of up to 2 comma-separated days
  const inDay = document.createElement('input'); inDay.type='text'; inDay.value = data.day || ''; inDay.style.fontSize = 'calc(9px * 1.21)'; inDay.id = `month-day-${m}`; inDay.setAttribute('aria-label', `Day for ${shortMonth[m]}`);
  inDay.addEventListener('input', ()=>{ if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; } data.day = String(inDay.value||'').trim(); debouncedSaveAndRecompute(months); });
  inDay.addEventListener('change', ()=>{ if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; } data.day = String(inDay.value||'').trim(); saveMonthData(months); });
  inDay.addEventListener('keydown', handleEnter);
        tdDay.appendChild(inDay);
        // Target
        const tdT = document.createElement('td');
  const inT = document.createElement('input'); inT.type='text'; inT.value = (function(v){ if(typeof v==='string') v = v.replace(/^\s*AED\s*/i,''); const num = Number(v||0); return num ? num.toLocaleString('en-AE') : '' })(data.target); inT.id = `month-target-${m}`; inT.setAttribute('aria-label', `Target for ${shortMonth[m]}`);
  inT.addEventListener('input', ()=>{ const clean = String(inT.value||'').replace(/^\s*AED\s*/i,'').replace(/,/g,''); data.target = Number(clean||0); debouncedSaveAndRecompute(months); });
  inT.addEventListener('change', ()=>{ if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; } const clean = String(inT.value||'').replace(/^\s*AED\s*/i,'').replace(/,/g,''); data.target = Number(clean||0); saveMonthData(months); recompute(); buildShareText(); showToast('Data saved'); });
  inT.addEventListener('keydown', handleEnter);
  normalizeCurrencyInput(inT);
  tdT.appendChild(inT);
  // Note: keep the hidden inline input for programmatic access, but remove preview and note button (popup trigger removed)
    const tdN = document.createElement('td');
  const inN = document.createElement('input'); inN.type='text'; inN.value = data.note || ''; inN.id = `month-note-${m}`; inN.setAttribute('placeholder', 'Note'); inN.setAttribute('aria-label', `Note for ${shortMonth[m]}`);
  // Note: make the inline input visible in the table cell
    // Removed hiding styles to revive the note column
    inN.addEventListener('input', ()=>{ if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; } data.note = inN.value; debouncedSaveAndRecompute(months); });
    inN.addEventListener('change', ()=>{ if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; } data.note = inN.value; saveMonthData(months); });
    inN.addEventListener('keydown', handleEnter);
    tdN.appendChild(inN);
  // Bank Inflow (internal key: outflow)
        const tdO = document.createElement('td');
  const inO = document.createElement('input'); inO.type='text'; inO.value = (function(v){ if(typeof v==='string') v = v.replace(/^\s*AED\s*/i,''); const num = Number(v||0); return num ? num.toLocaleString('en-AE') : '' })(data.outflow); inO.id = `month-inflow-${m}`; inO.setAttribute('aria-label', `Bank inflow for ${shortMonth[m]}`);
  inO.addEventListener('input', ()=>{ const clean = String(inO.value||'').replace(/^\s*AED\s*/i,'').replace(/,/g,''); data.outflow = Number(clean||0); debouncedSaveAndRecompute(months); });
  inO.addEventListener('change', ()=>{ if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; } const clean = String(inO.value||'').replace(/^\s*AED\s*/i,'').replace(/,/g,''); data.outflow = Number(clean||0); saveMonthData(months); recompute(); drawChart(); buildShareText(); showToast('Data saved'); });
  inO.addEventListener('keydown', handleEnter);
  normalizeCurrencyInput(inO);
  tdO.appendChild(inO);
  // Variance (computed)
  const tdV = document.createElement('td'); tdV.textContent = data.variance!=null? fmtAcc(data.variance) : fmtAcc(0);
  // Balance (computed)
  const tdB = document.createElement('td'); tdB.textContent = data.balance!=null? fmtAcc(data.balance) : fmtAcc(0);

  tr.appendChild(tdDay);
  tr.appendChild(tdM);
  tr.appendChild(tdT);
  tr.appendChild(tdN);
  tr.appendChild(tdO);
  tr.appendChild(tdV);
  tr.appendChild(tdB);
        tbody.appendChild(tr);
      }
  // totals are handled by the persistent <tfoot> ‚Äî recompute() will update those cells
    }

          // --- Month Note Popup Overlay ---
          /*
            Usage & notes:
            - Opens when the user clicks any month note input with id `month-note-<N>` (0-11).
            - Overlay element id: `monthNoteOverlay`.
            - Fields inside overlay: date -> `mnoDate`, note -> `mnoNote`.
            - Save button id: `mnoSave`. Close/Cancel: `mnoClose`, `mnoCancel`.
            - On Save: writes back `months[monthIndex].day` (single day-of-month) and `months[monthIndex].note`, then calls
              `saveMonthData(months)`, updates table inputs if present (`month-day-<N>`, `month-note-<N>`), and triggers
              `recompute()`, `drawChart()`, `buildShareText()` so KPIs/charts/share-text refresh.
            - Minimal font sizes used (~11px). No brackets in labels. Respects password lock (calls `showPasswordOverlay()` if locked).
            - Edge: If you used comma-separated multiple days, the overlay will pre-fill using the first value and will overwrite
              the field with a single day if saved. If you want multi-day preservation, I can change this behavior.
          */
          // Minimal popup to edit a month's day and note with a small calendar/date input.
          (function(){
            // inject overlay HTML into document body when DOM is ready
            function createMonthNoteOverlay(){
              if(dom('monthNoteOverlay')) return; // already present
              const html = `\
              <div id="monthNoteOverlay" class="overlay hidden" aria-hidden="true">\
                <div class="overlay-panel">\
                  <div class="overlay-header">\
                    <strong id="mnoTitle" style="font-size:11px;">Month Note</strong>\
                    <button id="mnoClose" class="btn small">Close</button>\
                  </div>\
                  <div class="overlay-body" style="font-size:11px;">\
                    <label style="display:block;margin-bottom:6px;">Date<span style="margin-left:6px;color:var(--accent-amber,#ffb84d)"></span></label>\
                    <input type="date" id="mnoDate" style="width:100%;font-size:12px;padding:6px;margin-bottom:8px;" />\
                    <label style="display:block;margin-bottom:6px;">Note</label>\
                    <textarea id="mnoNote" rows="4" style="width:100%;font-size:12px;padding:6px;resize:vertical;" placeholder="Small note..."></textarea>\
                    <div style="margin-top:8px;text-align:right;">\
                      <button id="mnoClearNote" class="btn small">Clear Note</button>\
                      <button id="mnoReviseDate" class="btn small">Revise Date</button>\
                      <button id="mnoSave" class="btn primary small">Save</button>\
                      <button id="mnoCancel" class="btn small">Cancel</button>\
                    </div>\
                  </div>\
                </div>\
              </div>`;
              const wrap = document.createElement('div'); wrap.innerHTML = html;
              document.body.appendChild(wrap.firstElementChild);

              // Auto-expand textarea on input
              const noteTextarea = dom('mnoNote');
              if(noteTextarea){
                noteTextarea.addEventListener('input', function() {
                  this.style.height = 'auto';
                  this.style.height = this.scrollHeight + 'px';
                });
              }

              // minimal styles appended to head (scoped)
              const style = document.createElement('style'); style.id='monthNoteOverlayStyles';
  style.textContent = `\
    #monthNoteOverlay.overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.28); display:flex; align-items:center; justify-content:center; z-index:1200; }\
    #monthNoteOverlay.hidden{ display:none; }\
    /* Use page card background for visual consistency */\
  #monthNoteOverlay .overlay-panel{ background: #000000; padding:14px; border-radius:10px; width:360px; box-shadow:0 12px 40px rgba(0,0,0,0.6); font-family:inherit; border:1px solid rgba(255,255,255,0.06); color: #ffffff; position:relative; }\
  /* subtle left accent using main accent color if available */\
  #monthNoteOverlay .overlay-panel::before{ content:''; position:absolute; left:0; top:0; bottom:0; width:6px; border-top-left-radius:10px; border-bottom-left-radius:10px; background: linear-gradient(180deg, var(--accent,#0b7a8a), var(--accent-amber,#ffb84d)); box-shadow:inset 0 0 8px rgba(0,0,0,0.03); }
  #monthNoteOverlay .overlay-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }\
  #monthNoteOverlay .overlay-body{ font-size:12px; color: #ffffff; }\
  #monthNoteOverlay .btn.small{ font-size:12px; padding:6px 10px; margin-left:8px; background: transparent; color: #ff8c00; border: none; border-radius: 4px; }\
  #monthNoteOverlay .btn.primary.small{ background: transparent; color: #ff8c00; border: none; border-radius: 4px; }\
  #monthNoteOverlay .btn.primary.small:hover{ background: rgba(255,140,0,0.06); }\
  #monthNoteOverlay .btn.small:hover{ background: rgba(255,255,255,0.03); }\
  #monthNoteOverlay label{ color: #ffffff; font-weight:600; font-size:12px; }\
  #monthNoteOverlay input[type=date], #monthNoteOverlay textarea{ border:1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.06); color: #ffffff; padding:6px; border-radius:4px; }\
  #monthNoteOverlay textarea::-webkit-scrollbar { display: none; }\
  #monthNoteOverlay textarea { scrollbar-width: none; }\
    /* Make the note button icon red to improve visibility */\
    .note-btn{ background:transparent;border:1px solid rgba(197,48,48,0.12); border-radius:4px; color:#c53030; }\
    .note-btn:hover{ background:rgba(197,48,48,0.04); }
        `;
              document.head.appendChild(style);

              // wiring
              const ov = dom('monthNoteOverlay');
              const btnClose = dom('mnoClose');
              const btnCancel = dom('mnoCancel');
              const btnSave = dom('mnoSave');
              const btnClearNote = dom('mnoClearNote');
              const btnReviseDate = dom('mnoReviseDate');
              btnClose && btnClose.addEventListener('click', ()=>{ closeOverlay(); });
              btnCancel && btnCancel.addEventListener('click', ()=>{ closeOverlay(); });
              btnClearNote && btnClearNote.addEventListener('click', ()=>{ dom('mnoNote').value = ''; });
              btnReviseDate && btnReviseDate.addEventListener('click', ()=>{ const today = new Date().toISOString().slice(0,10); dom('mnoDate').value = today; });

              function closeOverlay(){ if(ov) { ov.classList.add('hidden'); ov.setAttribute('aria-hidden','true'); } }

              // save handler will be set dynamically by openOverlay
              btnSave.addEventListener('click', ()=>{
                try{ if(!ov._onSave) return; ov._onSave(); closeOverlay(); }catch(e){ console.debug('monthNote save failed', e); showToast && showToast('Save failed'); }
              });

              // close on Esc and restore focus
              document.addEventListener('keydown', function onDocKey(e){ if(e.key === 'Escape'){ if(dom('monthNoteOverlay') && !dom('monthNoteOverlay').classList.contains('hidden')){ closeOverlay(); } } });
            }

            function openMonthNoteOverlay(monthIndex, months){
              createMonthNoteOverlay();
              const ov = dom('monthNoteOverlay');
              const title = dom('mnoTitle');
              const dateInput = dom('mnoDate');
              const noteInput = dom('mnoNote');
              const saveBtn = dom('mnoSave');
              if(!ov || !dateInput || !noteInput) return;
              const short = shortMonth[monthIndex] || ('Month '+(monthIndex+1));
              title.textContent = short + ' Note';
              // populate
              const m = months[monthIndex] || { day:'', note:'' };
              // day may contain comma-separated days; pick first for date if present and parseable as day-of-month for current year/month
              const dayStr = String(m.day||'').split(',')[0].trim();
              if(dayStr){
                // try construct a date for the current selected year and this month
                const y = Number(yearSel.value) || new Date().getFullYear();
                const mm = monthIndex; // 0-based
                const dnum = Number(dayStr);
                if(dnum && dnum>=1 && dnum<=31){
                  const dt = new Date(y, mm, dnum);
                  const iso = dt.toISOString().slice(0,10);
                  dateInput.value = iso;
                } else { dateInput.value = ''; }
              } else { dateInput.value = ''; }
        noteInput.value = m.note || '';
              // set onSave callback on overlay element
              ov._onSave = function(){
                try{
                  // push undo snapshot of months (shallow copy) before changes
                  try{ const snap = JSON.parse(JSON.stringify(months)); pushUndoSnapshot(snap); }catch(e){ /*ignore*/ }
                }catch(e){}
                // write back to months array: set day to day-of-month from dateInput (if any) and note
                const iso = dateInput.value;
                // if user changed date, update day; otherwise preserve existing day (including comma-separated)
                if(iso){ try{ const dt = new Date(iso); const d = dt.getDate(); months[monthIndex].day = String(d); }catch(e){} };
                months[monthIndex].note = noteInput.value || '';
                // persist
                saveMonthData(months);
                // update table inputs if present
                const noteEl = dom('month-note-'+monthIndex); if(noteEl) noteEl.value = months[monthIndex].note || '';
                // update preview span
                const td = noteEl ? noteEl.parentElement : null; if(td){ const spans = td.querySelectorAll('span'); if(spans[0]){ spans[0].textContent = (months[monthIndex].note || '').substring(0,20) + ((months[monthIndex].note || '').length > 20 ? '...' : ''); } }
                const dayEl = dom('month-day-'+monthIndex); if(dayEl) dayEl.value = months[monthIndex].day || '';
                // recompute / redraw
                try{ recompute(); drawChart(); buildShareText(); }catch(e){ console.debug('post-save updates failed', e); }
                // restore focus to originating element if available
                try{ const origin = ov._originEl; if(origin && typeof origin.focus === 'function') origin.focus(); }catch(e){}
                showToast && showToast('Month note saved');
              };
              ov.classList.remove('hidden'); ov.setAttribute('aria-hidden','false');
              // focus the note input to make the popup immediately usable
              try{ noteInput.focus(); if(noteInput.setSelectionRange) { const len = noteInput.value.length; noteInput.setSelectionRange(len,len); } }catch(e){}
            }

            // attach click handler to each month-note input and note button (delegated)
            function attachMonthNoteClicks(){
              const tbodyEl = tbody; if(!tbodyEl) return;
              tbodyEl.addEventListener('click', function(ev){
                const tgt = ev.target;
                if(!tgt) return;
                // if the clicked element is a month-note input
                const id = tgt.id || '';
                const match = id.match(/^month-note-(\d+)$/);
                if(match){ const idx = Number(match[1]); const origin = tgt; const months = getMonthData(); const ov = dom('monthNoteOverlay'); if(ov) ov._originEl = origin; openMonthNoteOverlay(idx, months); return; }
                // if clicked the note button icon
                const matchBtn = id.match(/^month-note-btn-(\d+)$/);
                if(matchBtn){ const idx = Number(matchBtn[1]); const origin = tgt; const months = getMonthData(); createMonthNoteOverlay(); const ov = dom('monthNoteOverlay'); if(ov) ov._originEl = origin; openMonthNoteOverlay(idx, months); return; }
              });
            }

            // initialize on DOM ready
            try{ attachMonthNoteClicks(); }catch(e){ console.debug('attachMonthNoteClicks failed', e); }
          })();

    // KPIs
    function recompute(){
  yearDataLabel.textContent = ownerSel.value + ' Year Data: ' + yearSel.value;
  // Move the label 0.5cm to the right only for MADUR_ENBD
  yearDataLabel.style.left = (ownerSel.value === 'MADUR_ENBD') ? '0.5cm' : '0';
    // Year target
  const yt = parseNum(load('yearTarget', 0));

    // Monthly data from monthData
    const months = getMonthData();
  const values = months.map(m=> parseNum(m.outflow||0));
  console.debug('recompute: months loaded', months.length, 'values', values);

    // Compute variance and cumulative balance per month
    const monthlyTarget = yt/12;
  const openingBal = parseNum(dom('openingBalance').value || 0);
  let cumBal = openingBal;
      for(let i=0;i<12;i++){
        const v = values[i]||0;
        const varr = v - (months[i].target || monthlyTarget);
        months[i].variance = varr;
        cumBal += varr;
        months[i].balance = cumBal;
      }
      saveMonthData(months);

  // Update KPIs per new rules
  const totalTarget = months.reduce((s,m)=> s + parseNum(m.target||0), 0);
  setKpi('kpiTotalTarget', totalTarget);
  console.debug('recompute: setKpi kpiTotalTarget', totalTarget);
  // Force a neutral muted color for the Total Target KPI (unbiased)
  const tt = dom('kpiTotalTarget'); if(tt){ tt.classList.add('neutral-muted'); tt.classList.remove('positive','negative'); }

  const inflowYTD = values.slice(0, currentMonthIdx).reduce((a,b)=>a+b,0);
  setKpi('kpiInflow', inflowYTD);
  console.debug('recompute: setKpi kpiInflow', inflowYTD);

  setKpi('kpiOpeningBalance', openingBal);
  console.debug('recompute: setKpi kpiOpeningBalance', openingBal);
  if (openingBal === 0) {
    const el = dom('kpiOpeningBalance');
    if (el) {
      el.textContent = 'Nil';
      el.style.color = '#0000FF';
    }
  }

      // Update totals row for Target and Bank Inflow
  try{
    let totTargetEl = dom('totTarget');
    let totInflowEl = dom('totInflow');
    // If totals elements are missing, attempt to build the table (maybe not yet rendered) and re-acquire
    if(!totTargetEl || !totInflowEl){
      console.debug('recompute: totals elements missing, calling buildTable() to (re)create them');
      try{ buildTable(); }catch(be){ console.warn('recompute: buildTable() failed', be); }
      totTargetEl = dom('totTarget');
      totInflowEl = dom('totInflow');
    }
  const totalTargetVal = months.reduce((s,m)=> s + parseNum(m.target||0), 0);
  const totalInflowVal = months.reduce((s,m)=> s + parseNum(m.outflow||0), 0);
  const totalVarianceVal = months.reduce((s,m)=> s + parseNum(m.variance||0), 0);
  const totalBalanceVal = months.length ? parseNum(months[months.length-1].balance||0) : 0;
  console.debug('recompute: totals computed', { totalTargetVal, totalInflowVal, totalVarianceVal, totalBalanceVal, totTargetElExists: !!totTargetEl, totInflowElExists: !!totInflowEl });
  if(totTargetEl) totTargetEl.textContent = fmtAcc(totalTargetVal);
  if(totInflowEl) totInflowEl.textContent = fmtAcc(totalInflowVal);
  const totVarEl = dom('totVariance'); if(totVarEl){ totVarEl.textContent = fmtAcc(totalVarianceVal); totVarEl.style.color = totalVarianceVal>0? '#7bd99f' : totalVarianceVal<0? '#f85149' : '#7bd99f'; }
  const totBalEl = dom('totBalance'); if(totBalEl){ totBalEl.textContent = fmtAcc(totalBalanceVal); totBalEl.style.color = totalBalanceVal>0? '#7bd99f' : totalBalanceVal<0? '#f85149' : '#7bd99f'; }
  // debug banner removed
  }catch(e){ console.error('recompute: error updating totals row', e); }

  // Avg. Mo. Target = total target / 12
  const avgMoTarget = totalTarget / 12;
  setKpi('kpiAvgMoTarget', Math.round(avgMoTarget));
  console.debug('recompute: setKpi kpiAvgMoTarget', Math.round(avgMoTarget));

  // Avg. Mo. Inflow: total bank inflow divided by months that have passed (exclude current month)
  const monthsPassed = currentMonthIdx; // months before current month
  const inflowBeforeCurrent = values.slice(0, monthsPassed).reduce((a,b)=>a+b,0);
  const avgInflow = monthsPassed>0 ? inflowBeforeCurrent / monthsPassed : 0;
  setKpi('kpiAvgMonthly', Math.round(avgInflow));
  console.debug('recompute: setKpi kpiAvgMonthly', Math.round(avgInflow));

  // Also compute average including the current month (for an alternate projection method)
  const inflowIncludingCurrent = values.slice(0, currentMonthIdx+1).reduce((a,b)=>a+b,0);
  const monthsCountIncludingCurrent = Math.max(1, currentMonthIdx+1);
  const avgInflowIncludingCurrent = Math.round(inflowIncludingCurrent / monthsCountIncludingCurrent);
  console.debug('recompute: avgInflowIncludingCurrent', avgInflowIncludingCurrent, 'inflowIncludingCurrent', inflowIncludingCurrent, 'monthsCount', monthsCountIncludingCurrent);

  // Mo. Variance = average inflow - average monthly target
  const moVariance = Math.round(avgInflow - avgMoTarget);
  setKpi('kpiMoVariance', moVariance);
  console.debug('recompute: setKpi kpiMoVariance', moVariance);

  // Total Deviation: monthly variance multiplied by months passed (exclude current month)
  // Use the Mo. Variance computed above (signed) and multiply by monthsPassed
  const monthsPassedForDeviation = monthsPassed; // already excludes current month
  const totalDeviation = Math.round(moVariance * monthsPassedForDeviation);
  setKpi('kpiTotalDeviation', totalDeviation);
  console.debug('recompute: setKpi kpiTotalDeviation', totalDeviation);

  // Forecasted year-end per user: include current month in the projection window.
  // monthsToYearEndIncludingCurrent = total months from current month to Dec inclusive
  // NOTE: we'll compute a day-aware fractional `months_left` below and derive
  // an integer months-to-year-end where needed using `Math.ceil(months_left)`.
  // Day-level time awareness: compute days elapsed/left and fractional months remaining
  const now = new Date();
  const startOfYear = new Date(Number(yearSel.value||now.getFullYear()), 0, 1, 0,0,0);
  const endOfYear = new Date(Number(yearSel.value||now.getFullYear()), 11, 31, 23,59,59);
  const msInDay = 1000*60*60*24;
  const days_elapsed = Math.max(0, Math.floor((now - startOfYear)/msInDay));
  const days_left = Math.max(0, Math.ceil((endOfYear - now)/msInDay));
  // convert to fractional months (average month length 30.44 days)
  const months_left = Math.max(0.01, days_left / 30.44);
  // derive an integer months-to-year-end (inclusive) for places that need whole months
  const monthsToYearEndIncludingCurrent = Math.max(1, Math.ceil(months_left));
  const schedule_index = (days_elapsed + days_left) > 0 ? (days_elapsed / (days_elapsed + days_left)) : 0;
  // Use fractional months_left for forecast; keep an integer label for readability
  const monthsLabelReadable = months_left >= 1 ? `${months_left.toFixed(2)} months` : `${months_left.toFixed(2)} months`;
  // Use simple linear projection: inflowYTD + round(avgInflow * remainingMonthsAfterCurrent)
  // avgInflow excludes current month, remainingMonthsAfterCurrent includes current month (since current inflow not yet registered)
  const remainingWholeMonthsAfterCurrent = monthsToYearEndIncludingCurrent;
  const forecastYearEnd = inflowYTD + Math.round(avgInflow * remainingWholeMonthsAfterCurrent);
  setKpi('kpiForecastYearEnd', forecastYearEnd);
  console.debug('recompute: setKpi kpiForecastYearEnd', forecastYearEnd, 'using avgInflow', avgInflow, 'remainingWholeMonthsAfterCurrent', remainingWholeMonthsAfterCurrent);

  // Add a small breakdown tooltip element under the Forecast KPI to explain calculation
  try{
    const kpiFyEl = dom('kpiForecastYearEnd');
    if(kpiFyEl){
      let hint = dom('kpiForecastYearEndHint');
      if(!hint){
        hint = document.createElement('div');
        hint.id = 'kpiForecastYearEndHint';
        hint.className = 'small';
        hint.style.fontSize = '8px';
        hint.style.fontWeight = 'lighter';
        hint.style.color = 'var(--muted)';
        hint.style.marginTop = '6px';
        kpiFyEl.appendChild(hint);
      }
      hint.textContent = `Calc: inflowYTD ${fmtAcc(inflowYTD)} + ${fmtAcc(Math.round(avgInflow))}√ó${remainingWholeMonthsAfterCurrent} (includes current month)`;
    }
  }catch(e){ console.debug('recompute: could not set forecast hint', e); }

  // Predictive Modeling: Confidence Intervals using Monte Carlo
  const historicalVariances = months.slice(0, currentMonthIdx).map(m => parseNum(m.variance || 0)).filter(v => !isNaN(v));
  // Monte Carlo expects an integer remaining-months; use a rounded-up value but keep months_left for rate math
  const mcRemainingMonths = Math.max(1, Math.ceil(months_left));
  const predictive = monteCarloSimulation(historicalVariances, mcRemainingMonths, inflowYTD);
  const forecastRangeEl = dom('forecastRange');
  if(forecastRangeEl){
    // Show only the 80% confidence interval as a simple range
    const low80 = Math.round(predictive.ci80[0]);
    const high80 = Math.round(predictive.ci80[1]);
    forecastRangeEl.textContent = `Range: ${fmtAcc(low80)} - ${fmtAcc(high80)} (80% CI)`;
  }

  // Mo. Needed Inflow to End of Year: evenly distribute remaining target across remaining months (including current)
  const monthsLabelEl = dom('kpiMonthsLabel');
  if(monthsLabelEl) monthsLabelEl.textContent = monthsLabelReadable;
  const titleMonthsEl = dom('kpiTitleMonths');
  if(titleMonthsEl) titleMonthsEl.textContent = monthsLabelReadable;
  // Guardrail: if no total target set, avoid misleading forecasts and risk numbers
  const remainingToTarget = totalTarget > 0 ? Math.max(0, totalTarget - inflowYTD) : 0;
  // Calculate Mo. Needed as Remaining to Active Target divided by remaining whole months
  // (include the current month). Use the integer monthsToYearEndIncludingCurrent computed above.
  const moNeededGross = totalTarget > 0 ? Math.ceil(remainingToTarget / Math.max(1, monthsToYearEndIncludingCurrent)) : 0;
  // expected natural inflow for remaining months (based on avgInflow)
  const expectedRemaining = Math.round(avgInflow * months_left);
  // remaining after accounting for expected remaining inflows (net requirement)
  const remainingAfterExpected = totalTarget > 0 ? Math.max(0, totalTarget - (inflowYTD + expectedRemaining)) : 0;
  const moNeededNet = totalTarget > 0 ? Math.ceil(remainingAfterExpected / Math.max(1, monthsToYearEndIncludingCurrent)) : 0;
  const moNeededEl = dom('kpiMoNeeded');
  if(moNeededEl){
    // display gross value in KPI (Mo. Needed gross, since anticipated current month inflow is 0)
    if(totalTarget > 0){
      const v = parseNum(moNeededGross);
      const absText = fmtAcc(Math.abs(v));
      const currencyLabel = `<span style="font-size:10px; opacity:0.85; vertical-align:baseline; font-weight:600">AED</span>&nbsp;`;
      if(v < 0){
        moNeededEl.innerHTML = `<span class="kpi-neg-wrap">( ${currencyLabel}<span style="margin-right:4px">-</span><span class="kpi-amount">${absText}</span> )</span>`;
      } else {
        moNeededEl.innerHTML = `${currencyLabel}<span class="kpi-amount">${absText}</span>`;
      }
      moNeededEl.setAttribute('title', `Gross: AED ${fmtAcc(moNeededGross)} (before expected inflows). Net/mo: AED ${fmtAcc(moNeededNet)}. Avg. Mo. Inflow: AED ${fmtAcc(Math.round(avgInflow))}`);
    } else {
      moNeededEl.textContent = '‚Äî';
    }
    moNeededEl.dataset.gross = String(moNeededGross);
    moNeededEl.dataset.net = String(moNeededNet);
    moNeededEl.dataset.avg = String(Math.round(avgInflow));
    moNeededEl.classList.remove('positive','negative');
    if(totalTarget > 0) moNeededEl.classList.add('attention'); else moNeededEl.classList.remove('attention');
  }
  // Insert or update KPI icon next to the months title to visualise risk band
  try{
    // small helper: compute composite and band
    const cmp = getCompositeScore();
    const titleMonths = dom('kpiTitleMonths');
    if(titleMonths){
      let icon = dom('kpiTitleMonthsIcon');
      if(!icon){
        icon = document.createElement('span');
        icon.id = 'kpiTitleMonthsIcon';
        icon.className = 'kpi-icon hidden';
        // use an inline SVG <use> to reference symbols defined in the header
        icon.innerHTML = `<svg aria-hidden="true"><use xlink:href="#icon-check"></use></svg>`;
        titleMonths.parentNode.insertBefore(icon, titleMonths.nextSibling);
      }
      if(!cmp || cmp.score === null || cmp.score === undefined || cmp.score === 0 && parseNum(load('yearTarget',0))===0){
        icon.classList.add('hidden');
        icon.setAttribute('title','No target set');
      } else {
        icon.classList.remove('hidden');
        // set appropriate band class and tooltip
        icon.classList.remove('comfort','warning','high','extreme');
        icon.classList.add(cmp.className || 'comfort');
        icon.setAttribute('title', `Risk: ${cmp.score}/100 ‚Äî ${cmp.label}`);
        // change the glyph for more severe states
        const use = icon.querySelector('use');
        if(use){
          if(cmp.label === 'Comfort') use.setAttribute('xlink:href','#icon-check');
          else if(cmp.label === 'Warning') use.setAttribute('xlink:href','#icon-clock');
          else use.setAttribute('xlink:href','#icon-alert');
        }
      }
    }
  }catch(e){ console.debug('recompute: KPI icon wiring failed', e); }
  // Expose gross vs net details in a small helper element under the Mo. Needed card
  try{
    let meta = dom('kpiMoNeededMeta');
    if(!meta){
      meta = document.createElement('div');
      meta.id = 'kpiMoNeededMeta';
      meta.className = 'small';
      const card = dom('moNeededCard');
      if(card) card.appendChild(meta);
    }
    if(meta){
      meta.textContent = `Gross/mo: AED ${fmtAcc(moNeededGross)} ¬∑ Expected remaining inflow: AED ${fmtAcc(expectedRemaining)}`;
      meta.style.marginTop = '52px';
      meta.style.color = 'var(--muted)';
      meta.style.fontSize = '12px';
      meta.style.textAlign = 'center';
    }
  }catch(e){ console.debug('recompute: could not set MoNeeded meta', e); }
  console.debug('recompute: moNeededGross', moNeededGross, 'moNeededNet', moNeededNet, 'expectedRemaining', expectedRemaining);

  // Surplus (positive means we've met/exceeded the target)
  const surplus = inflowYTD - totalTarget;
  const kBalEl = dom('kpiBalance');
  setKpi('kpiBalance', surplus);
  console.debug('recompute: setKpi kpiBalance', surplus);

      // Update variance & balance cells in-place to preserve input focus while typing
      const rows = tbody && tbody.rows ? Array.from(tbody.rows) : [];
      for(let i=0; i<rows.length && i<12; i++){
        const r = rows[i];
        // cells: 0=Day,1=Month,2=Target,3=Note,4=Outflow,5=Variance,6=Balance
        if(r.cells[5]){
          const vVal = Number(months[i].variance || 0);
          r.cells[5].textContent = fmtAcc(vVal);
          r.cells[5].classList.remove('positive','negative');
          if(vVal > 0) r.cells[5].classList.add('positive');
          else if(vVal < 0) r.cells[5].classList.add('negative');
        }
        if(r.cells[6]){
          const bal = Number(months[i].balance||0);
          r.cells[6].textContent = fmtAcc(bal);
          r.cells[6].classList.remove('positive','negative');
          if(bal>0) r.cells[6].classList.add('positive');
          else if(bal<0) r.cells[6].classList.add('negative');
        }
      }

      // Color totals balance if present
      try{
        const totBalEl = dom('totBalance');
        if(totBalEl){
          // months[11].balance already includes opening balance as we accumulated from openingBal
          const tb = parseNum(months.length ? months[months.length-1].balance || 0 : 0);
          totBalEl.textContent = fmtAcc(tb);
          totBalEl.style.color = tb > 0 ? '#7bd99f' : tb < 0 ? '#f85149' : '#7bd99f';
        }
      }catch(e){}

      // Update totals variance color/text
      try{
        const totVarEl = dom('totVariance');
        if(totVarEl){
          const totalVariance = months.reduce((s,m)=> s + parseNum(m.variance||0), 0);
          totVarEl.textContent = fmtAcc(totalVariance);
          totVarEl.style.color = totalVariance > 0 ? '#7bd99f' : totalVariance < 0 ? '#f85149' : '#7bd99f';
        }
      }catch(e){}

    }

  // Ensure any dock copies pull data from the main KPIs
      function updateUI(){
            try{
              console.debug('updateUI: entered');
              const s = computeScenarios();
              console.debug('updateUI: scenarios', s);
          // guardrail: if no Total Target set (0), show a gentle message but still show numbers
          const hasTarget = (s.totalTarget && Number(s.totalTarget) > 0);

          // Update cards (projected numbers)
          const setCardNum = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = format(val); };
          const setCardNote = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };

          setCardNum('scBaseProjected', s.baseYE);
          setCardNum('scBestProjected', s.bestYE);
          setCardNum('scWorstProjected', s.worstYE);
          console.debug('updateUI: updated card DOM for scBaseProjected/scBestProjected/scWorstProjected');

          // compute notes
          const gapBase = s.totalTarget - s.baseYE;
          const gapBest = s.totalTarget - s.bestYE;
          const gapWorst = s.totalTarget - s.worstYE;

          const baseNote = !hasTarget ? 'Set a Total Target to enable comparisons' : (gapBase<=0 ? `Meets/Exceeds target by AED ${format(Math.abs(gapBase))}` : `Short by AED ${format(gapBase)} ‚Ä¢ Mo. Needed ‚âà AED ${format(s.moNeeded)}`);
          const bestNote = !hasTarget ? 'Set a Total Target to enable comparisons' : (gapBest<=0 ? `Exceeds by AED ${format(Math.abs(gapBest))}` : `Short by AED ${format(gapBest)}`);
          const worstNote = !hasTarget ? 'Set a Total Target to enable comparisons' : (gapWorst<=0 ? `Exceeds by AED ${format(Math.abs(gapWorst))}` : `Short by AED ${format(gapWorst)}`);

          setCardNote('scBaseNote', baseNote);
          setCardNote('scBestNote', `Avg inflow ‚Üë ${Math.round((parseNum(dom('scBestPct')?.value||15)))}% ‚Äî ${bestNote}`);
          setCardNote('scWorstNote', `Avg inflow ‚Üì ${Math.round((parseNum(dom('scWorstPct')?.value||15)))}% ‚Äî ${worstNote}`);

          // update textual summary
          if(outputEl){ outputEl.textContent = buildOutputText(s); }

          // populate simple actions (used by Populate schedule select)
          const actions = [
            { label: `Deposit AED ${format(Math.max(0, s.moNeeded))} per month`, value: Math.max(0, s.moNeeded) },
            { label: `One-off deposit: AED ${format(Math.max(0, s.totalTarget - (s.YTD + s.OB)))}`, value: Math.max(0, s.totalTarget - (s.YTD + s.OB)) }
          ];
          try{ populateActionSelect(actions); }catch(e){}
        }catch(e){ console.debug('updateUI failed', e); }
      }

  // ensure dock mirrors the fresh KPI values
  try{ if(typeof updateDock === 'function') updateDock(); }catch(e){}
  try{ updateDock(); }catch(e){}

  // Observe KPI container for any DOM changes to immediately update dock copies
  try{
    const kpisContainer = document.querySelector('.kpis');
    if(kpisContainer && typeof MutationObserver !== 'undefined'){
      const mo = new MutationObserver(() => { try{ updateDock(); }catch(e){} });
      mo.observe(kpisContainer, { childList:true, subtree:true, characterData:true, attributes:true });
    }
  }catch(e){}

  // Mini chart using Chart.js: reads balances from #monthTable and draws a sparkline-like line
  let __miniChartInstance = null;

  // === Predictive Modeling ===
  // Monte Carlo simulation for year-end balance confidence intervals
  function monteCarloSimulation(historicalVariances, remainingMonths, currentBalance, simulations = 1000) {
    if (!historicalVariances || historicalVariances.length === 0) return { mean: currentBalance, ci80: [currentBalance, currentBalance], ci95: [currentBalance, currentBalance] };

    // Calculate mean and std dev from historical variances
    const mean = historicalVariances.reduce((a, b) => a + b, 0) / historicalVariances.length;
    const variance = historicalVariances.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / historicalVariances.length;
    const stdDev = Math.sqrt(variance);

    const outcomes = [];
    for (let sim = 0; sim < simulations; sim++) {
      let balance = currentBalance;
      for (let month = 0; month < remainingMonths; month++) {
        // Random variance from normal distribution
        const randomVariance = mean + stdDev * (Math.sqrt(-2 * Math.log(Math.random())) * Math.cos(2 * Math.PI * Math.random()));
        balance += randomVariance;
      }
      outcomes.push(balance);
    }

    outcomes.sort((a, b) => a - b);
    const meanOutcome = outcomes.reduce((a, b) => a + b, 0) / outcomes.length;
    const ci80Low = outcomes[Math.floor(outcomes.length * 0.1)];
    const ci80High = outcomes[Math.floor(outcomes.length * 0.9)];
    const ci95Low = outcomes[Math.floor(outcomes.length * 0.025)];
    const ci95High = outcomes[Math.floor(outcomes.length * 0.975)];

    return {
      mean: meanOutcome,
      ci80: [ci80Low, ci80High],
      ci95: [ci95Low, ci95High]
    };
  }

  function drawChart(){
    try{
      if(typeof Chart === 'undefined') return; // Chart.js not loaded yet
      const canvas = dom('miniChart');
      if(!canvas) return;
      // extract balances from table rows (assumes balance is in last cell)
      const tbody = document.querySelector('#monthTable tbody');
      const labels = [];
      const balanceData = [];
      const targetData = [];
      const inflowData = [];
      if(tbody){
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.forEach((r, idx)=>{
          const monthName = (r.cells && r.cells[1]) ? r.cells[1].textContent.trim() : ('M'+(idx+1));
          labels.push(monthName);
          // Balance (last cell)
          const balCell = r.cells && r.cells[r.cells.length-1];
          let balVal = 0;
          if(balCell) {
            balVal = parseNum(balCell.textContent || '');
          }
          balanceData.push(balVal);
          // Target (assume 3rd column index 2)
          const targetCell = r.cells && r.cells[2];
          let tVal = 0;
          if(targetCell){ const inp = targetCell.querySelector('input'); tVal = parseNum(inp ? inp.value : targetCell.textContent || ''); }
          targetData.push(tVal);
          // Bank Inflow (assume 5th column index 4)
          const inflowCell = r.cells && r.cells[4];
          let iVal = 0;
          if(inflowCell){ const inp = inflowCell.querySelector('input'); iVal = parseNum(inp ? inp.value : inflowCell.textContent || ''); }
          inflowData.push(iVal);
        });
      }

      // if chart exists, update data
      if(__miniChartInstance){
        __miniChartInstance.data.labels = labels;
        __miniChartInstance.data.datasets[0].data = balanceData;
        __miniChartInstance.data.datasets[1].data = targetData;
        __miniChartInstance.data.datasets[2].data = inflowData;
        __miniChartInstance.update();
        return;
      }

      // create chart
      const ctx = canvas.getContext('2d');
      __miniChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Balance',
              data: balanceData,
              borderColor: '#7bd99f',
              backgroundColor: 'rgba(123,217,159,0.12)',
              fill: true,
              tension: 0.3,
              pointRadius: 3,
              borderWidth: 3,
            },
            {
              label: 'Target',
              data: targetData,
              borderColor: '#ff0000',
              borderDash: [6,4],
              backgroundColor: 'transparent',
              tension: 0.2,
              pointRadius: 2,
              borderWidth: 2,
            },
            {
              label: 'Bank Inflow',
              data: inflowData,
              borderColor: '#66a6ff',
              backgroundColor: 'transparent',
              tension: 0.25,
              pointRadius: 2,
              borderWidth: 2,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
              display: true,
              title: { display: true, text: 'Month', color: 'green', align: 'end' },
              ticks: { color: 'red' }
            },
            y: { 
              display: true,
              title: { display: true, text: 'Amount (AED)' },
              ticks: { color: 'green', callback: function(value) { return 'AED ' + fmt(value); } }
            }
          },
          plugins: {
            legend: { display: true, position: 'bottom' },
            tooltip: { 
              enabled: true,
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': AED ' + fmt(context.parsed.y);
                }
              }
            }
          },
          elements: { line: { capBezierPoints: true } },
        }
      });
      // give canvas a fixed height for layout
      canvas.style.height = '160px';
    }catch(e){ console.error('drawChart error', e); }
  }

  // === Event Handlers and Features ===
  // Reminders
  let remCollapsed = false; // collapse state for reminders list
  // small UI debug helper to show which storage key produced reminders (visible on page)
  function setRemDebug(src, count){ try{ const dbg = dom('remDebug'); if(!dbg) return; dbg.textContent = src + (count!==undefined?(' ('+String(count)+')'):''); }catch(e){} }
  const remDrawer = dom('reminderDrawer');
  const btnOpenRem = dom('btnOpenRem');
  const btnCloseRemDrawer = dom('btnCloseRemDrawer');
  if(btnOpenRem) btnOpenRem.onclick = ()=>{ console.log('btnOpenRem clicked, opening drawer'); if(remDrawer) { remDrawer.classList.add('open'); console.log('remDrawer.classList.add(open)'); } renderRems(); };
  // Defensive delegated handler: also open drawer if any descendant of #btnOpenRem is clicked
  document.addEventListener('click', (e)=>{
    try{
      if(!e.target) return;
      const hit = e.target.closest ? e.target.closest('#btnOpenRem') : null;
      if(hit){ console.log('delegated click on btnOpenRem descendant'); if(remDrawer) remDrawer.classList.add('open'); renderRems(); }
    }catch(err){}
  });
  if(btnCloseRemDrawer) btnCloseRemDrawer.onclick = ()=>{ if(remDrawer) remDrawer.classList.remove('open'); };
  // Close drawer on outside click
  // Temporarily disabled to prevent closing on button clicks
  // Close drawer on outside click ‚Äî re-enabled with robust checks.
  // If the reminders drawer is open and the user clicks anywhere outside the drawer
  // and outside the reminders open button, close the drawer. We use a capturing
  // listener and guard against clicks originating from within the drawer or the
  // open button (including descendants) to avoid interfering with internal controls.
  document.addEventListener('click', (e) => {
    try{
      if(!remDrawer) return;
      // only act when drawer is open
      if(!remDrawer.classList.contains('open')) return;
      const clickTarget = e.target;
      // if click is inside the drawer, do nothing
      if(remDrawer.contains(clickTarget)) return;
      // if click is the open button or inside it, do nothing
      if(btnOpenRem && (btnOpenRem === clickTarget || btnOpenRem.contains(clickTarget))) return;
      // otherwise close the drawer
      remDrawer.classList.remove('open');
    }catch(err){ console.debug('outside-click handler error', err); }
  });
  // Close notes drawer on outside click
  document.addEventListener('click', (e) => {
    try{
      const notesDrawer = dom('notesDrawer');
      const btnToggleNotes = dom('btnToggleNotes');
      if(!notesDrawer) return;
      // only act when drawer is open
      if(!notesDrawer.classList.contains('open')) return;
      const clickTarget = e.target;
      // if click is inside the drawer, do nothing
      if(notesDrawer.contains(clickTarget)) return;
      // if click is the open button or inside it, do nothing
      if(btnToggleNotes && (btnToggleNotes === clickTarget || btnToggleNotes.contains(clickTarget))) return;
      // otherwise close the drawer
      notesDrawer.classList.remove('open');
      notesDrawer.setAttribute('aria-hidden','true');
    }catch(err){ console.debug('notes outside-click handler error', err); }
  });
    const remBadge = dom('remBadge');
    const btnToggleRem = dom('btnToggleRem');
    if(btnToggleRem){
      btnToggleRem.addEventListener('click', ()=>{
        remCollapsed = !remCollapsed;
        btnToggleRem.textContent = remCollapsed ? 'Expand' : 'Collapse';
        btnToggleRem.setAttribute('aria-pressed', String(remCollapsed));
        renderRems();
      });
    }
    function remKey(){ return 'reminders'; }
    function getRems(){
      const key = `enbd:${dom('owner').value}:reminders`;
      try{
        const raw = localStorage.getItem(key);
        if(raw){
          const p = JSON.parse(raw);
          if(Array.isArray(p)){
            console.debug('getRems: loaded via per-owner key', key);
            try{ setRemDebug(`load:${key}`, p.length); }catch(e){}
            return p;
          }
        }
      }catch(e){}

      // Legacy migration
      const legacy = ['reminders', 'enbd:reminders'];
      for(const k of legacy){
        try{
          const raw = localStorage.getItem(k);
          if(raw){
            const p = JSON.parse(raw);
            if(Array.isArray(p) && p.length){
              localStorage.setItem(key, raw);
              localStorage.removeItem(k);
              console.debug('getRems: migrated from legacy', k, 'to', key);
              try{ setRemDebug(`migrated:${k}`, p.length); }catch(e){}
              return p;
            }
          }
        }catch(e){}
      }

      return [];
    }
    function setRems(arr){
      const key = `enbd:${dom('owner').value}:reminders`;
      localStorage.setItem(key, JSON.stringify(arr));
    }
    function addReminder(obj){
  const arr = getRems();
      arr.push(obj);
      setRems(arr);
      renderRems();
    }
    function appendRemDebug(msg){ try{ const dbg = dom('remDebug'); if(!dbg) return; const t = new Date().toLocaleTimeString(); dbg.textContent = `[${t}] ${msg}\n` + dbg.textContent; }catch(e){} }
    function defaultRemLabel(r){
      try{
        const ownerEl = dom('owner');
        const owner = ownerEl ? ownerEl.value : 'Owner';
        // use displayed moNeeded and months if available
        const moNeeded = (dom('kpiMoNeeded') && dom('kpiMoNeeded').textContent) ? dom('kpiMoNeeded').textContent : null;
        const months = (dom('kpiTitleMonths') && dom('kpiTitleMonths').textContent) ? dom('kpiTitleMonths').textContent : '';
        if(moNeeded) return `Deposit needed for ${owner} to meet target (${moNeeded}${months? ' ‚Ä¢ '+months : ''})`;
        return `Deposit needed for ${owner} to meet target`;
      }catch(e){ return 'Deposit needed'; }
    }
    function displayedLabel(r){
      try{
        const raw = r && r.label ? String(r.label).trim() : '';
        if(!raw) return defaultRemLabel(r);
        // treat legacy placeholder 'Owner Deposit' as empty
        if(raw === 'Owner Deposit') return defaultRemLabel(r);
        return raw;
      }catch(e){ return defaultRemLabel(r); }
    }
    function deleteReminder(id){
      appendRemDebug('click: delete ' + id);
      try{
        // keep UI visible while we delete
        if(remDrawer) remDrawer.classList.add('open');
        const original = getRems();
        const arr = original.filter(r=>r.id!==id);
        setRems(arr);
        renderRems();
        appendRemDebug('handler: delete completed ' + id);
      }catch(e){ appendRemDebug('error: deleteReminder ' + String(e)); console.debug(e); }
    }
    function toggleDone(id, done){
      appendRemDebug('click: toggleDone ' + id + ' -> ' + done);
      try{
        if(remDrawer) remDrawer.classList.add('open');
        const arr = getRems().map(r=> r.id===id ? {...r, done} : r);
        setRems(arr);
        renderRems();
        appendRemDebug('handler: toggleDone completed ' + id + ' -> ' + done);
      }catch(e){ appendRemDebug('error: toggleDone ' + String(e)); console.debug(e); }
    }
    function editReminder(id){
      appendRemDebug('click: edit ' + id);
      try{
        if(remDrawer) remDrawer.classList.add('open');
        const arr = getRems();
        const r = arr.find(x=>x.id===id);
        if(!r){ appendRemDebug('handler: edit not found ' + id); return; }
        // Replace prompt flow with inline modal form to avoid browser blocking
        let modal = dom('editReminderModal');
        if(!modal){
          modal = document.createElement('div');
          modal.id = 'editReminderModal';
          modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; display:flex; align-items:center; justify-content:center;';
          modal.innerHTML = `
            <div style="background:var(--card); padding:30px; border-radius:8px; border:1px solid var(--line); max-width:800px; width:90%;">
              <h3 style="margin:0 0 20px 0;">Edit Reminder</h3>
              <label>Date (YYYY-MM-DD): <input type="date" id="editDate" style="width:100%; margin-bottom:10px;"></label><br>
              <label>Time (HH:MM): <input type="time" id="editTime" style="width:100%; margin-bottom:10px;"></label><br>
              <label>Amount: <input type="number" id="editAmount" step="0.01" style="width:100%; margin-bottom:10px;"></label><br>
              <label>Label: <input type="text" id="editLabel" style="width:100%; margin-bottom:20px;"></label><br>
              <button id="editSave" class="btn" style="margin-right:10px;">Save</button>
              <button id="editCancel" class="btn">Cancel</button>
            </div>
          `;
          document.body.appendChild(modal);
        }
        // Pre-fill values
        const dt = new Date(r.when);
        dom('editDate').value = dt.toISOString().split('T')[0];
        dom('editTime').value = dt.toTimeString().slice(0,5);
        dom('editAmount').value = r.amount;
        dom('editLabel').value = r.label;
        modal.style.display = 'flex';
        // Focus first input
        setTimeout(() => dom('editDate').focus(), 100);
        // Event listeners
        const saveBtn = dom('editSave');
        const cancelBtn = dom('editCancel');
        const saveHandler = () => {
          const newDate = dom('editDate').value;
          const newTime = dom('editTime').value;
          const newAmount = Number(dom('editAmount').value) || 0;
          const newLabel = dom('editLabel').value || r.label;
          const newWhen = new Date(`${newDate}T${newTime}:00`);
          if(isNaN(newWhen)) { alert('Invalid date/time'); appendRemDebug('handler: edit invalid date ' + id); return; }
          r.when = newWhen.toISOString(); r.amount = newAmount; r.label = newLabel;
          setRems(arr); renderRems(); appendRemDebug('handler: edit completed ' + id);
          modal.style.display = 'none';
        };
        const cancelHandler = () => {
          appendRemDebug('handler: edit cancelled by user ' + id);
          modal.style.display = 'none';
        };
        saveBtn.onclick = saveHandler;
        cancelBtn.onclick = cancelHandler;
        // Allow Enter to save
        modal.addEventListener('keydown', (e) => { if(e.key === 'Enter') saveHandler(); if(e.key === 'Escape') cancelHandler(); });
      }catch(e){ appendRemDebug('error: editReminder outer ' + String(e)); console.debug(e); }
    }
    function renderRems(){
      console.log('renderRems: starting');
      appendRemDebug('renderRems starting');
      const remList = dom('remList');
      // debug: ensure remList exists and we can render into it
      if(!remList){ console.log('renderRems: remList element not found'); return; }
      remList.innerHTML = '';
    const arr = getRems();
    console.log('renderRems: loaded', arr.length, 'reminders');
    // update badge (inside drawer/pill)
    const remBadge = dom('remBadge');
  if(remBadge) remBadge.textContent = String(arr.length);
  const key = `enbd:${dom('owner').value}:reminders`;
  // compute if any reminder is done and get icon span
  const anyDone = Array.isArray(arr) && arr.some(x => x && x.done);
  const pillGlobal = dom('btnOpenRem');
  const iconSpanGlobal = pillGlobal ? pillGlobal.querySelector('.rem-icon') : null;
  console.log('renderRems: key', key);
      // respect collapse state
  if(remCollapsed){ remList.style.display = 'none'; return; }
  remList.style.display = 'block';
      if(!arr.length){
        // No reminders: ensure the floating pill shows the Mo. Needed KPI (or 0) instead of any static sample text.
        try{
          const pill = dom('btnOpenRem'); const badge = dom('remBadge');
          if(pill){
            pill.setAttribute('title','No upcoming reminders');
            const labelSpan = pill.querySelector('.rem-label');
              if(labelSpan){
                  const moNeededEl = dom('kpiMoNeeded');
                  const moNeededVal = moNeededEl ? parseNum(moNeededEl.textContent) : 0;
                  if(Number(moNeededVal) <= 0){
                    labelSpan.textContent = 'Target achieved üéâ';
                    if(iconSpanGlobal) iconSpanGlobal.textContent = 'üéâ';
                  } else {
                    const amt = fmtAcc(moNeededVal - parseNum(moNeededEl.dataset.avg || 0));
                    labelSpan.textContent = `Dep. Reminder ‚Ä¢ ${amt}`;
                    if(iconSpanGlobal) iconSpanGlobal.textContent = 'üîî';
                  }
                }
          }
          if(badge) badge.textContent = String(arr.length);
          // ensure normal state
          if(pill) { pill.classList.remove('state-soon','state-urgent','pulse'); pill.classList.add('state-normal'); }
          if(badge) { badge.classList.remove('state-soon','state-urgent'); badge.classList.add('state-normal'); }
        }catch(e){ console.debug('renderRems: empty-reminder pill update failed', e); }
        // nothing to render inside the drawer
        return;
      }
      arr.sort((a,b)=> new Date(a.when) - new Date(b.when));
      console.log('renderRems: sorted reminders, rendering', arr.length);
      for(const r of arr){
        console.log('rendering reminder', r.id);
        const row = document.createElement('div');
        row.className = 'rem-row';
        // checkbox
        const cb = document.createElement('input');
        cb.type='checkbox'; cb.className='tiny'; cb.checked = !!r.done;
        cb.addEventListener('change', (e) => { e.stopPropagation(); toggleDone(r.id, cb.checked); });
        // date
  let dateStr = '(No date)';
  try{ const dt = new Date(r.when); if(!isNaN(dt)) dateStr = dt.toLocaleDateString('en-GB'); }catch(e){}
  const dateAmount = document.createElement('div'); dateAmount.className='date-amount' + (r.done?' strike':'');
  dateAmount.textContent = `üîî ${dateStr}`;
        // label + amount
  const label = document.createElement('div'); label.className = 'rem-label' + (r.done?' faded':'');
  const safeLabel = String(displayedLabel(r));
  const safeAmount = fmtAcc(r.amount || 0);
  label.innerHTML = `${safeLabel}<div style="font-weight:700; margin-top:2px">${safeAmount}</div>`;
        // actions
        const actions = document.createElement('div'); actions.className='rem-actions';
  const btnCal = document.createElement('button'); btnCal.type='button'; btnCal.className='iconbtn'; btnCal.textContent='üìÖ';
  btnCal.title='Add to calendar'; btnCal.onclick = () => { appendRemDebug('click: calendar ' + r.id); downloadICS(r); if(remDrawer) remDrawer.classList.add('open'); };
  const btnEdit = document.createElement('button'); btnEdit.type='button'; btnEdit.className='iconbtn'; btnEdit.textContent='‚úèÔ∏è';
  btnEdit.title='Edit'; btnEdit.onclick = () => { appendRemDebug('click: edit ' + r.id); editReminder(r.id); if(remDrawer) remDrawer.classList.add('open'); };
  const btnShare = document.createElement('button'); btnShare.type='button'; btnShare.className='iconbtn'; btnShare.textContent='üîó';
  btnShare.title='Share'; btnShare.onclick = () => { appendRemDebug('click: share ' + r.id); shareReminder(r); if(remDrawer) remDrawer.classList.add('open'); };
  const btnDel = document.createElement('button'); btnDel.type='button'; btnDel.className='iconbtn danger'; btnDel.textContent='‚úñ';
  btnDel.title='Delete'; btnDel.onclick = () => { appendRemDebug('click: delete ' + r.id); deleteReminder(r.id); if(remDrawer) remDrawer.classList.add('open'); };
  const btnEmail = document.createElement('button'); btnEmail.type='button'; btnEmail.className='iconbtn'; btnEmail.textContent='üìß';
  btnEmail.title='Send Email'; btnEmail.onclick = () => { appendRemDebug('click: email ' + r.id); sendReminderEmail(r); if(remDrawer) remDrawer.classList.add('open'); };
        actions.append(btnCal, btnEdit, btnShare, btnEmail, btnDel);
        row.append(cb, dateAmount, label, actions);
        remList.appendChild(row);
        console.log('appended row for reminder', r.id);
      }
      // Scroll to top to show buttons
      if(remDrawer) remDrawer.scrollTop = 0;
      // compute and surface next upcoming reminder (soonest date >= now and not done)
      try{
        const now = new Date();
        const upcomingList = arr.filter(x=>!x.done).map(x=> ({...x, dt: new Date(x.when)})).filter(x=>!isNaN(x.dt)).sort((a,b)=>a.dt - b.dt).slice(0,3);
        const pill = dom('btnOpenRem'); const badge = dom('remBadge');
        if(pill && badge){
          if(upcomingList && upcomingList.length){
            // aggregate amount of next up to 3 reminders
            const totalAmt = upcomingList.reduce((s,it)=> s + Number(it.amount||0), 0);
            const amtText = fmtAcc(totalAmt || 0);
            // tooltip: list each upcoming item
            const lines = upcomingList.map(it => `${it.dt.toLocaleDateString('en-GB')}: AED ${fmtAcc(it.amount||0)} ‚Äî ${displayedLabel(it)}`);
            pill.setAttribute('title', `Upcoming (${upcomingList.length}):\n` + lines.join('\n'));
            // show aggregated amount inline on pill when space allows
            const labelSpan = pill.querySelector('.rem-label');
            if(labelSpan){
              // use numeric totalAmt to decide display (avoid negative/zero showing)
              if(Number(totalAmt) <= 0){
                labelSpan.textContent = 'Target achieved üéâ';
                if(iconSpanGlobal) iconSpanGlobal.textContent = 'üéâ';
              } else {
                labelSpan.textContent = `Dep. Reminder ‚Ä¢ ${amtText}`;
                // if any reminder is already done, prefer the check icon
                if(anyDone && iconSpanGlobal) iconSpanGlobal.textContent = '‚úÖ';
                else if(iconSpanGlobal) iconSpanGlobal.textContent = 'üîî';
              }
            }
            badge.textContent = anyDone ? '‚úÖ' : String(arr.length);
            if(anyDone) badge.classList.add('check'); else badge.classList.remove('check');
            // state logic based on soonest reminder
            const days = Math.ceil((upcomingList[0].dt - now)/(1000*60*60*24));
            pill.classList.remove('state-normal','state-soon','state-urgent','pulse'); badge.classList.remove('state-normal','state-soon','state-urgent');
            if(days <= 3) { pill.classList.add('state-urgent','pulse'); badge.classList.add('state-urgent'); }
            else if(days <= 14) { pill.classList.add('state-soon'); badge.classList.add('state-soon'); }
            else { pill.classList.add('state-normal'); badge.classList.add('state-normal'); }
          } else {
            pill.setAttribute('title','No upcoming reminders');
            const labelSpan = pill.querySelector('.rem-label');
            if(labelSpan){
              const moNeededEl = dom('kpiMoNeeded');
              const amt = moNeededEl ? Math.max(0, parseNum(moNeededEl.dataset.gross || '0') - parseNum(moNeededEl.dataset.avg || '0')) : 0;
              if(Number(amt) <= 0){
                labelSpan.textContent = 'Target achieved üéâ';
                if(iconSpanGlobal) iconSpanGlobal.textContent = 'üéâ';
              } else {
                labelSpan.textContent = `Dep. Reminder ‚Ä¢ ${fmtAcc(amt)}`;
                if(anyDone && iconSpanGlobal) iconSpanGlobal.textContent = '‚úÖ';
                else if(iconSpanGlobal) iconSpanGlobal.textContent = 'üîî';
              }
            }
            badge.textContent = anyDone ? '‚úÖ' : String(arr.length);
            if(anyDone) badge.classList.add('check'); else badge.classList.remove('check');
            pill.classList.remove('state-soon','state-urgent','pulse'); pill.classList.add('state-normal'); badge.classList.remove('state-soon','state-urgent'); badge.classList.add('state-normal');
          }
        }
      }catch(e){ console.debug('renderRems: compute upcoming failed', e); }
    }
    function downloadICS(r){
  appendRemDebug('handler: downloadICS start ' + (r && r.id));
  // keep user informed and avoid silent failures
  try{
        const dtStart = new Date(r.when);
        if(isNaN(dtStart)) throw new Error('Invalid date');
        const dtEnd = new Date(dtStart.getTime() + 60*60*1000);
        function asUTC(dt){
          const pad = n => String(n).padStart(2,'0');
          return dt.getUTCFullYear()+pad(dt.getUTCMonth()+1)+pad(dt.getUTCDate())+'T'+pad(dt.getUTCHours())+pad(dt.getUTCMinutes())+'00Z';
        }
        const uid = `${r.id}@enbd-tracker`;
        const ics = [
          'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//ENBD Tracker//ENBD//EN',
          'BEGIN:VEVENT',
          'UID:'+uid,
          'DTSTAMP:'+asUTC(new Date()),
          'DTSTART:'+asUTC(dtStart),
          'DTEND:'+asUTC(dtEnd),
          'SUMMARY:'+ (displayedLabel(r) + (r.amount? ' ‚Äî '+fmtAcc(r.amount) : '')) ,
    'DESCRIPTION:'+ (r.label || defaultRemLabel(r)),
          'END:VEVENT',
          'END:VCALENDAR'
        ].join('\r\n');
        const blob = new Blob([ics], {type:'text/calendar'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'cheque-deposit.ics';
        document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();}, 0);
      }catch(err){
        appendRemDebug('error: downloadICS ' + String(err));
        console.debug('downloadICS failed', err);
        alert('Could not create calendar event ‚Äî please check the reminder date/time.');
      }
    }
    function shareReminder(r){
      appendRemDebug('handler: shareReminder start ' + (r && r.id));
      try{
        const dt = new Date(r.when);
  const text = `Cheque Reminder\nDate: ${isNaN(dt)?'(no date)':dt.toLocaleDateString('en-GB')}\nAmount: ${fmtAcc(r.amount)}\nLabel: ${displayedLabel(r)}`;
        // Try Web Share API first (mobile/modern browsers)
        if(navigator.share){
          navigator.share({ title: 'Cheque Reminder', text }).catch(()=>{
            // fallback to WhatsApp link
            window.open('https://wa.me/?text='+encodeURIComponent(text), '_blank');
          });
          return;
        }
        // Fallback to WhatsApp web link
        window.open('https://wa.me/?text='+encodeURIComponent(text), '_blank');
      }catch(e){ console.debug('shareReminder error', e); alert('Could not share reminder.'); }
    }

    // Send reminder by opening default mail client (fallback). If EmailJS is configured, later we can wire a richer send.
    function sendReminderEmail(r){
      appendRemDebug('handler: sendReminderEmail start ' + (r && r.id));
      try{
        const dt = new Date(r.when);
        const subject = 'Cheque Reminder';
  const bodyBase = `Cheque Reminder\n\nDate: ${isNaN(dt)?'(no date)':dt.toLocaleString('en-GB')}\nAmount: ${fmtAcc(r.amount)}\nLabel: ${displayedLabel(r)}\n\nPlease arrange deposit as required.`;
        // Ask for recipient - if provided, download the .ics and open mailto to that recipient so they can attach it
        const recipient = prompt('Enter recipient email to send this reminder (leave blank to open your mail client):', '');
        if(recipient){
          // prepare and download .ics so it's ready to attach
          try{ downloadICS(r); }catch(e){ console.debug('downloadICS fallback failed', e); }
          const body = bodyBase + '\n\n(An .ics file has been downloaded. Please attach it to this email so the recipient can add the event to their calendar.)';
          const mailto = `mailto:${encodeURIComponent(recipient)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
          window.open(mailto, '_blank');
          return;
        }
        // no recipient provided: open default mail client (original behavior)
        const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(bodyBase)}`;
        window.open(mailto, '_blank');
      }catch(e){ console.debug('sendReminderEmail error', e); alert('Could not prepare email.'); }
    }

    function addCustomReminder(){
      const date = prompt('Enter date (YYYY-MM-DD):', `${yearSel.value}-${String(currentMonthIdx+1).padStart(2,'0')}-21`);
      if(!date) return;
      const time = prompt('Enter time (HH:MM):', '10:00');
  const amount = Number(prompt('Amount:', '0')||0);
  const label = prompt('Label:', defaultRemLabel()) || defaultRemLabel();
      const when = new Date(`${date}T${time}:00`);
      if(isNaN(when)) { alert('Invalid date/time'); return; }
      addReminder({ id:'r'+Date.now(), when: when.toISOString(), amount, label, done:false });
    }
    dom('btnAddCustom').addEventListener('click', addCustomReminder);

    // Test helpers (quick in-browser checks)
    function remFirst(){ const a = getRems(); return (a && a.length)? a[0] : null; }
  // test buttons removed
    const overlay = dom('shareOverlay');
    function openShare(){
      // require user to fill recipient manually; do not auto-prefill
      buildShareText(); overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');
      // focus recipient to encourage filling it
      setTimeout(()=> dom('shareRecipient')?.focus(), 120);
    }
    function closeShare(){ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); }
    dom('btnTopShare').addEventListener('click', openShare);
    dom('btnShareClose').addEventListener('click', closeShare);
    dom('btnShareClose2').addEventListener('click', closeShare);

    // AI Analysis handlers
  function openAi(){ dom('aiOverlay').classList.add('show'); dom('aiOverlay').setAttribute('aria-hidden','false'); setTimeout(()=>{ try{ dom('aiText').value = computeAnalysis(); }catch(e){} },120); }
    function closeAi(){ dom('aiOverlay').classList.remove('show'); dom('aiOverlay').setAttribute('aria-hidden','true'); }
    dom('btnAiAnalysis').addEventListener('click', openAi);
    dom('btnAiClose').addEventListener('click', closeAi);
    dom('btnAiClose2').addEventListener('click', closeAi);
    dom('btnRunAi').addEventListener('click', ()=>{ dom('btnRunAi').textContent='Running‚Ä¶'; setTimeout(()=>{ dom('aiText').value = computeAnalysis(); dom('btnRunAi').textContent='Run Analysis'; },120); });
    // AI breakdown toggle: saved per Owner & Year using key 'aiShowBreakdown'
    function aiBreakdownKey(){ return 'aiShowBreakdown'; }
    function getAiBreakdownPref(){ try{ return !!load(aiBreakdownKey(), true); }catch(e){ return true; } }
    function setAiBreakdownPref(v){ try{ save(aiBreakdownKey(), !!v); }catch(e){} }
    const btnToggleBreakdown = dom('btnToggleBreakdown');
    if(btnToggleBreakdown){
      // initialize label
      const show = getAiBreakdownPref();
      btnToggleBreakdown.textContent = show ? 'Hide breakdown' : 'Show breakdown';
      btnToggleBreakdown.addEventListener('click', ()=>{
        const cur = getAiBreakdownPref();
        setAiBreakdownPref(!cur);
        btnToggleBreakdown.textContent = !cur ? 'Hide breakdown' : 'Show breakdown';
        // refresh analysis if overlay is open
        if(dom('aiOverlay') && dom('aiOverlay').classList.contains('show')){ dom('aiText').value = computeAnalysis(); }
      });
    }
    // Scenario helpers
    function applyIfDepositToCopy(ifAmt){
      // returns a new months array with the provided deposit added to the current month inflow
      const months = getMonthData().map(m=> ({...m}));
      const idx = currentMonthIdx;
      if(!months[idx]) months[idx] = { day:'', target:0, note:'', outflow:0 };
      months[idx].outflow = Number(months[idx].outflow||0) + Number(ifAmt||0);
      return months;
    }

    function computeScenarioProjection(kind, ifDeposit){
      // kind: 'Conservative' (lower avg), 'Base' (current avg), 'Optimistic' (higher avg)
      const months = getMonthData();
      const vals = months.map(m=> Number(m.outflow||0));
      const targets = months.map(m=> Number(m.target||0));
      const current = currentMonthIdx;
      const monthsPassed = current;
      const totalTarget = targets.reduce((a,b)=>a+b,0);
      // compute avg based on kind
      const inflowBeforeCurrent = vals.slice(0, monthsPassed).reduce((a,b)=>a+b,0);
      const baseAvg = monthsPassed>0 ? inflowBeforeCurrent / monthsPassed : 0;
  // read multipliers from inputs if present
  const mulC = Number((dom('mulConservative')||{value:0.8}).value) || 0.8;
  const mulB = Number((dom('mulBase')||{value:1}).value) || 1;
  const mulO = Number((dom('mulOptimistic')||{value:1.25}).value) || 1.25;
  let factor = 1;
  if(kind==='Conservative') factor = mulC;
  else if(kind==='Base') factor = mulB;
  else if(kind==='Optimistic') factor = mulO;
  else if(kind==='No Change') factor = 1;
  const projAvg = Math.round(baseAvg * factor);
  // Day-aware months remaining (use ceil to get whole months for discrete projections)
  const now = new Date();
  const startOfYear = new Date(Number(yearSel.value||now.getFullYear()), 0, 1, 0,0,0);
  const endOfYear = new Date(Number(yearSel.value||now.getFullYear()), 11, 31, 23,59,59);
  const msInDay = 1000*60*60*24;
  const days_left = Math.max(0, Math.ceil((endOfYear - now)/msInDay));
  const months_left = Math.max(0.01, days_left / 30.44);
  const monthsToYearEnd = Math.max(1, Math.ceil(months_left));
      const inflowYTD = vals.slice(0, current+1).reduce((a,b)=>a+b,0);
      const expectedRemaining = Math.round(projAvg * monthsToYearEnd);
      let expectedYearEnd = inflowYTD + expectedRemaining;
      // apply ifDeposit to current month if provided
      if(ifDeposit && Number(ifDeposit)>0){ expectedYearEnd += Number(ifDeposit); }
      const shortfall = Math.max(0, totalTarget - expectedYearEnd);
      return { kind, projAvg, monthsToYearEnd, inflowYTD, expectedRemaining, expectedYearEnd, shortfall };
    }

  // Wire scenario UI
    dom('btnApplyIf')?.addEventListener('click', ()=>{
      const ifAmt = Number((dom('aiIfDeposit')||{value:0}).value||0);
      const sel = (dom('aiScenarioSelect')||{value:'All'}).value;
      const kinds = sel==='All' ? ['Conservative','Base','Optimistic','No Change'] : [sel];
      const lines = [];
      lines.push(`Scenario results ‚Äî ${new Date().toLocaleString()}`);
      lines.push('');
      for(const k of kinds){
        const r = computeScenarioProjection(k, ifAmt);
        lines.push(`--- ${r.kind} ---`);
        lines.push(`Projected avg monthly (used): AED ${fmtAcc(r.projAvg)}`);
        lines.push(`Expected year-end inflow: AED ${fmtAcc(r.expectedYearEnd)}`);
        lines.push(`Forecast shortfall: AED ${fmtAcc(r.shortfall)}`);
        lines.push('');
      }
      // append the standard analysis for context
      lines.push('Full analysis:');
      lines.push('');
      lines.push(computeAnalysis());
      // save last-used values for convenience
      save('lastScenario', { sel, ifAmt, mulC: Number((dom('mulConservative')||{value:0.8}).value), mulB: Number((dom('mulBase')||{value:1}).value), mulO: Number((dom('mulOptimistic')||{value:1.25}).value) });
  dom('aiText').value = lines.join('\n');
  renderScenarioTable();
  try{ if(typeof updateUI === 'function') updateUI(); }catch(e){}
    });

    // Save button for multipliers
    dom('btnSaveScenario')?.addEventListener('click', ()=>{
      const mulC = Number((dom('mulConservative')||{value:0.8}).value) || 0.8;
      const mulB = Number((dom('mulBase')||{value:1}).value) || 1;
      const mulO = Number((dom('mulOptimistic')||{value:1.25}).value) || 1.25;
  save('scenarioMultipliers', { mulC, mulB, mulO });
  alert('Scenario multipliers saved for this Owner & Year');
  renderScenarioTable();
  try{ if(typeof updateUI === 'function') updateUI(); }catch(e){}
    });

  // Rebuild table button removed ‚Äî handler cleaned up

    function renderScenarioTable(){
      const muls = load('scenarioMultipliers', { mulC:0.8, mulB:1, mulO:1.25 });
      // ensure UI reflects loaded values
      if(dom('mulConservative')) dom('mulConservative').value = muls.mulC;
      if(dom('mulBase')) dom('mulBase').value = muls.mulB;
      if(dom('mulOptimistic')) dom('mulOptimistic').value = muls.mulO;
      const ifAmt = Number((dom('aiIfDeposit')||{value:0}).value||0);
      const kinds = ['Conservative','Base','Optimistic','No Change'];
      const rows = [];
      rows.push('Kind          | Avg/mo       | Exp Year-End   | Shortfall    ');
      rows.push('------------------------------------------------------------');
      for(const k of kinds){
        const r = computeScenarioProjection(k, ifAmt);
        rows.push(`${k.padEnd(14)}| ${fmtAcc(r.projAvg).padStart(13)} | ${fmtAcc(r.expectedYearEnd).padStart(15)} | ${fmtAcc(r.shortfall).padStart(13)}`);
      }
      const tbl = dom('aiScenarioTable'); if(tbl) tbl.textContent = rows.join('\n');
    }

    // Load saved multipliers and last scenario on init
    (function(){
      const last = load('lastScenario', null);
      if(last){ try{ if(dom('aiScenarioSelect')) dom('aiScenarioSelect').value = last.sel || 'All'; if(dom('aiIfDeposit')) dom('aiIfDeposit').value = last.ifAmt || 0; }catch(e){} }
      const muls = load('scenarioMultipliers', null);
      if(muls){ if(dom('mulConservative')) dom('mulConservative').value = muls.mulC; if(dom('mulBase')) dom('mulBase').value = muls.mulB; if(dom('mulOptimistic')) dom('mulOptimistic').value = muls.mulO; }
      renderScenarioTable();
    })();

    // AI share handlers (require recipient)
    dom('sWhatsAppAi')?.addEventListener('click', ()=>{
      const rec = (dom('aiShareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before sharing.'); dom('aiShareRecipient')?.focus(); return; }
      // ensure analysis is current
      const text = computeAnalysis().replace(/^/m, '');
      const t = text.replace(/^/m, '');
      const out = t.replace(/^Owner:/m, ''); // keep full but inject Dear line at top
      const final = (`Dear ${rec},\n\n` + text);
      window.open('https://wa.me/?text='+enc(final), '_blank');
    });
    dom('sEmailAi')?.addEventListener('click', ()=>{
      const rec = (dom('aiShareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before sharing.'); dom('aiShareRecipient')?.focus(); return; }
      const text = computeAnalysis();
      const body = (`Dear ${rec},\n\n` + text);
      const subject = `Analysis ‚Äî ${ownerSel.value || ''}`;
      window.location.href = `mailto:?subject=${enc(subject)}&body=${enc(body)}`;
    });
    dom('sCopyAi')?.addEventListener('click', ()=>{
      const rec = (dom('aiShareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before copying.'); dom('aiShareRecipient')?.focus(); return; }
      const text = computeAnalysis();
      const final = (`Dear ${rec},\n\n` + text);
      if(navigator.clipboard){ navigator.clipboard.writeText(final).then(()=> alert('Copied!')); }
      else { prompt('Copy the analysis:', final); }
    });
    dom('sPrintAi')?.addEventListener('click', ()=>{
      const rec = (dom('aiShareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before printing.'); dom('aiShareRecipient')?.focus(); return; }
      const text = computeAnalysis();
      const final = (`Dear ${rec},\n\n` + text);
      const w = window.open('', '_blank', 'width=720,height=900');
      w.document.write(`<pre style="font:14px/1.6 monospace; white-space:pre-wrap; padding:20px">${final.replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]))}</pre>`);
      w.document.close(); w.focus(); setTimeout(()=>{w.print(); w.close();}, 200);
    });

    // Email Settings handlers
    dom('btnEmailSettings').addEventListener('click', openEmailSettings);

    function openEmailSettings(){
      const config = load('emailjsConfig', {serviceId:'', templateId:'', publicKey:'', recipient:''});
      dom('emailServiceId').value = config.serviceId || '';
      dom('emailTemplateId').value = config.templateId || '';
      dom('emailPublicKey').value = config.publicKey || '';
      dom('emailRecipient').value = config.recipient || '';
      dom('emailOverlay').classList.add('show');
      dom('emailOverlay').setAttribute('aria-hidden','false');
    }

    dom('btnEmailClose').addEventListener('click', closeEmailSettings);
    dom('btnEmailClose2').addEventListener('click', closeEmailSettings);

    function closeEmailSettings(){
      dom('emailOverlay').classList.remove('show');
      dom('emailOverlay').setAttribute('aria-hidden','true');
    }

    dom('btnSaveEmailConfig').addEventListener('click', saveEmailConfig);

    function saveEmailConfig(){
      const config = {
        serviceId: dom('emailServiceId').value.trim(),
        templateId: dom('emailTemplateId').value.trim(),
        publicKey: dom('emailPublicKey').value.trim(),
        recipient: dom('emailRecipient').value.trim()
      };
      if(!config.serviceId || !config.templateId || !config.publicKey || !config.recipient){
        alert('All fields are required.');
        return;
      }
      save('emailjsConfig', config);
      if(config.publicKey){
        emailjs.init(config.publicKey);
      }
      alert('Email settings saved.');
      closeEmailSettings();
    }

    dom('btnTestEmail').addEventListener('click', testEmail);

    function testEmail(){
      const config = {
        serviceId: dom('emailServiceId').value.trim(),
        templateId: dom('emailTemplateId').value.trim(),
        publicKey: dom('emailPublicKey').value.trim(),
        recipient: dom('emailRecipient').value.trim()
      };
      if(!config.serviceId || !config.templateId || !config.publicKey || !config.recipient){
        alert('All fields are required for testing.');
        return;
      }
      emailjs.send(config.serviceId, config.templateId, {
        to_email: config.recipient,
        subject: 'Test Email from ENBD Tracker',
        message: 'This is a test email from the ENBD Performance Tracker.'
      }).then(() => {
        alert('Test email sent successfully!');
      }).catch((error) => {
        alert('Failed to send test email: ' + error.text);
      });
    }

    // Duplicate Owner handlers
    dom('btnDuplicateOwner').addEventListener('click', openDuplicateOwner);

    function openDuplicateOwner(){
      dom('duplicateOwnerOverlay').classList.add('show');
      dom('duplicateOwnerOverlay').setAttribute('aria-hidden','false');
    }

    dom('btnDuplicateClose').addEventListener('click', closeDuplicateOwner);
    dom('btnDuplicateClose2').addEventListener('click', closeDuplicateOwner);

    function closeDuplicateOwner(){
      dom('duplicateOwnerOverlay').classList.remove('show');
      dom('duplicateOwnerOverlay').setAttribute('aria-hidden','true');
    }

    dom('btnDuplicateData').addEventListener('click', duplicateOwnerData);

    function duplicateOwnerData(){
      const sourceOwner = dom('sourceOwner').value.trim();
      const sourceYear = dom('sourceYear').value.trim();
      const targetOwner = dom('targetOwner').value.trim();
      const targetYear = dom('targetYear').value.trim();

      if(!sourceOwner || !sourceYear || !targetOwner || !targetYear){
        alert('All fields are required.');
        return;
      }

      if(sourceOwner === targetOwner && sourceYear === targetYear){
        alert('Source and target cannot be the same.');
        return;
      }

      // Confirm duplication
      if(!confirm(`Duplicate all data from ${sourceOwner} ${sourceYear} to ${targetOwner} ${targetYear}? This will overwrite any existing data for the target.`)){
        return;
      }

      // Keys to duplicate
      const keysToDuplicate = ['monthData', 'reminders', 'openingBalance', 'scenarioMultipliers', 'lastScenario', 'notes'];

      let duplicatedCount = 0;
      for(const key of keysToDuplicate){
        const sourceKey = `enbd:${sourceOwner}:${sourceYear}:${key}`;
        const targetKey = `enbd:${targetOwner}:${targetYear}:${key}`;
        const value = localStorage.getItem(sourceKey);
        if(value !== null){
          localStorage.setItem(targetKey, value);
          duplicatedCount++;
        }
      }

      alert(`Duplicated ${duplicatedCount} data items from ${sourceOwner} ${sourceYear} to ${targetOwner} ${targetYear}.`);
      closeDuplicateOwner();
    }

    function computeAnalysis(){
      // Time-aware heuristic analysis: day-level months_left, schedule index, volatility-aware burden and 0-100 composite risk
      try{
        const months = getMonthData();
        const owner = ownerSel.value || 'Owner';
        const opening = Number(dom('openingBalance').value||0);
        const vals = months.map(m=> Number(m.outflow||0));
        const targets = months.map(m=> Number(m.target||0));
        const current = currentMonthIdx;
  const monthsPassed = current; // months before current (exclude current month)
  const inflowYTD = vals.slice(0, monthsPassed).reduce((a,b)=>a+b,0);
        const totalTarget = Number(load('yearTarget', 0)) || targets.reduce((a,b)=>a+b,0);

        // Day-aware time factors (reuse recompute's approach)
        const now = new Date();
        const startOfYear = new Date(Number(yearSel.value||now.getFullYear()), 0, 1, 0,0,0);
        const endOfYear = new Date(Number(yearSel.value||now.getFullYear()), 11, 31, 23,59,59);
        const msInDay = 1000*60*60*24;
        const days_elapsed = Math.max(0, Math.floor((now - startOfYear)/msInDay));
        const days_left = Math.max(0, Math.ceil((endOfYear - now)/msInDay));
        const months_left = Math.max(0.01, days_left / 30.44);
        const schedule_index = (days_elapsed + days_left) > 0 ? (days_elapsed / (days_elapsed + days_left)) : 0;

  // average inflow excluding current month (used for natural inflow estimate)
  const avgInflow = monthsPassed>0 ? (vals.slice(0, monthsPassed).reduce((a,b)=>a+b,0)/monthsPassed) : 0;

  // derive integer months-to-year-end (inclusive) to match main KPI projection logic
  const monthsToYearEndIncludingCurrent = Math.max(1, Math.ceil(months_left));
  const remainingWholeMonthsAfterCurrent = monthsToYearEndIncludingCurrent;

  // expected remaining inflow for display: use fractional months_left (rate-based estimate)
  const expectedRemaining = Math.round(avgInflow * months_left);
  // expected year-end (forecast) uses integer remaining months (includes current month not yet registered)
  const expectedYearEnd = inflowYTD + Math.round(avgInflow * remainingWholeMonthsAfterCurrent);
  const shortfall = totalTarget > 0 ? Math.max(0, totalTarget - expectedYearEnd) : 0;

  // Mo needed (use integer remaining months-to-year-end including current month for deposit distribution)
  const remaining = totalTarget > 0 ? Math.max(0, totalTarget - inflowYTD) : 0;
  const moNeeded = totalTarget > 0 ? Math.ceil(remaining / monthsToYearEndIncludingCurrent) : 0;

        // volatility: compute std dev of past months (exclude nulls)
        const past = vals.slice(0, monthsPassed).filter(v=> v!=null);
        const mean = past.length ? past.reduce((a,b)=>a+b,0)/past.length : 0;
        const variance = past.length ? past.reduce((a,b)=> a + Math.pow(b-mean,2), 0)/past.length : 0;
        const stddev = Math.sqrt(variance);

        // recent trend (last 3 months average)
        const recent = vals.slice(Math.max(0,current-2), current+1);
        const recentAvg = recent.length ? recent.reduce((a,b)=>a+b,0)/recent.length : 0;

        // Volatility-adjusted burden: increase required by volatility ratio
        const volRatio = mean>0 ? stddev/Math.abs(mean) : (stddev>0?1:0);
        const volatilityAdjustedMo = Math.ceil(moNeeded * (1 + Math.min(volRatio, 1)));

        // Composite 0-100 risk score with weights: Schedule 45%, Burden 35%, Volatility 20%
        // scheduleFactor: how late we are (1.0 = at deadline, 0 = at start)
        const scheduleFactor = schedule_index; // 0..1
        // burdenFactor: shortfall as fraction of remaining requirement (when remaining>0)
        const burdenFactor = remaining > 0 ? Math.min(1, shortfall / Math.max(1, remaining)) : 0;
        // volFactor: normalized vol ratio (cap at 1)
        const volFactorNorm = Math.min(1, volRatio);
        const composite = Math.round((scheduleFactor * 0.45 + burdenFactor * 0.35 + volFactorNorm * 0.20) * 100);
        const compScore = Math.max(0, Math.min(100, composite));

        function compBandLabel(s){ if(s < 30) return 'Comfort'; if(s < 60) return 'Warning'; if(s < 80) return 'High'; return 'Extreme'; }

        // Monte Carlo using integer months (rounded up) but explain we used fractional timing
        const mcRemainingMonths = Math.max(1, Math.ceil(months_left));
  const historicalVariances = months.slice(0, monthsPassed).map(m => parseNum(m.variance || 0)).filter(v => !isNaN(v));
        const predictive = monteCarloSimulation(historicalVariances, mcRemainingMonths, inflowYTD);

        const low = Math.round(predictive.ci80[0]);
        const likely = Math.round(predictive.mean);
        const high = Math.round(predictive.ci80[1]);

        const lines = [];
        lines.push(`Owner: ${owner}`);
        lines.push(`Report generated: ${new Date().toLocaleString()}`);
        lines.push('');
        lines.push('Executive summary:');
        if(totalTarget > 0){
          if(expectedYearEnd >= totalTarget){
            lines.push('- Based on current inflows and schedule, you are likely to meet the yearly target (subject to variability).');
          } else {
            lines.push('- The forecast shows a shortfall by year-end unless inflows accelerate or deposits are made.');
          }
        } else {
          lines.push('- No Total Target set: analysis is limited until a target is provided.');
        }
        lines.push('');

        lines.push('Key metrics & forecast:');
  // show literal 'Nil' if the opening balance input uses that display
  const openingDisplay = (dom('openingBalance') && String(dom('openingBalance').value).trim().toLowerCase() === 'nil') ? 'Nil' : fmtAcc(opening);
  lines.push(`- Opening balance: ${openingDisplay} (use as buffer against volatility)`);
        lines.push(`- YTD inflow: ${fmtAcc(inflowYTD)}`);
        lines.push(`- Total target (year): ${ totalTarget>0 ? fmtAcc(totalTarget) : 'Not set'}`);
        lines.push(`- Expected remaining inflow (based on avg): ${fmtAcc(expectedRemaining)} (‚âà ${months_left.toFixed(2)} months left)`);
        lines.push(`- Expected year-end inflow: ${fmtAcc(expectedYearEnd)}`);
        lines.push(`- Forecast ranges: Low: ${fmtAcc(low)}, Likely: ${fmtAcc(likely)}, High: ${fmtAcc(high)} (80% CI)`);
        lines.push(`- Forecast shortfall: ${ totalTarget>0 ? fmtAcc(shortfall) : 'N/A' }`);
        lines.push(`- Mo. Needed (to year-end, rough): ${ totalTarget>0 ? fmtAcc(moNeeded) : 'N/A' }`);
        lines.push(`- Volatility (std dev): ${fmtAcc(Math.round(stddev))} ‚Äî volatility-adjusted monthly need: ${ totalTarget>0 ? fmtAcc(volatilityAdjustedMo) : 'N/A' }`);
        lines.push('');

        lines.push('Time Factor:');
        lines.push(`- Days elapsed: ${days_elapsed}, Days left: ${days_left} ‚Üí Months left (frac): ${months_left.toFixed(2)}`);
        lines.push(`- Schedule index: ${(schedule_index*100).toFixed(1)}% (higher = less time remaining)`);
        lines.push('');

        lines.push('Risk assessment (0 = no risk, 100 = extreme):');
  // add a compact emoji to illustrate band: ‚úÖ Comfort, ‚è∞ Warning, ‚ö†Ô∏è High, üö® Extreme
  const bandEmoji = compScore < 30 ? '‚úÖ' : compScore < 60 ? '‚è∞' : compScore < 80 ? '‚ö†Ô∏è' : 'üö®';
  lines.push(`- Composite score: ${compScore} / 100 ‚Äî ${compBandLabel(compScore)} ${bandEmoji}`);
        lines.push('');

        lines.push('Guidance & recommendations:');
        if(totalTarget === 0){
          lines.push('- Set a Total Target to receive meaningful Mo. Needed and risk guidance.');
        } else if(compScore < 30){
          lines.push('- Comfort: keep monitoring; no immediate large deposits required.');
        } else if(compScore < 60){
          lines.push('- Warning: arrange partial deposits this month and confirm expected receipts.');
        } else if(compScore < 80){
          lines.push('- High: initiate urgent collections, schedule deposits, consider short-term funding.');
        } else {
          lines.push('- Extreme: immediate deposits and contingency funding recommended; convene operations to avoid miss.');
        }

        lines.push('');
        lines.push('Actionable next steps:');
        if(totalTarget > 0){
          const suggestedDeposit = Math.max(0, Math.round(moNeeded - Math.round(avgInflow)));
          lines.push(`1) Share the suggested deposit: AED ${fmtAcc(suggestedDeposit)} this month.`);
          if(shortfall>0) lines.push(`2) Consider scheduling at least AED ${fmtAcc(Math.ceil(shortfall / Math.max(1, Math.ceil(months_left))))} per remaining month.`);
        } else {
          lines.push('1) Define a Total Target for the year so the tracker can compute Mo. Needed and risk.');
        }
        lines.push('3) Confirm expected receipts for upcoming months and update the tracker.');
        lines.push('4) Use Opening Balance as a short-term buffer against volatility when necessary.');

        // Data completeness note: follow the user's exact requested phrasing (dynamic months list)
  const unregisteredMonths = [];
  for(let i=0; i<monthsPassed; i++){ if(vals[i] === 0) unregisteredMonths.push(monthNames[i]); }
        const dataNote = unregisteredMonths.length > 0 ?
          `Data completeness note: The following past months have no registered bank inflows: ${unregisteredMonths.join(', ')}. Bank inflow entries are typically entered at the beginning of the following month upon receipt of the complete bank statement. Current month inflows are not included as past data.` :
          'Data completeness note: All past months have registered bank inflows. Bank inflow entries are typically entered at the beginning of the following month upon receipt of the complete bank statement. Current month inflows are not included as past data.';
        lines.push('');
        lines.push(dataNote);

        return lines.join('\n');
      }catch(e){ return 'Analysis failed: '+String(e); }
    }

      // Reusable helper: returns composite risk score, label and classname for UI
      function getCompositeScore(){
        try{
          const months = getMonthData();
          const vals = months.map(m=> Number(m.outflow||0));
          const targets = months.map(m=> Number(m.target||0));
          const current = currentMonthIdx;
          const monthsPassed = current;
          const inflowYTD = vals.slice(0, current+1).reduce((a,b)=>a+b,0);
          const totalTarget = Number(load('yearTarget', 0)) || targets.reduce((a,b)=>a+b,0);

          const now = new Date();
          const startOfYear = new Date(Number(yearSel.value||now.getFullYear()), 0, 1, 0,0,0);
          const endOfYear = new Date(Number(yearSel.value||now.getFullYear()), 11, 31, 23,59,59);
          const msInDay = 1000*60*60*24;
          const days_elapsed = Math.max(0, Math.floor((now - startOfYear)/msInDay));
          const days_left = Math.max(0, Math.ceil((endOfYear - now)/msInDay));
          const months_left = Math.max(0.01, days_left / 30.44);
          const schedule_index = (days_elapsed + days_left) > 0 ? (days_elapsed / (days_elapsed + days_left)) : 0;

          const monthsPassedForAvg = monthsPassed > 0 ? monthsPassed : 0;
          const avgInflow = monthsPassedForAvg>0 ? (vals.slice(0, monthsPassedForAvg).reduce((a,b)=>a+b,0)/monthsPassedForAvg) : 0;
          const expectedRemaining = Math.round(avgInflow * months_left);
          const expectedYearEnd = inflowYTD + expectedRemaining;
          const remaining = totalTarget > 0 ? Math.max(0, totalTarget - inflowYTD) : 0;
          const shortfall = totalTarget > 0 ? Math.max(0, totalTarget - expectedYearEnd) : 0;

          // volatility
          const past = vals.slice(0, monthsPassed).filter(v=> v!=null);
          const mean = past.length ? past.reduce((a,b)=>a+b,0)/past.length : 0;
          const variance = past.length ? past.reduce((a,b)=> a + Math.pow(b-mean,2), 0)/past.length : 0;
          const stddev = Math.sqrt(variance);
          const volRatio = mean>0 ? stddev/Math.abs(mean) : (stddev>0?1:0);

          const scheduleFactor = schedule_index;
          const burdenFactor = remaining > 0 ? Math.min(1, shortfall / Math.max(1, remaining)) : 0;
          const volFactorNorm = Math.min(1, volRatio);
          const composite = Math.round((scheduleFactor * 0.45 + burdenFactor * 0.35 + volFactorNorm * 0.20) * 100);
          const compScore = Math.max(0, Math.min(100, composite));

          let label = 'Comfort'; let cls = 'comfort';
          if(compScore < 30){ label = 'Comfort'; cls = 'comfort'; }
          else if(compScore < 60){ label = 'Warning'; cls = 'warning'; }
          else if(compScore < 80){ label = 'High'; cls = 'high'; }
          else { label = 'Extreme'; cls = 'extreme'; }

          return { score: compScore, label, className: cls };
        }catch(e){ console.debug('getCompositeScore failed', e); return { score: 0, label: 'Unknown', className: 'comfort' }; }
      }

    // Return a short one-line risk summary derived from the analysis risk score
    function shortRiskLine(){
      try{
        const months = getMonthData();
        const vals = months.map(m=> Number(m.outflow||0));
        const targets = months.map(m=> Number(m.target||0));
        const current = currentMonthIdx;
        const monthsPassed = current;
        const inflowYTD = vals.slice(0, current+1).reduce((a,b)=>a+b,0);
        const totalTarget = Number(load('yearTarget', 0)) || targets.reduce((a,b)=>a+b,0);

        // day-aware
        const now = new Date();
        const startOfYear = new Date(Number(yearSel.value||now.getFullYear()), 0, 1, 0,0,0);
        const endOfYear = new Date(Number(yearSel.value||now.getFullYear()), 11, 31, 23,59,59);
        const msInDay = 1000*60*60*24;
        const days_elapsed = Math.max(0, Math.floor((now - startOfYear)/msInDay));
        const days_left = Math.max(0, Math.ceil((endOfYear - now)/msInDay));
        const months_left = Math.max(0.01, days_left / 30.44);
        const schedule_index = (days_elapsed + days_left) > 0 ? (days_elapsed / (days_elapsed + days_left)) : 0;

        const avgInflow = monthsPassed>0 ? (vals.slice(0, monthsPassed).reduce((a,b)=>a+b,0)/monthsPassed) : 0;
        const expectedRemaining = Math.round(avgInflow * months_left);
        const expectedYearEnd = inflowYTD + expectedRemaining;
        const shortfall = totalTarget > 0 ? Math.max(0, totalTarget - expectedYearEnd) : 0;
        const remaining = totalTarget > 0 ? Math.max(0, totalTarget - inflowYTD) : 0;
        const moNeeded = totalTarget > 0 ? Math.ceil(remaining / months_left) : 0;

        const past = vals.slice(0, monthsPassed).filter(v=> v!=null);
        const mean = past.length ? past.reduce((a,b)=>a+b,0)/past.length : 0;
        const variance = past.length ? past.reduce((a,b)=> a + Math.pow(b-mean,2), 0)/past.length : 0;
        const stddev = Math.sqrt(variance);
        const volRatio = mean>0 ? stddev/Math.abs(mean) : (stddev>0?1:0);

        // composite 0-100 (same weights as computeAnalysis)
        const scheduleFactor = schedule_index;
        const burdenFactor = remaining > 0 ? Math.min(1, shortfall / Math.max(1, remaining)) : 0;
        const volFactorNorm = Math.min(1, volRatio);
        const composite = Math.round((scheduleFactor * 0.45 + burdenFactor * 0.35 + volFactorNorm * 0.20) * 100);
        const compScore = Math.max(0, Math.min(100, composite));

        const label = compScore < 30 ? 'Comfort' : compScore < 60 ? 'Warning' : compScore < 80 ? 'High' : 'Extreme';
        return `Risk: ${compScore}/100 ‚Äî ${label}`;
      }catch(e){ return ''; }
    }

    function buildShareText(){
  // Build the exact template the user requested, with AED-formatted numbers
  const owner = ownerSel.value || 'Owner';
  const y = Number(yearSel.value) || new Date().getFullYear();
  const yt = Number(load('yearTarget', 0)) || 0;
  const monthlyTarget = Math.round(yt/12);
  const months = getMonthData();
  const vals = months.map(m=> Number(m.outflow||0));

  // Avg. Mo. Inflow: use months before current month (exclude current month)
  const monthsPassed = currentMonthIdx;
  const inflowBeforeCurrent = vals.slice(0, monthsPassed).reduce((a,b)=>a+b,0);
  const avgInflow = monthsPassed>0 ? Math.round(inflowBeforeCurrent / monthsPassed) : 0;

  // Mo. Needed Inflow To End of Year (evenly distribute remaining target over remaining months incl. current)
  const inflowYTD = vals.slice(0, currentMonthIdx+1).reduce((a,b)=>a+b,0);
  const totalTarget = months.reduce((s,m)=> s + Number(m.target||0), 0);
  // Day-aware months remaining (use ceil to include partial month as full when distributing deposits)
  const now = new Date();
  const startOfYear = new Date(Number(yearSel.value||now.getFullYear()), 0, 1, 0,0,0);
  const endOfYear = new Date(Number(yearSel.value||now.getFullYear()), 11, 31, 23,59,59);
  const msInDay = 1000*60*60*24;
  const days_left = Math.max(0, Math.ceil((endOfYear - now)/msInDay));
  const months_left = Math.max(0.01, days_left / 30.44);
  const monthsToYearEndIncludingCurrent = Math.max(1, Math.ceil(months_left));
  const remainingToTarget = Math.max(0, totalTarget - inflowYTD);
  const moNeeded = monthsToYearEndIncludingCurrent > 0 ? Math.ceil(remainingToTarget / monthsToYearEndIncludingCurrent) : remainingToTarget;

  // Required deposit as requested: MoNeeded ‚àí AvgMoInflow
  const requiredDeposit = Math.max(0, Math.round(moNeeded - avgInflow));

  const monthName = monthNames[currentMonthIdx];

  // Build list of unregistered past months
  const unregisteredMonths = [];
  for(let i=0; i<currentMonthIdx; i++){
    if(vals[i] === 0) unregisteredMonths.push(monthNames[i]);
  }
  const disclaimerText = unregisteredMonths.length > 0 ?
    `Disclaimer: The following past months have no registered bank inflows: ${unregisteredMonths.join(', ')}. Bank inflow entries are typically entered at the beginning of the following month upon receipt of the complete bank statement. Current month is not considered past data.` :
    'Disclaimer: All past months have registered bank inflows. Bank inflow entries are typically entered at the beginning of the following month upon receipt of the complete bank statement. Current month is not considered past data.';

  const lines = [];
  // leave Dear blank for manual entry
  lines.push('Dear ,');
  lines.push('');
  lines.push(`‚Ä¢ Deposit required ‚Äî ${monthName} ${y}`);
  lines.push(`Account Name : ${owner}`);
  lines.push('');
  lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  lines.push('');
  lines.push(`‚Ä¢\u2060  \u2060Required to stay on target: AED ${fmtAcc(moNeeded)}`);
  lines.push(`‚Ä¢\u2060  \u2060Expected natural inflow (rents/cheques ‚Äî approximate): AED ${fmtAcc(avgInflow)}`);
  lines.push(`‚Ä¢\u2060  \u2060Cheque deposit required: AED ${fmtAcc(requiredDeposit)} (= AED ${fmtAcc(moNeeded)} ‚àí AED ${fmtAcc(avgInflow)})`);
  lines.push('');
  if(requiredDeposit > 0){
    lines.push(`‚Ä¢ Action: please arrange depositing AED ${fmtAcc(requiredDeposit)} this month to keep us on target.`);
  } else {
    lines.push(`‚Ä¢ Action: No additional deposit required this month to stay on target.`);
  }
  lines.push('');
  lines.push('‚Ä¢ Note: Expected natural inflow is an approximate estimate based on the ‚Ä¢ Avg. Mo. Inflow (past months\' average).');
  lines.push(`‚Ä¢ ${disclaimerText}`);
  lines.push('');
  lines.push('‚Äî');
  lines.push('Thanks,');
  lines.push('Fuad Al-Taher');
  lines.push('');
  lines.push('Powered by Ayat');
  dom('shareText').value = lines.join('\n');
    }

    // Share handlers
    function enc(s){ return encodeURIComponent(s); }
    dom('sWhatsApp').addEventListener('click', ()=>{
      const rec = (dom('shareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before sharing.'); dom('shareRecipient')?.focus(); return; }
      // inject recipient into the Dear line before sharing
      buildShareText();
      const text = dom('shareText').value.replace(/^Dear\s*,/m, `Dear ${rec},`);
      window.open('https://wa.me/?text='+enc(text), '_blank');
    });
    dom('sEmail').addEventListener('click', ()=>{
      const rec = (dom('shareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before sharing.'); dom('shareRecipient')?.focus(); return; }
      buildShareText();
  const subject = `Deposit required ‚Äî ${monthNames[currentMonthIdx]}`;
      const body = dom('shareText').value.replace(/^Dear\s*,/m, `Dear ${rec},`);
      window.location.href = `mailto:?subject=${enc(subject)}&body=${enc(body)}`;
    });
    dom('sCopy').addEventListener('click', ()=>{
      const rec = (dom('shareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before copying.'); dom('shareRecipient')?.focus(); return; }
      buildShareText();
      const t = dom('shareText').value.replace(/^Dear\s*,/m, `Dear ${rec},`);
      if(navigator.clipboard){ navigator.clipboard.writeText(t).then(()=> alert('Copied!')); }
      else { prompt('Copy the text:', t); }
    });
    dom('sPrint').addEventListener('click', ()=>{
      const rec = (dom('shareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before printing.'); dom('shareRecipient')?.focus(); return; }
      buildShareText();
      const t = dom('shareText').value.replace(/^Dear\s*,/m, `Dear ${rec},`);
      const w = window.open('', '_blank', 'width=720,height=900');
      w.document.write(`<pre style="font:14px/1.6 monospace; white-space:pre-wrap; padding:20px">${t.replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]))}</pre>`);
      w.document.close(); w.focus(); setTimeout(()=>{w.print(); w.close();}, 200);
    });

    // Notes drawer sharing buttons
    dom('noteWhatsApp')?.addEventListener('click', ()=>{
      buildShareText(); const text = dom('shareText').value; window.open('https://wa.me/?text='+enc(text), '_blank');
    });
    dom('noteEmail')?.addEventListener('click', ()=>{
      buildShareText(); const subject = `Deposit required ‚Äî ${monthNames[currentMonthIdx]}`; const body = dom('shareText').value; window.location.href = `mailto:?subject=${enc(subject)}&body=${enc(body)}`;
    });
    dom('noteCopy')?.addEventListener('click', ()=>{ buildShareText(); const t = dom('shareText').value; if(navigator.clipboard) navigator.clipboard.writeText(t).then(()=> alert('Copied!')); else prompt('Copy the note:', t); });
    dom('notePrint')?.addEventListener('click', ()=>{ buildShareText(); const t = dom('shareText').value; const w = window.open('', '_blank', 'width=720,height=900'); w.document.write(`<pre style="font:14px/1.6 monospace; white-space:pre-wrap; padding:20px">${t.replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]))}</pre>`); w.document.close(); w.focus(); setTimeout(()=>{w.print(); w.close();}, 200); });

    // Quick badge update: compute reminders count from storage immediately to avoid initial 0 flicker
    function updateRemBadgeImmediate(){
      try{
        const badge = dom('remBadge');
        if(!badge) return;
        const key = `enbd:${dom('owner').value}:reminders`;
        try{ const raw = localStorage.getItem(key); if(raw){ const p = JSON.parse(raw); if(Array.isArray(p)){ badge.textContent = String(p.length); console.debug('updateRemBadgeImmediate: used', key); try{ setRemDebug(`badge:${key}`, p.length); }catch(e){} return; } } }catch(e){}
        // Legacy
        const legacy = ['reminders','enbd:reminders'];
        for(const k of legacy){ try{ const raw = localStorage.getItem(k); if(raw){ const p = JSON.parse(raw); if(Array.isArray(p)){ badge.textContent = String(p.length); console.debug('updateRemBadgeImmediate: used legacy', k); try{ setRemDebug(`badge:legacy:${k}`, p.length); }catch(e){} return; } } }catch(e){} }
      }catch(e){/* ignore */}
    }

    // --- Hidden Notes (per Owner & Year) ---
    function renderNotes(){
      try{
        const drawer = dom('notesDrawer'); const area = dom('notesArea'); if(!area) return;
        const val = load('notes', '');
        area.value = typeof val === 'string' ? val : (val || '');
      }catch(e){ console.debug('renderNotes failed', e); }
    }
    dom('btnToggleNotes')?.addEventListener('click', ()=>{ try{ const d = dom('notesDrawer'); if(!d) return; d.classList.add('open'); d.setAttribute('aria-hidden','false'); renderNotes(); setTimeout(()=> dom('notesArea')?.focus(), 120); }catch(e){} });
    dom('btnCloseNotes')?.addEventListener('click', ()=>{ try{ const d = dom('notesDrawer'); if(!d) return; d.classList.remove('open'); d.setAttribute('aria-hidden','true'); }catch(e){} });
  // Additional Close button under notes controls (mirrors btnCloseNotes)
  dom('noteCloseBtn')?.addEventListener('click', ()=>{ try{ const d = dom('notesDrawer'); if(!d) return; d.classList.remove('open'); d.setAttribute('aria-hidden','true'); }catch(e){} });
    dom('btnSaveNotes')?.addEventListener('click', ()=>{ try{ if(getPassword() && !isUnlocked){ showPasswordOverlay(); return; } const txt = dom('notesArea')?.value || ''; save('notes', txt); showToast('Notes saved'); }catch(e){} });
    // Auto-save notes on input change
    dom('notesArea')?.addEventListener('input', ()=>{ try{ if(getPassword() && !isUnlocked){ return; } const txt = dom('notesArea')?.value || ''; save('notes', txt); }catch(e){} });
    dom('btnClearNotes')?.addEventListener('click', ()=>{ try{ if(!confirm('Clear notes for this Owner & Year?')) return; dom('notesArea').value = ''; save('notes', ''); showToast('Notes cleared'); }catch(e){} });


    function storageDiagnostics(){
      console.log('=== Storage Diagnostics: monthData keys ===');
      for(let i=0; i<localStorage.length; i++){
        const key = localStorage.key(i);
        if(key && key.endsWith(':monthData')){
          const val = localStorage.getItem(key);
          const len = val ? val.length : 0;
          const preview = val ? val.substring(0, 100) + (val.length > 100 ? '...' : '') : 'null';
          console.log(`Key: ${key}, Length: ${len}, Preview: ${preview}`);
        }
      }
      console.log('=== End Diagnostics ===');
    }

    // === Initialization ===
    function initAll(){
  storageDiagnostics();
  yearDataLabel.textContent = 'Year Data: ' + yearSel.value;
  // Ensure label offset respects owner (default to 0)
  try{ yearDataLabel.style.left = (ownerSel && ownerSel.value === 'MADUR_ENBD') ? '0.5cm' : '0'; }catch(e){}
      try{
        console.debug('initAll: current prefixed monthData:', localStorage.getItem(`${keyPrefix()}:monthData`));
        for(let i=0;i<localStorage.length;i++){ const k = localStorage.key(i); if(k && k.endsWith(':monthData')) console.debug('initAll: found monthData key', k); }
      }catch(e){}
  buildTable();
  recompute();
  try{ drawChart(); }catch(e){}
  renderRems();
  buildShareText();
  updatePasswordFields();
  try{ if(typeof updateUI === 'function') updateUI(); }catch(e){}
    }
    // update badge as early as possible
    updateRemBadgeImmediate();
    initAll();
    // Defensive: re-run renderRems shortly after load in case storage/migration finished slightly later
    setTimeout(()=>{
      try{ renderRems(); }catch(e){}
    }, 250);
    // Update reminders when the page regains focus (covers some browser reload/restore cases)
    window.addEventListener('focus', ()=>{ try{ renderRems(); }catch(e){} });
    // Respond to storage events from other tabs/windows (migrate/update badge when reminders updated elsewhere)
    window.addEventListener('storage', (ev)=>{
      try{
        if(!ev.key) return;
        if(ev.key.startsWith('enbd:') && ev.key.endsWith(':reminders')) renderRems();
      }catch(e){}
    });

    // Password protection
    function getPassword(){ return localStorage.getItem('enbd:password'); }
    function setPassword(p){ if(p) localStorage.setItem('enbd:password', p); else localStorage.removeItem('enbd:password'); }
    function updatePasswordFields(){
      const existing = getPassword();
      const currentInput = dom('currentPassword');
      if(existing){
        currentInput.style.display = 'block';
      } else {
        currentInput.style.display = 'none';
      }
    }
    function checkPasswordOnLoad(){
      if(getPassword()){
        dom('passwordOverlay').classList.add('show');
        dom('passwordOverlay').setAttribute('aria-hidden','false');
      }
    }
    dom('btnSavePassword').addEventListener('click', () => {
      const current = dom('currentPassword').value;
      const newP = dom('newPassword').value.trim();
      const existing = getPassword();
      if(existing && current !== existing){
        alert('Current password is incorrect.');
        return;
      }
      if(!newP){
        alert('Please enter a new password.');
        return;
      }
      setPassword(newP);
      alert('Password updated successfully.');
      // Clear fields
      dom('currentPassword').value = '';
      dom('newPassword').value = '';
      updatePasswordFields();
    });
    dom('btnRemovePassword').addEventListener('click', () => {
      const current = dom('currentPassword').value;
      const existing = getPassword();
      if(existing && current !== existing){
        alert('Current password is incorrect.');
        return;
      }
      setPassword('');
      alert('Password removed.');
      dom('currentPassword').value = '';
      updatePasswordFields();
    });
    dom('passwordForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const p = dom('passwordInput').value;
      if(p === getPassword()){
        isUnlocked = true;
        dom('passwordOverlay').classList.remove('show');
        dom('passwordOverlay').setAttribute('aria-hidden','true');
      } else {
        alert('Incorrect password');
      }
    });
    // Check on load
    // checkPasswordOnLoad(); // Removed to not prompt on refresh

    // Global error handlers to capture uncaught exceptions and unhandled rejections
    window.onerror = function(msg, url, line, col, error) {
      appendRemDebug('global error: ' + msg + ' at ' + url + ':' + line + ':' + col + ' ' + String(error));
    };
    window.onunhandledrejection = function(event) {
      appendRemDebug('unhandled promise rejection: ' + String(event.reason));
    };

    // Global key handlers: close overlays/drawers on Escape
    document.addEventListener('keydown', (ev) => {
      try{
        if(ev.key !== 'Escape') return;
        // Close reminders drawer
        const rem = dom('reminderDrawer'); if(rem && rem.classList.contains('open')) rem.classList.remove('open');
        // Close notes drawer
        const notes = dom('notesDrawer'); if(notes && notes.classList.contains('open')) { notes.classList.remove('open'); notes.setAttribute('aria-hidden','true'); }
        // Close common overlays
        const overlays = ['aiOverlay','scenarioOverlay','shareOverlay','emailOverlay','ownersOverlay','passwordOverlay','duplicateOwnerOverlay'];
        overlays.forEach(id=>{ const o = dom(id); if(o && o.classList.contains('show')) { o.classList.remove('show'); o.setAttribute('aria-hidden','true'); } });
        // Close right icon set if open
        const rightSet = dom('rightIconSet'); if(rightSet && rightSet.classList.contains('open')) rightSet.classList.remove('open');
      }catch(e){ console.debug('global Escape handler failed', e); }
    });

    // === Scenario Planner JS ===
    // Open/close handlers
    dom('btnScenarioClose')?.addEventListener('click', ()=>{ dom('scenarioOverlay').classList.remove('show'); dom('scenarioOverlay').setAttribute('aria-hidden','true'); });
    dom('btnScenarioClose2')?.addEventListener('click', ()=>{ dom('scenarioOverlay').classList.remove('show'); dom('scenarioOverlay').setAttribute('aria-hidden','true'); });
    // add a toolbar button to open planner (re-use existing right icon set)
    (function(){
      const btn = document.createElement('button'); btn.className='btn'; btn.id='btnScenario'; btn.textContent='Scenario Planner'; btn.title='Open Scenario Planner';
      const set = dom('rightIconSet'); if(set){ set.insertBefore(btn, set.firstChild); btn.addEventListener('click', ()=>{ dom('scenarioOverlay').classList.add('show'); dom('scenarioOverlay').setAttribute('aria-hidden','false'); setTimeout(()=> dom('scMonthlyIncrease')?.focus(), 120); }); }
    })();

    // add a print button
    (function(){
      const btn = document.createElement('button'); btn.className='btn'; btn.id='btnPrint'; btn.textContent='Print'; btn.title='Print the page';
      const set = dom('rightIconSet'); if(set){ set.insertBefore(btn, set.firstChild); btn.addEventListener('click', ()=>{
        // Save current data before printing
        const months = getMonthData();
        const tbody = document.querySelector('#monthTable tbody');
        if(tbody){
          const rows = Array.from(tbody.querySelectorAll('tr'));
          rows.forEach((r, idx) => {
            if(months[idx]){
              const dayInp = r.cells[0].querySelector('input');
              if(dayInp) months[idx].day = dayInp.value;
              const targetInp = r.cells[2].querySelector('input');
              if(targetInp) months[idx].target = parseNum(targetInp.value);
              const noteInp = r.cells[3].querySelector('input');
              if(noteInp) months[idx].note = noteInp.value;
              const inflowInp = r.cells[4].querySelector('input');
              if(inflowInp) months[idx].outflow = parseNum(inflowInp.value);
            }
          });
        }
        // Save opening balance
        const obInp = dom('openingBalance');
        if(obInp) save('openingBalance', Number(obInp.value.replace(/,/g,'')||0));
        saveMonthData(months);
        recompute();
        // Print with compact styles
        window.print();
      }); }
    })();

    // add a Save as PDF button (uses html2canvas + jsPDF). Avoid adding if already exists.
    (function(){
      if(dom('btnSavePDF')) return; // already present
      const btn = document.createElement('button'); btn.className='btn'; btn.id='btnSavePDF'; btn.textContent='Save PDF'; btn.title='Save page as PDF';
      const set = dom('rightIconSet');
      if(!set) return;
      set.insertBefore(btn, set.firstChild);
      btn.addEventListener('click', async () => {
        try{
          // Save current form data to storage before capturing
          const months = getMonthData();
          const tbody = document.querySelector('#monthTable tbody');
          if(tbody){
            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.forEach((r, idx) => {
              if(months[idx]){
                const dayInp = r.cells[0].querySelector('input'); if(dayInp) months[idx].day = dayInp.value;
                const targetInp = r.cells[2].querySelector('input'); if(targetInp) months[idx].target = parseNum(targetInp.value);
                const noteInp = r.cells[3].querySelector('input'); if(noteInp) months[idx].note = noteInp.value;
                const inflowInp = r.cells[4].querySelector('input'); if(inflowInp) months[idx].outflow = parseNum(inflowInp.value);
              }
            });
          }
          const obInp = dom('openingBalance'); if(obInp) save('openingBalance', Number(obInp.value.replace(/,/g,'')||0));
          saveMonthData(months);
          recompute();
          // call saveAsPDF helper
          if(typeof saveAsPDF === 'function') await saveAsPDF();
          else alert('PDF export not available: missing saveAsPDF function');
        }catch(err){ console.error('Save PDF failed', err); alert('Save as PDF failed: ' + String(err)); }
      });
    })();

    function runScenario(){
      try{
        const monthsAhead = Number(dom('scMonthsAhead').value||4);
        const monthlyInc = Number(dom('scMonthlyIncrease').value||0);
        const oneOff = Number(dom('scOneOff').value||0);
        const newTargetRaw = Number(dom('scNewTarget').value||0) || 0;
        const growthPct = Number(dom('scGrowthRate').value||0)/100;
        const sims = Math.max(100, Number(dom('scSims').value||1000));
        const months = getMonthData();
        const vals = months.map(m=> Number(m.outflow||0));
        const targets = months.map(m=> Number(m.target||0));
        const current = currentMonthIdx;
        const monthsPassed = current;
        const inflowYTD = vals.slice(0, current+1).reduce((a,b)=>a+b,0);
        const annualTarget = Number(load('yearTarget', 0)) || targets.reduce((a,b)=>a+b,0);
        const totalTarget = newTargetRaw || annualTarget;
        const monthlyTarget = totalTarget / 12;

        // base avg (exclude current month)
        const baseAvg = monthsPassed>0 ? (vals.slice(0, monthsPassed).reduce((a,b)=>a+b,0)/monthsPassed) : 0;

        // Projected with changes deterministically
        // simulate months ahead applying monthlyInc, growth, and oneOff at first month
        let projAvg = baseAvg; // used for summary
        let projectedRemaining = 0;
        let simulatedYTD = inflowYTD;
        let monthlyData = [];
        for(let m=0;m<monthsAhead;m++){
          // month offset 0..monthsAhead-1
          const growthFactor = Math.pow(1 + growthPct, m);
          const increment = monthlyInc * growthFactor;
          const monthInflow = Math.round(projAvg + increment + (m===0?oneOff:0));
          projectedRemaining += monthInflow;
          monthlyData.push(monthInflow);
        }
  // Use day-aware months remaining to year-end (rounded up) for scenario calculations
  const now = new Date();
  const startOfYear = new Date(Number(yearSel.value||now.getFullYear()), 0, 1, 0,0,0);
  const endOfYear = new Date(Number(yearSel.value||now.getFullYear()), 11, 31, 23,59,59);
  const msInDay = 1000*60*60*24;
  const days_left = Math.max(0, Math.ceil((endOfYear - now)/msInDay));
  const months_left = Math.max(0.01, days_left / 30.44);
  const monthsToYearEnd = Math.max(1, Math.ceil(months_left));
        const expectedYearEnd = inflowYTD + projectedRemaining + Math.round(projAvg * Math.max(0, monthsToYearEnd - monthsAhead));
        const shortfall = Math.max(0, totalTarget - expectedYearEnd);

        // --- Compact scenario summary table (Conservative / Base / Optimistic / No Change) ---
        try{
          const variants = [
            { name: 'Conservative', scale: 0.8 },
            { name: 'Base', scale: 1.0 },
            { name: 'Optimistic', scale: 1.25 },
            { name: 'No Change', scale: 0.0 }
          ];

          function expectedForScale(scale){
            // Build month-by-month projection for the full remaining monthsToYearEnd
            const projected = [];
            for(let m=0; m<monthsToYearEnd; m++){
              if(m < monthsAhead){
                const growthFactor = Math.pow(1 + growthPct, m);
                const inc = Math.round((projAvg) + (monthlyInc * scale) * growthFactor + (m===0 ? Math.round(oneOff * scale) : 0));
                projected.push(inc);
              } else {
                // months after the deterministic 'monthsAhead' period use projAvg (natural inflow)
                projected.push(Math.round(projAvg));
              }
            }
            const sumProj = projected.reduce((a,b)=>a+b,0);
            return inflowYTD + sumProj;
          }

          const tableRows = variants.map(v=>{
            const exp = expectedForScale(v.scale);
            const avgmo = Math.round((exp - inflowYTD) / Math.max(1, monthsToYearEnd));
            const short = Math.max(0, totalTarget - exp);
            return { name: v.name, avg: avgmo, exp, short };
          });

          // build aligned ASCII table using monospace-friendly spacing
          const col1 = 14, col2 = 12, col3 = 16, col4 = 14;
          const pad = (s, w, right=false) => {
            const str = String(s);
            if(right) return str.padStart(w, ' ');
            return str.padEnd(w, ' ');
          };
          const tbl = [];
          tbl.push(pad('Kind', col1) + '|' + pad('Avg/mo', col2, true) + ' | ' + pad('Exp Year-End', col3, true) + ' | ' + pad('Shortfall', col4, true));
          tbl.push('-'.repeat(col1) + '+' + '-'.repeat(col2+2) + '+' + '-'.repeat(col3+2) + '+' + '-'.repeat(col4+1));
          tableRows.forEach(r=>{
            tbl.push(pad(r.name, col1) + '|' + pad(fmtAcc(r.avg), col2, true) + ' | ' + pad(fmtAcc(r.exp), col3, true) + ' | ' + pad(fmtAcc(r.short), col4, true));
          });

          // expose the table early in the scenario output
          out.unshift(tbl.join('\n'));
          out.unshift('Scenario summary:');
          out.unshift('');
        }catch(e){ console.debug('scenario table build failed', e); }

        // Monte Carlo: use historical variances to estimate probability of meeting target
        const histVars = months.slice(0, monthsPassed).map(m=> parseNum(m.variance||0)).filter(v=>!isNaN(v));
        let meetCount = 0;
        if(histVars.length>0){
          // simulate using mean/stddev of historical variances applied to remaining months (including monthsAhead changes added deterministically)
          const mean = histVars.reduce((a,b)=>a+b,0)/histVars.length;
          const variance = histVars.reduce((a,b)=>a+Math.pow(b-mean,2),0)/histVars.length;
          const stdDev = Math.sqrt(variance);
          for(let sim=0; sim<sims; sim++){
            let bal = inflowYTD;
            for(let m=0;m<monthsToYearEnd;m++){
              let add = mean + stdDev * (Math.sqrt(-2*Math.log(Math.random()))*Math.cos(2*Math.PI*Math.random()));
              // in first monthsAhead months, add deterministic changes
              if(m < monthsAhead){ const growthFactor = Math.pow(1 + growthPct, m); add += monthlyInc * growthFactor; if(m===0) add += oneOff; }
              bal += add;
            }
            if(bal >= totalTarget) meetCount++;
          }
        }
        const meetProb = histVars.length>0 ? Math.round(1000 * meetCount / sims)/10 : 'insufficient history';

        // Build action options
        const actions = [];
        // Flat
        const flatPerMonth = monthsAhead>0 ? Math.ceil(shortfall / monthsAhead) : shortfall;
        actions.push({ label: `Flat: +${fmtAcc(flatPerMonth)} AED / month for ${monthsAhead} month(s) (${Math.round((flatPerMonth/baseAvg||1)*100)}% ‚Üë)` , value: flatPerMonth });
        // One-off
        actions.push({ label: `One-off: ${fmtAcc(shortfall)} AED as a single deposit (year-end).`, value: shortfall });
        // Split 50/50
        actions.push({ label: `Split 50/50: +${fmtAcc(Math.ceil(flatPerMonth/2))} AED / month + one-off ${fmtAcc(Math.ceil(shortfall/2))} AED.`, value: null });
        // Laddered (step)
        const step = Math.ceil(flatPerMonth / monthsAhead);
        const ladder = Array.from({length:monthsAhead}, (_,i)=> fmtAcc(step*(i+1)) ).join(', ');
        actions.push({ label: `Laddered: ${ladder} (step = ${fmtAcc(step)})`, value: null });
        // Front-loaded (half now then rest evenly)
        const frontOneOff = Math.ceil(shortfall * 0.4);
        const frontMonthly = monthsAhead>1 ? Math.ceil((shortfall - frontOneOff)/(monthsAhead-1)) : Math.ceil(shortfall);
        actions.push({ label: `Front-loaded: one-off ${fmtAcc(frontOneOff)} next month + ${fmtAcc(frontMonthly)} AED / month for ${Math.max(0, monthsAhead-1)} month(s).`, value: null });
        // Back-loaded
        const backOneOff = frontOneOff;
        const backMonthly = frontMonthly;
        actions.push({ label: `Back-loaded: ${fmtAcc(backMonthly)} AED / month for ${Math.max(0, monthsAhead-1)} month(s) + ${fmtAcc(backOneOff)} AED final month.`, value: null });
        // Skip next month (start one month later)
        const skipMonthly = monthsAhead>1 ? Math.ceil(shortfall/(monthsAhead-1)) : shortfall;
        actions.push({ label: `Skip next month: +${fmtAcc(skipMonthly)} AED / month for ${Math.max(0, monthsAhead-1)} month(s) starting the month after next.`, value: null });
        // Single push next month
        actions.push({ label: `Single push: Add ${fmtAcc(shortfall)} AED next month only.`, value: shortfall });
        // Bi-monthly / Quarterly
        const bi = Math.ceil(shortfall / Math.ceil(monthsAhead/2));
        actions.push({ label: `Bi-monthly: ${fmtAcc(bi)} AED every 2 months (${Math.ceil(monthsAhead/2)} push(es)).`, value: null });
        const q = Math.ceil(shortfall / Math.ceil(monthsAhead/3));
        actions.push({ label: `Quarterly: ${fmtAcc(q)} AED every 3 months (${Math.ceil(monthsAhead/3)} push(es)).`, value: null });
        // Efficiency / Safety
        const eff15 = Math.round(baseAvg * 0.15);
        const effCover = Math.min(shortfall, eff15 * monthsAhead);
        actions.push({ label: `Efficiency: +15% efficiency (~${fmtAcc(eff15)} AED/month) covers ${fmtAcc(effCover)}; remaining ${fmtAcc(shortfall - effCover)} AED.`, value: null });
        const safeBuf = Math.ceil(shortfall * 1.1);
        actions.push({ label: `Safety: +10% buffer ‚Üí ${fmtAcc(safeBuf)} AED total ‚áí ${fmtAcc(Math.ceil(safeBuf/monthsAhead))} AED / month.`, value: null });
        // Hybrid
        const hybridOneOff = Math.ceil(shortfall * 0.6);
        const hybridMonthly = Math.ceil((shortfall - hybridOneOff)/Math.max(1, monthsAhead-1));
        actions.push({ label: `Hybrid: ${fmtAcc(hybridOneOff)} AED next month + ${fmtAcc(hybridMonthly)} AED / month for ${Math.max(0, monthsAhead-1)} month(s).`, value: null });

  // Build output text
        const out = [];
        out.push('üéØ Scenario Planner ‚Äî Summary');
        out.push('');
        out.push('Current Trend');
        out.push(`‚Ä¢ Avg monthly (past months): AED ${fmtAcc(Math.round(baseAvg))}`);
        out.push(`‚Ä¢ YTD inflow: AED ${fmtAcc(inflowYTD)} (${monthsPassed} months)`);
        out.push(`‚Ä¢ Projected year-end (with changes applied): AED ${fmtAcc(expectedYearEnd)}`);
        out.push(`‚Ä¢ AED Shortfall: ${fmtAcc(shortfall)}`);
        out.push('');
        out.push('Try a Change');
        out.push(`‚Ä¢ Monthly Increase (AED): ${fmtAcc(monthlyInc)}`);
        out.push(`‚Ä¢ One-off Inflow (AED): ${fmtAcc(oneOff)}`);
        out.push(`‚Ä¢ Growth Rate (%): ${(growthPct*100).toFixed(1)}%`);
        out.push(`‚Ä¢ Months Ahead: ${monthsAhead}`);
        out.push('');
        out.push('üéØ With Your Changes');
        out.push(`‚Ä¢ Average Monthly (used for projection): AED ${fmtAcc(Math.round(projAvg))}`);
        out.push(`‚Ä¢ One-off Addition: ${fmtAcc(oneOff)} AED`);
        out.push(`‚Ä¢ Growth Rate: ${(growthPct*100).toFixed(1)}% per month`);
        out.push(`‚Ä¢ Projected year-end: AED ${fmtAcc(expectedYearEnd)}`);
        out.push(`‚Ä¢ AED Shortfall: ${fmtAcc(shortfall)}`);
        out.push('');
        out.push('Action Options to Reach Target');
        actions.forEach(a=> out.push(`‚Ä¢ ${a.label}`));
        out.push('');
        out.push(`Probability of meeting target (Monte Carlo): ${typeof meetProb === 'number' ? meetProb + '%' : meetProb}`);

        // persist actions for UI population
        window.__scActions = actions;
        populateActionSelect(actions);

        dom('scenarioOutput').textContent = out.join('\n');

        // Create chart
        const canvas = dom('scenarioChart');
        if(canvas && typeof Chart !== 'undefined'){
          if(window.scenarioChartInstance) window.scenarioChartInstance.destroy();
          const labels = [];
          for(let m=0; m<monthsAhead; m++){
            const mi = (currentMonthIdx + m) % 12;
            labels.push(shortMonth[mi]);
          }
          window.scenarioChartInstance = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Projected Monthly Inflow',
                data: monthlyData,
                borderColor: '#7bd99f',
                backgroundColor: 'rgba(123,217,159,0.1)',
                tension: 0.3,
                pointRadius: 4,
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { title: { display: true, text: 'Month' } },
                y: { title: { display: true, text: 'Inflow (AED)' }, ticks: { callback: function(value) { return 'AED ' + fmt(value); } } }
              },
              plugins: { legend: { display: true } }
            }
          });
        }
      }catch(err){ dom('scenarioOutput').textContent = 'Scenario failed: '+String(err); }
    }

    // Wire run/reset/share handlers
    dom('btnRunScenario')?.addEventListener('click', ()=>{ dom('btnRunScenario').textContent='Running‚Ä¶'; setTimeout(()=>{ runScenario(); dom('btnRunScenario').textContent='Run Projection'; }, 60); });
    dom('btnResetScenario')?.addEventListener('click', ()=>{ dom('scMonthlyIncrease').value = 0; dom('scOneOff').value = 0; dom('scNewTarget').value=''; dom('scGrowthRate').value=0; dom('scMonthsAhead').value=4; dom('scSims').value=1000; dom('scenarioOutput').textContent=''; if(window.scenarioChartInstance) window.scenarioChartInstance.destroy(); window.scenarioChartInstance = null; });
    dom('btnScCopy')?.addEventListener('click', ()=>{ const rec = (dom('scShareRecipient')||{value:''}).value.trim(); const text = dom('scenarioOutput').textContent || ''; if(!text) { alert('Run a projection first'); return; } const final = rec ? (`Dear ${rec},\n\n` + text) : text; if(navigator.clipboard) navigator.clipboard.writeText(final).then(()=> alert('Scenario copied to clipboard')); else prompt('Copy scenario text:', final); });
    dom('btnScWhatsApp')?.addEventListener('click', ()=>{ const rec = (dom('scShareRecipient')||{value:''}).value.trim(); const text = dom('scenarioOutput').textContent || ''; if(!text) { alert('Run a projection first'); return; } const final = rec ? (`Dear ${rec},\n\n` + text) : text; window.open('https://wa.me/?text='+enc(final), '_blank'); });
    dom('btnScEmail')?.addEventListener('click', ()=>{ const rec = (dom('scShareRecipient')||{value:''}).value.trim(); const text = dom('scenarioOutput').textContent || ''; if(!text) { alert('Run a projection first'); return; } const subject = `Scenario Projection ‚Äî ${ownerSel.value || ''} ${yearSel.value || ''}`; const body = rec ? (`Dear ${rec},\n\n` + text) : text; window.location.href = `mailto:?subject=${enc(subject)}&body=${enc(body)}`; });
    dom('btnScPrint')?.addEventListener('click', ()=>{ const rec = (dom('scShareRecipient')||{value:''}).value.trim(); const text = dom('scenarioOutput').textContent || ''; if(!text) { alert('Run a projection first'); return; } const final = rec ? (`Dear ${rec},\n\n` + text) : text; const w = window.open('', '_blank', 'width=720,height=900'); w.document.write(`<pre style="font:14px/1.6 monospace; white-space:pre-wrap; padding:20px">${final.replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]))}</pre>`); w.document.close(); w.focus(); setTimeout(()=>{w.print(); w.close();}, 200); });

    // Populate action select dropdown
    function populateActionSelect(actions){
      const sel = dom('scActionSelect'); if(!sel) return;
      sel.innerHTML = '';
      const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='(Select an action to populate schedule)'; sel.appendChild(placeholder);
      actions.forEach((a, idx)=>{
        const opt = document.createElement('option'); opt.value = String(idx); opt.textContent = a.label; sel.appendChild(opt);
      });
    }

    // Build a month-by-month schedule for a selected action
    function buildScheduleForAction(actionIdx){
      const actions = window.__scActions || [];
      const a = actions[Number(actionIdx)];
      if(!a) return [];
      const monthsAhead = Math.max(1, Number(dom('scMonthsAhead').value||4));
      const months = [];
      const start = currentMonthIdx + 1; // start next month for schedule population
      // if action.value contains a numeric monthly amount, use it; otherwise attempt to parse label heuristically
      let monthly = null; let oneOff = 0;
      if(a.value && typeof a.value === 'number') monthly = a.value;
      else {
        // look for patterns like "+{number} AED / month" or "one-off {number}"
        const m1 = a.label.match(/\+?([0-9,]+) AED \/ month/);
        if(m1) monthly = parseNum(m1[1]);
        const m2 = a.label.match(/one-off[^0-9]*([0-9,]+)/i);
        if(m2) oneOff = parseNum(m2[1]);
      }
      // Distribute amounts across monthsAhead
      for(let i=0;i<monthsAhead;i++){
        const mi = (start + i) % 12;
        const name = monthNames[mi];
        let amt = 0;
        if(i===0 && oneOff) amt += oneOff;
        if(monthly !== null) amt += monthly;
        // fallback: if no monthly found but action label mentions a total, try splitting total evenly
        if(monthly === null && a.value === null){
          const totalMatch = a.label.match(/([0-9,]+) AED/);
          if(totalMatch){ const total = parseNum(totalMatch[1]); amt = Math.ceil(total / monthsAhead); }
        }
        months.push({ month: name, amount: amt });
      }
      return months;
    }

    function renderScheduleTable(schedule){
      const tbody = dom('scScheduleTable') && dom('scScheduleTable').querySelector('tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      schedule.forEach(s=>{
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.style.padding='6px'; td1.textContent = s.month;
        const td2 = document.createElement('td'); td2.style.padding='6px'; td2.style.textAlign='right'; td2.textContent = fmtAcc(s.amount);
        tr.appendChild(td1); tr.appendChild(td2); tbody.appendChild(tr);
      });
    }

    dom('btnPopulateSchedule')?.addEventListener('click', ()=>{
      const sel = dom('scActionSelect'); if(!sel) { alert('No actions available. Run projection first.'); return; }
      const idx = sel.value; if(!idx){ alert('Select an action first.'); sel.focus(); return; }
      const sched = buildScheduleForAction(idx);
      renderScheduleTable(sched);
    });

    dom('btnCopySchedule')?.addEventListener('click', ()=>{
      const tbody = dom('scScheduleTable') && dom('scScheduleTable').querySelector('tbody'); if(!tbody) return; const rows = Array.from(tbody.querySelectorAll('tr'));
      if(!rows.length){ alert('No schedule to copy. Populate schedule first.'); return; }
      const lines = rows.map(r=> `${r.cells[0].textContent.trim()}: AED ${r.cells[1].textContent.trim()}`);
      const txt = ['Schedule:', ...lines].join('\n');
      if(navigator.clipboard){ navigator.clipboard.writeText(txt).then(()=> alert('Schedule copied to clipboard')); }
      else { prompt('Copy schedule:', txt); }
    });

  });
</script>


  <!-- Toast notification -->
  <div id="toast" class="toast">Data saved</div>

<!-- Yearly Calendar ‚Äî Remarks (Popup) -->
<div class="overlay" id="yearlyRemarksOverlayLite" aria-hidden="true">
  <div class="pop" role="dialog" aria-modal="true" aria-labelledby="yearlyRemarksTitleLite">
    <header>
      <h3 id="yearlyRemarksTitleLite">Yearly Calendar ‚Äî Remarks</h3>
      <button class="btn" id="btnYearlyRemarksCloseLite">Close</button>
    </header>
    <div class="content">
      <div class="calendar-remarks-lite" id="calendarRemarksGridLite"></div>
    </div>
    <footer>
      <button class="btn" id="btnYearlyRemarksCloseLite2">Close</button>
    </footer>
  </div>
</div>


<script id="fuad-remarks-and-notes-js">
(function(){
  // Notes enhancer
  function enhanceNotes(){
    var tds = document.querySelectorAll('#monthTable td:nth-child(4)');
    tds.forEach(function(td){
      var inp = td.querySelector('input[id^="month-note-"]');
      if(!inp) return;
      if(td.querySelector('textarea.note2')) return;
      inp.classList.add('note-hidden');
      var ta = document.createElement('textarea');
      ta.className = 'note2'; ta.rows = 2;
      ta.placeholder = inp.getAttribute('placeholder') || 'Note';
      ta.value = inp.value || '';
      td.appendChild(ta);
      function sync(type){
        if(inp.value !== ta.value){
          inp.value = ta.value;
          try{ inp.dispatchEvent(new Event(type || 'input', { bubbles:true })); }catch(_){}
        }
      }
      ta.addEventListener('input', function(){ sync('input'); });
      ta.addEventListener('change', function(){ sync('change'); });
      // Auto-expand textarea
      ta.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
      });
      try{
        var mo = new MutationObserver(function(){ if(ta.value !== inp.value){ ta.value = inp.value || ''; } });
        mo.observe(inp, { attributes:true, attributeFilter:['value'] });
      }catch(_){}
    });
  }

  // Yearly Remarks popup
  function safeKeyPrefix(){
    try{ return (typeof keyPrefix === 'function') ? keyPrefix() : 'global'; }
    catch(_){ return 'global'; }
  }
  var MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var STORAGE_KEY = safeKeyPrefix() + ':calendarRemarks';

  function loadRemarks(){
    try{
      var raw = localStorage.getItem(STORAGE_KEY);
      var arr = raw ? JSON.parse(raw) : null;
      if(Array.isArray(arr) && arr.length === 12) return arr;
    }catch(_){}
    return new Array(12).fill('');
  }
  function saveRemarks(arr){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }catch(_){} }
  function debounce(fn, ms){ var t; return function(){ var a=arguments,s=this; clearTimeout(t); t=setTimeout(function(){ fn.apply(s,a); }, ms); }; }

  function renderGridLite(){
    var grid = document.getElementById('calendarRemarksGridLite');
    if(!grid) return;
    grid.innerHTML = '';
    var vals = loadRemarks();
    for(var i=0;i<12;i++){
      var card = document.createElement('div');
      card.className = 'month-card-lite';
      var h = document.createElement('h4'); h.textContent = MONTHS[i];
      var ta = document.createElement('textarea');
      ta.id = 'remarkLite-' + i;
      ta.placeholder = 'Remarks for ' + MONTHS[i];
      ta.value = vals[i] || '';
      // Auto-expand
      ta.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
      });
      card.appendChild(h); card.appendChild(ta); grid.appendChild(card);
    }
    var saveDebounced = debounce(function(){
      var arr = new Array(12).fill('');
      for(var j=0;j<12;j++){ var el = document.getElementById('remarkLite-' + j); arr[j] = el ? el.value : ''; }
      saveRemarks(arr);
    }, 250);
    grid.addEventListener('input', saveDebounced);
    grid.addEventListener('change', saveDebounced);
  }

  function openOverlayLite(){
    STORAGE_KEY = safeKeyPrefix() + ':calendarRemarks';
    renderGridLite();
    var ov = document.getElementById('yearlyRemarksOverlayLite');
    if(ov) ov.setAttribute('aria-hidden','false');
  }
  function closeOverlayLite(){
    var ov = document.getElementById('yearlyRemarksOverlayLite');
    if(ov) ov.setAttribute('aria-hidden','true');
  }

  function wire(){
    // One toolbar button with id=btnYearlyRemarksLite (we'll inject it after Export)
    document.addEventListener('click', function(e){
      var el = e.target;
      while(el && el !== document){
        if(el.id === 'btnYearlyRemarksLite'){ e.preventDefault(); openOverlayLite(); return; }
        if(el.id === 'btnYearlyRemarksCloseLite' || el.id === 'btnYearlyRemarksCloseLite2'){ e.preventDefault(); closeOverlayLite(); return; }
        el = el.parentNode;
      }
      // Backdrop close
      var ov = document.getElementById('yearlyRemarksOverlayLite');
      if(ov && e.target === ov){ closeOverlayLite(); }
    }, true);
    document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeOverlayLite(); });
  }

  // Hide Undo & Storage UI defensively (without touching other logic)
  function purgeUndoStorage(){
    var ids = ['btnUndo','btnStorageDiag','storageDiagOverlay','btnStorageDiagClose','btnStorageDiagClose2'];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if(el && el.parentNode) try{ el.parentNode.removeChild(el); }catch(_){}
    });
    try{
      document.querySelectorAll('.storage-diag,[data-role="storage-diag"],.storage-panel')
        .forEach(function(el){ if(el && el.parentNode) el.parentNode.removeChild(el); });
    }catch(_){}
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      enhanceNotes(); wire(); purgeUndoStorage();
    }, { once:true });
  } else {
    enhanceNotes(); wire(); purgeUndoStorage();
  }

  try{
    var mo = new MutationObserver(function(){ purgeUndoStorage(); });
    mo.observe(document.body, { childList:true, subtree:true });
  }catch(_){}
})();
</script>

</body></html>
